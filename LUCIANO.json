[
{
  "model": "desktop.document2",
  "pk": 177882,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "LUCIANO",
    "description": "",
    "uuid": "638b4b71-396e-44c4-bbc5-e56afe09dddd",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-11-25T18:06:49.013",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 177924,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "LUCIANO: Criar tbls",
    "description": "",
    "uuid": "a2feba70-015c-9665-7fdf-5e1a35278aea",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 177924, \"uuid\": \"a2feba70-015c-9665-7fdf-5e1a35278aea\", \"name\": \"LUCIANO: Criar tbls\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"a2feba70-015c-9665-7fdf-5e1a35278aea\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"668f7e86-f5b8-4697-a67c-92d2577604d4\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Query\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 1322, \"column\": 78}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"usr_sat_cadastro\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =====================================================================\\r\\n-- PROJETO LUCIANO - VERS\\u00c3O 2.0 (LIMIARES PERCENTIS + IND\\u00cdCIOS CORRIGIDOS)\\r\\n-- =====================================================================\\r\\n-- ALTERA\\u00c7\\u00d5ES IMPLEMENTADAS:\\r\\n-- 1. Classifica\\u00e7\\u00e3o de Risco: CR\\u00cdTICO (Top 1%), ALTO (Top 3%), M\\u00c9DIO (Top 50%), BAIXO (Restante)\\r\\n-- 2. Alertas: A\\u00c7\\u00c3O IMEDIATA (crit\\u00e9rio atual), MUITO URGENTE (Top 3%), URGENTE (Top 5%), \\r\\n--             PRIORIDADE ALTA (Top 20%), MONITORAR (Restante)\\r\\n-- 3. Ind\\u00edcios Graves: Ajustado limiar para score >= 100 (antes era > 200)\\r\\n-- =====================================================================\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 1: LUCIANO_BASE (SEM ALTERA\\u00c7\\u00d5ES)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_base;\\r\\n\\r\\nCREATE TABLE teste.luciano_base AS\\r\\nWITH data_referencia AS (\\r\\n    SELECT \\r\\n        CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE) AS data_hoje,\\r\\n        ADD_MONTHS(CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE), -60) AS data_60m_atras\\r\\n),\\r\\nprotocolos_enriquecidos AS (\\r\\n    SELECT \\r\\n        -- Dados do protocolo\\r\\n        p.rpr_protocolo AS protocolo,\\r\\n        p.rpr_rge_ruc AS ie_original,\\r\\n        p.rpr_dt_inicio AS data_inicio_protocolo,\\r\\n        p.rpr_dt_processo AS data_processamento,\\r\\n        p.rpr_parecer AS parecer,\\r\\n        \\r\\n        -- Eventos e Motivos\\r\\n        p.rpr_tge_vevento AS cod_evento,\\r\\n        CASE \\r\\n            WHEN p.rpr_tge_vevento = 1 THEN 'CANCELAMENTO'\\r\\n            WHEN p.rpr_tge_vevento = 3 THEN 'REATIVACAO_EXCLUSAO'\\r\\n            WHEN p.rpr_tge_vevento = 5 THEN 'REATIVACAO_AUTOMATICA'\\r\\n            ELSE 'OUTRO'\\r\\n        END AS tipo_evento,\\r\\n        \\r\\n        p.rpr_tge_vmotivo AS cod_motivo,\\r\\n        \\r\\n        -- Identifica\\u00e7\\u00e3o do usu\\u00e1rio\\r\\n        p.rpr_tus_cod_usr_inicio AS cod_usuario_inicio,\\r\\n        CASE \\r\\n            WHEN p.rpr_tus_cod_usr_inicio LIKE 'SAT%' THEN 1\\r\\n            ELSE 0\\r\\n        END AS flag_cancelamento_automatico,\\r\\n        \\r\\n        f.nm_fiscal AS nome_fiscal,\\r\\n        \\r\\n        -- Dados cadastrais\\r\\n        ods.nu_cnpj AS cnpj,\\r\\n        ods.nu_ie AS ie,\\r\\n        ods.nm_razao_social AS nome_contribuinte,\\r\\n        ods.nm_razao_social AS razao_social,\\r\\n        \\r\\n        -- Situa\\u00e7\\u00e3o cadastral atual\\r\\n        ods.cd_sit_cadastral AS cod_situacao_atual,\\r\\n        ods.nm_sit_cadastral AS situacao_cadastral_atual,\\r\\n        \\r\\n        -- Localiza\\u00e7\\u00e3o\\r\\n        ods.cd_munic AS cod_municipio,\\r\\n        ods.nm_munic AS municipio,\\r\\n        ods.cd_uf AS uf,\\r\\n        \\r\\n        -- Atividade econ\\u00f4mica\\r\\n        LPAD(CAST(ods.cd_cnae AS STRING), 7, '0') AS cd_cnae,\\r\\n        ods.de_cnae AS descricao_cnae,\\r\\n        \\r\\n        -- Organiza\\u00e7\\u00e3o\\r\\n        ods.nu_cnpj_grupo AS grupo_economico,\\r\\n        ods.nm_gerfe AS gerencia_regional,\\r\\n        \\r\\n        -- Tipo contribuinte\\r\\n        ods.nm_tipo_contribuinte AS tipo_contribuinte,\\r\\n        ods.nm_reg_apuracao AS regime_apuracao,\\r\\n        \\r\\n        -- Data de refer\\u00eancia\\r\\n        dr.data_hoje,\\r\\n        dr.data_60m_atras\\r\\n        \\r\\n    FROM usr_sat_cadastro.ruc_protocolo p\\r\\n    CROSS JOIN data_referencia dr\\r\\n    \\r\\n    LEFT JOIN usr_sat_ods.vw_ods_contrib ods \\r\\n        ON TRIM(CAST(p.rpr_rge_ruc AS STRING)) = TRIM(CAST(ods.nu_ie AS STRING))\\r\\n    \\r\\n    LEFT JOIN usr_sat_malha_trans.mlh_fiscal f \\r\\n        ON TRIM(CAST(p.rpr_tus_cod_usr_inicio AS STRING)) = TRIM(CAST(f.cd_matricula AS STRING))\\r\\n        AND p.rpr_tus_cod_usr_inicio NOT LIKE 'SAT%'\\r\\n    \\r\\n    WHERE p.rpr_dt_inicio >= dr.data_60m_atras\\r\\n        AND p.rpr_tge_vevento IN (1, 3, 5)\\r\\n),\\r\\nsituacao_atual_empresa AS (\\r\\n    SELECT \\r\\n        cnpj,\\r\\n        MAX(CASE \\r\\n            WHEN cod_situacao_atual = 1 THEN 0 \\r\\n            ELSE 1\\r\\n        END) AS flag_ainda_cancelada\\r\\n    FROM protocolos_enriquecidos\\r\\n    WHERE cnpj IS NOT NULL\\r\\n    GROUP BY cnpj\\r\\n),\\r\\nhistorico_protocolos AS (\\r\\n    SELECT \\r\\n        cnpj,\\r\\n        COUNT(DISTINCT protocolo) AS qtde_protocolos_total,\\r\\n        COUNT(DISTINCT YEAR(data_inicio_protocolo)) AS anos_com_protocolos,\\r\\n        SUM(flag_cancelamento_automatico) AS qtde_automaticos,\\r\\n        COUNT(*) - SUM(flag_cancelamento_automatico) AS qtde_manuais,\\r\\n        MIN(data_inicio_protocolo) AS data_primeiro_protocolo,\\r\\n        MAX(data_inicio_protocolo) AS data_ultimo_protocolo,\\r\\n        AVG(DATEDIFF(data_hoje, data_inicio_protocolo)) AS media_dias_protocolos,\\r\\n        \\r\\n        CASE \\r\\n            WHEN SUM(flag_cancelamento_automatico) > COUNT(*) * 0.7 THEN 'MAIORIA_AUTOMATICO'\\r\\n            WHEN SUM(flag_cancelamento_automatico) < COUNT(*) * 0.3 THEN 'MAIORIA_MANUAL'\\r\\n            ELSE 'EQUILIBRADO'\\r\\n        END AS padrao_cancelamento\\r\\n        \\r\\n    FROM protocolos_enriquecidos\\r\\n    WHERE cnpj IS NOT NULL\\r\\n    GROUP BY cnpj\\r\\n)\\r\\nSELECT \\r\\n    pe.*,\\r\\n    \\r\\n    COALESCE(sa.flag_ainda_cancelada, 1) AS flag_ainda_cancelada,\\r\\n    CASE WHEN COALESCE(sa.flag_ainda_cancelada, 1) = 0 THEN 1 ELSE 0 END AS flag_reativada,\\r\\n    \\r\\n    hp.qtde_protocolos_total,\\r\\n    hp.anos_com_protocolos,\\r\\n    hp.qtde_automaticos,\\r\\n    hp.qtde_manuais,\\r\\n    hp.padrao_cancelamento,\\r\\n    \\r\\n    DATEDIFF(pe.data_hoje, pe.data_inicio_protocolo) AS dias_desde_cancelamento,\\r\\n    \\r\\n    CASE \\r\\n        WHEN hp.data_primeiro_protocolo IS NOT NULL \\r\\n        THEN ROUND(DATEDIFF(hp.data_ultimo_protocolo, hp.data_primeiro_protocolo) / 365.25, 2)\\r\\n        ELSE 0\\r\\n    END AS anos_atividade,\\r\\n    \\r\\n    hp.media_dias_protocolos\\r\\n    \\r\\nFROM protocolos_enriquecidos pe\\r\\nLEFT JOIN situacao_atual_empresa sa ON pe.cnpj = sa.cnpj\\r\\nLEFT JOIN historico_protocolos hp ON pe.cnpj = hp.cnpj;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 2: LUCIANO_METRICAS (SEM ALTERA\\u00c7\\u00d5ES)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_metricas;\\r\\n\\r\\nCREATE TABLE teste.luciano_metricas AS\\r\\nSELECT \\r\\n    cnpj,\\r\\n    nome_contribuinte,\\r\\n    razao_social,\\r\\n    cd_cnae,\\r\\n    descricao_cnae,\\r\\n    municipio,\\r\\n    uf,\\r\\n    gerencia_regional,\\r\\n    grupo_economico,\\r\\n    tipo_contribuinte,\\r\\n    regime_apuracao,\\r\\n    \\r\\n    COUNT(DISTINCT protocolo) AS total_protocolos,\\r\\n    COUNT(DISTINCT YEAR(data_inicio_protocolo)) AS anos_distintos_cancelamento,\\r\\n    COUNT(DISTINCT cod_usuario_inicio) AS qtde_usuarios_distintos,\\r\\n    \\r\\n    SUM(CASE WHEN flag_cancelamento_automatico = 0 THEN 1 ELSE 0 END) AS qtde_individuais,\\r\\n    SUM(CASE WHEN flag_cancelamento_automatico = 1 THEN 1 ELSE 0 END) AS qtde_massivos,\\r\\n    SUM(flag_cancelamento_automatico) AS qtde_automaticos,\\r\\n    COUNT(*) - SUM(flag_cancelamento_automatico) AS qtde_manuais,\\r\\n    \\r\\n    MAX(flag_ainda_cancelada) AS qtde_ainda_cancelada,\\r\\n    MAX(flag_reativada) AS qtde_reativada,\\r\\n    SUM(flag_reativada) AS qtde_casos_reativacao,\\r\\n    \\r\\n    AVG(dias_desde_cancelamento) AS media_dias_desde_cancelamento,\\r\\n    MIN(dias_desde_cancelamento) AS min_dias_desde_cancelamento,\\r\\n    MAX(dias_desde_cancelamento) AS max_dias_desde_cancelamento,\\r\\n    \\r\\n    DATEDIFF(MAX(data_inicio_protocolo), MIN(data_inicio_protocolo)) AS dias_entre_primeiro_ultimo,\\r\\n    \\r\\n    ROUND(SUM(flag_reativada) * 100.0 / COUNT(*), 2) AS taxa_reativacao_perc,\\r\\n    ROUND(SUM(flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_permanencia_cancelamento_perc,\\r\\n    \\r\\n    AVG(CASE WHEN flag_reativada = 1 THEN dias_desde_cancelamento END) AS dias_medios_reativacao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT protocolo) >= 10 THEN 'MUITO_ALTA'\\r\\n        WHEN COUNT(DISTINCT protocolo) >= 5 THEN 'ALTA'\\r\\n        WHEN COUNT(DISTINCT protocolo) >= 2 THEN 'MODERADA'\\r\\n        ELSE 'UNICA_OCORRENCIA'\\r\\n    END AS classificacao_frequencia,\\r\\n    \\r\\n    CASE \\r\\n        WHEN MAX(flag_ainda_cancelada) = 1 AND AVG(dias_desde_cancelamento) > 1095 THEN 'CRITICA'\\r\\n        WHEN MAX(flag_ainda_cancelada) = 1 AND AVG(dias_desde_cancelamento) > 730 THEN 'ALTA'\\r\\n        WHEN MAX(flag_ainda_cancelada) = 1 AND AVG(dias_desde_cancelamento) > 365 THEN 'MEDIA'\\r\\n        WHEN MAX(flag_ainda_cancelada) = 1 THEN 'BAIXA'\\r\\n        ELSE 'NAO_APLICAVEL'\\r\\n    END AS classificacao_persistencia,\\r\\n    \\r\\n    CASE \\r\\n        WHEN ROUND(SUM(flag_ainda_cancelada) * 100.0 / COUNT(*), 2) >= 90 THEN 'EFETIVO'\\r\\n        WHEN ROUND(SUM(flag_ainda_cancelada) * 100.0 / COUNT(*), 2) >= 70 THEN 'PARCIALMENTE_EFETIVO'\\r\\n        WHEN ROUND(SUM(flag_ainda_cancelada) * 100.0 / COUNT(*), 2) >= 50 THEN 'POUCO_EFETIVO'\\r\\n        ELSE 'INEFETIVO'\\r\\n    END AS efetividade_cancelamento,\\r\\n    \\r\\n    MAX(padrao_cancelamento) AS padrao_cancelamento_predominante,\\r\\n    \\r\\n    GROUP_CONCAT(DISTINCT nome_fiscal, ', ') AS lista_fiscais_envolvidos,\\r\\n    \\r\\n    CASE WHEN COUNT(DISTINCT protocolo) >= 3 THEN 1 ELSE 0 END AS flag_empresa_reincidente,\\r\\n    MAX(flag_ainda_cancelada) AS flag_atualmente_cancelada,\\r\\n    \\r\\n    MIN(data_inicio_protocolo) AS data_primeiro_cancelamento,\\r\\n    MAX(data_inicio_protocolo) AS data_ultimo_cancelamento,\\r\\n    MAX(anos_atividade) AS media_anos_atividade\\r\\n\\r\\nFROM teste.luciano_base\\r\\nWHERE cnpj IS NOT NULL\\r\\nGROUP BY \\r\\n    cnpj, nome_contribuinte, razao_social, cd_cnae, descricao_cnae,\\r\\n    municipio, uf, gerencia_regional, grupo_economico, tipo_contribuinte, regime_apuracao;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 3: LUCIANO_CREDITO (SEM ALTERA\\u00c7\\u00d5ES)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_credito;\\r\\n\\r\\nCREATE TABLE teste.luciano_credito AS\\r\\nWITH data_ref AS (\\r\\n    SELECT \\r\\n        CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE) AS data_hoje,\\r\\n        ADD_MONTHS(CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE), -12) AS data_12m_atras,\\r\\n        ADD_MONTHS(CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE), -60) AS data_60m_atras\\r\\n),\\r\\nperiodo_inicio AS (\\r\\n    SELECT\\r\\n        data_hoje,\\r\\n        data_12m_atras,\\r\\n        data_60m_atras,\\r\\n        CAST(CONCAT(\\r\\n            CAST(YEAR(data_12m_atras) AS STRING),\\r\\n            LPAD(CAST(MONTH(data_12m_atras) AS STRING), 2, '0')\\r\\n        ) AS INT) AS nu_per_inicio_12m,\\r\\n        CAST(CONCAT(\\r\\n            CAST(YEAR(data_60m_atras) AS STRING),\\r\\n            LPAD(CAST(MONTH(data_60m_atras) AS STRING), 2, '0')\\r\\n        ) AS INT) AS nu_per_inicio_60m\\r\\n    FROM data_ref\\r\\n),\\r\\ncreditos_dime_12m AS (\\r\\n    SELECT \\r\\n        d.nu_ie,\\r\\n        SUM(d.vl_cred_mes_anterior) AS vl_credito_12m,\\r\\n        SUM(d.vl_cred_mes_seguinte) AS vl_saldo_credor_12m,\\r\\n        COUNT(DISTINCT d.nu_per_ref) AS qtde_periodos_declarados_12m,\\r\\n        MAX(d.nu_per_ref) AS ultimo_periodo_declarado,\\r\\n        COUNT(DISTINCT d.vl_cred_mes_seguinte) AS valores_distintos_12m,\\r\\n        COUNT(*) AS total_periodos_12m,\\r\\n        MAX(d.vl_cred_mes_seguinte) AS saldo_credor_atual\\r\\n        \\r\\n    FROM usr_sat_ods.ods_decl_dime_raw d\\r\\n    CROSS JOIN periodo_inicio pi\\r\\n    WHERE d.nu_per_ref >= pi.nu_per_inicio_12m\\r\\n    GROUP BY d.nu_ie\\r\\n),\\r\\ncreditos_dime_60m AS (\\r\\n    SELECT \\r\\n        d.nu_ie,\\r\\n        SUM(d.vl_cred_mes_anterior) AS vl_credito_60m,\\r\\n        SUM(d.vl_cred_mes_seguinte) AS vl_saldo_credor_60m,\\r\\n        COUNT(DISTINCT d.nu_per_ref) AS qtde_periodos_declarados_60m,\\r\\n        AVG(d.vl_cred_mes_anterior) AS media_credito,\\r\\n        STDDEV(d.vl_cred_mes_anterior) AS desvio_padrao_credito,\\r\\n        MIN(d.vl_cred_mes_seguinte) AS min_saldo_60m,\\r\\n        MAX(d.vl_cred_mes_seguinte) AS max_saldo_60m,\\r\\n        COUNT(DISTINCT d.vl_cred_mes_seguinte) AS valores_distintos_60m,\\r\\n        COUNT(*) AS total_periodos_60m\\r\\n        \\r\\n    FROM usr_sat_ods.ods_decl_dime_raw d\\r\\n    CROSS JOIN periodo_inicio pi\\r\\n    WHERE d.nu_per_ref >= pi.nu_per_inicio_60m\\r\\n    GROUP BY d.nu_ie\\r\\n),\\r\\ncredito_presumido AS (\\r\\n    SELECT \\r\\n        dc.nu_ie,\\r\\n        SUM(CASE WHEN dc.nu_per_ref >= pi.nu_per_inicio_12m THEN dc.vl_credito ELSE 0 END) AS vl_credito_presumido_12m,\\r\\n        COUNT(DISTINCT CASE WHEN dc.nu_per_ref >= pi.nu_per_inicio_12m THEN dc.cd_tipo_credito END) AS tipos_cp_12m,\\r\\n        COUNT(DISTINCT CASE WHEN dc.nu_per_ref >= pi.nu_per_inicio_12m THEN dc.nu_per_ref END) AS qtde_dcip_12m,\\r\\n        \\r\\n        SUM(CASE WHEN dc.nu_per_ref >= pi.nu_per_inicio_60m THEN dc.vl_credito ELSE 0 END) AS vl_credito_presumido_60m,\\r\\n        COUNT(DISTINCT CASE WHEN dc.nu_per_ref >= pi.nu_per_inicio_60m THEN dc.cd_tipo_credito END) AS tipos_cp_60m,\\r\\n        COUNT(DISTINCT CASE WHEN dc.nu_per_ref >= pi.nu_per_inicio_60m THEN dc.nu_per_ref END) AS qtde_dcip_60m,\\r\\n        \\r\\n        SUM(CASE \\r\\n            WHEN dc.nu_per_ref >= pi.nu_per_inicio_60m AND dc.cd_tipo_credito IN (1, 2, 3) \\r\\n            THEN dc.vl_credito \\r\\n            ELSE 0 \\r\\n        END) AS vl_cp_presumido_total,\\r\\n        \\r\\n        SUM(CASE \\r\\n            WHEN dc.nu_per_ref >= pi.nu_per_inicio_60m AND dc.cd_tipo_credito NOT IN (1, 2, 3) \\r\\n            THEN dc.vl_credito \\r\\n            ELSE 0 \\r\\n        END) AS vl_outros_creditos,\\r\\n        \\r\\n        COUNT(DISTINCT CASE \\r\\n            WHEN dc.nu_per_ref >= pi.nu_per_inicio_60m AND dc.cd_estado_decl <> 1 \\r\\n            THEN dc.nu_per_ref \\r\\n        END) AS qtde_dcip_canceladas\\r\\n        \\r\\n    FROM usr_sat_ods.vw_ods_dcip dc\\r\\n    CROSS JOIN periodo_inicio pi\\r\\n    GROUP BY dc.nu_ie\\r\\n)\\r\\nSELECT \\r\\n    b.cnpj,\\r\\n    b.ie,\\r\\n    b.nome_contribuinte,\\r\\n    \\r\\n    COALESCE(d12.vl_credito_12m, 0) AS vl_credito_12m,\\r\\n    COALESCE(d12.vl_saldo_credor_12m, 0) AS vl_saldo_credor_12m,\\r\\n    COALESCE(d12.qtde_periodos_declarados_12m, 0) AS qtde_periodos_declarados_12m,\\r\\n    d12.ultimo_periodo_declarado,\\r\\n    COALESCE(d12.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    \\r\\n    COALESCE(d60.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(d60.vl_saldo_credor_60m, 0) AS vl_saldo_credor_60m,\\r\\n    COALESCE(d60.qtde_periodos_declarados_60m, 0) AS qtde_periodos_declarados_60m,\\r\\n    COALESCE(d60.media_credito, 0) AS media_credito,\\r\\n    COALESCE(d60.desvio_padrao_credito, 0) AS desvio_padrao_credito,\\r\\n    COALESCE(d60.min_saldo_60m, 0) AS min_saldo_60m,\\r\\n    COALESCE(d60.max_saldo_60m, 0) AS max_saldo_60m,\\r\\n    \\r\\n    COALESCE(d12.total_periodos_12m - d12.valores_distintos_12m, 0) AS qtde_valores_iguais_12m,\\r\\n    COALESCE(d60.total_periodos_60m - d60.valores_distintos_60m, 0) AS qtde_valores_iguais_60m,\\r\\n    ROUND(\\r\\n        COALESCE(d12.total_periodos_12m - d12.valores_distintos_12m, 0) * 100.0 / \\r\\n        NULLIF(COALESCE(d12.total_periodos_12m, 0), 0),\\r\\n        2\\r\\n    ) AS perc_valores_iguais_12m,\\r\\n    ROUND(\\r\\n        COALESCE(d60.total_periodos_60m - d60.valores_distintos_60m, 0) * 100.0 / \\r\\n        NULLIF(COALESCE(d60.total_periodos_60m, 0), 0),\\r\\n        2\\r\\n    ) AS perc_valores_iguais_60m,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(d60.min_saldo_60m, 0) > 0 \\r\\n        THEN ROUND((COALESCE(d60.max_saldo_60m, 0) - COALESCE(d60.min_saldo_60m, 0)) * 100.0 / d60.min_saldo_60m, 2)\\r\\n        ELSE 0\\r\\n    END AS variacao_saldo_perc_60m,\\r\\n    \\r\\n    COALESCE(cp.vl_credito_presumido_12m, 0) AS vl_credito_presumido_12m,\\r\\n    COALESCE(cp.tipos_cp_12m, 0) AS tipos_cp_12m,\\r\\n    COALESCE(cp.qtde_dcip_12m, 0) AS qtde_dcip_12m,\\r\\n    COALESCE(cp.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cp.tipos_cp_60m, 0) AS tipos_cp_60m,\\r\\n    COALESCE(cp.qtde_dcip_60m, 0) AS qtde_dcip_60m,\\r\\n    COALESCE(cp.vl_cp_presumido_total, 0) AS vl_cp_presumido_total,\\r\\n    COALESCE(cp.vl_outros_creditos, 0) AS vl_outros_creditos,\\r\\n    COALESCE(cp.qtde_dcip_canceladas, 0) AS qtde_dcip_canceladas,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(d12.saldo_credor_atual, 0) > 100000 AND b.flag_ainda_cancelada = 1 \\r\\n        THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_saldo_alto_cancelada,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(d12.total_periodos_12m - d12.valores_distintos_12m, 0) >= 6 \\r\\n        THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_suspeita_valores_repetidos,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(d12.saldo_credor_atual, 0) > 0 \\r\\n        AND COALESCE(d12.qtde_periodos_declarados_12m, 0) = 0 \\r\\n        THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_saldo_sem_declaracao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(d60.desvio_padrao_credito, 0) < 100 \\r\\n        AND COALESCE(d60.media_credito, 0) > 10000 \\r\\n        THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_credito_muito_estavel,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(d60.min_saldo_60m, 0) > 0 \\r\\n        AND ((COALESCE(d60.max_saldo_60m, 0) - COALESCE(d60.min_saldo_60m, 0)) * 100.0 / d60.min_saldo_60m) > 500 \\r\\n        THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS flag_crescimento_anormal_saldo\\r\\n\\r\\nFROM (\\r\\n    SELECT DISTINCT cnpj, ie, nome_contribuinte, flag_ainda_cancelada\\r\\n    FROM teste.luciano_base\\r\\n    WHERE cnpj IS NOT NULL\\r\\n) b\\r\\nLEFT JOIN creditos_dime_12m d12 ON b.ie = d12.nu_ie\\r\\nLEFT JOIN creditos_dime_60m d60 ON b.ie = d60.nu_ie\\r\\nLEFT JOIN credito_presumido cp ON b.ie = cp.nu_ie;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 4: LUCIANO_INDICIOS (\\u2705 CORRE\\u00c7\\u00c3O: LIMIAR DE GRAVES AJUSTADO)\\r\\n-- =====================================================================\\r\\n-- PROBLEMA ORIGINAL: score_indicio > 200 \\u2192 nenhuma empresa atingia\\r\\n-- SOLU\\u00c7\\u00c3O: Ajustado para score_indicio >= 100 (mais realista)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_indicios;\\r\\n\\r\\nCREATE TABLE teste.luciano_indicios AS\\r\\nWITH indicios_processados AS (\\r\\n    SELECT \\r\\n        ei.nu_cpf_cnpj AS cnpj_indicio,\\r\\n        \\r\\n        CAST(ic.cd_complemento AS INT) AS cd_indicio,\\r\\n        ic.tx_descricao_complemento AS descricao_indicio,\\r\\n        \\r\\n        -- Score por tipo de ind\\u00edcio (mantido)\\r\\n        CASE \\r\\n            WHEN CAST(ic.cd_complemento AS INT) IN (62, 63) THEN 300\\r\\n            WHEN CAST(ic.cd_complemento AS INT) BETWEEN 20 AND 22 THEN 250\\r\\n            WHEN CAST(ic.cd_complemento AS INT) BETWEEN 11 AND 13 THEN 200\\r\\n            WHEN CAST(ic.cd_complemento AS INT) BETWEEN 5 AND 8 THEN 150\\r\\n            WHEN CAST(ic.cd_complemento AS INT) BETWEEN 1 AND 4 THEN 100\\r\\n            ELSE 50\\r\\n        END AS score_indicio,\\r\\n        \\r\\n        -- Categoria do ind\\u00edcio\\r\\n        CASE \\r\\n            WHEN CAST(ic.cd_complemento AS INT) BETWEEN 1 AND 4 THEN 'DOCS_FISCAIS'\\r\\n            WHEN CAST(ic.cd_complemento AS INT) BETWEEN 5 AND 8 OR CAST(ic.cd_complemento AS INT) IN (62, 63) THEN 'RELACIONAMENTOS'\\r\\n            WHEN CAST(ic.cd_complemento AS INT) BETWEEN 11 AND 13 THEN 'DECLARACOES'\\r\\n            WHEN CAST(ic.cd_complemento AS INT) BETWEEN 20 AND 22 THEN 'CADASTRO'\\r\\n            ELSE 'OUTROS'\\r\\n        END AS categoria_indicio\\r\\n        \\r\\n    FROM neaf.empresa_indicio ei,\\r\\n    ei.indicio_complemento ic\\r\\n    WHERE ei.cd_atual = 1\\r\\n),\\r\\nagregacao_indicios AS (\\r\\n    SELECT \\r\\n        cnpj_indicio,\\r\\n        COUNT(*) AS qtde_indicios,\\r\\n        COUNT(DISTINCT cd_indicio) AS qtde_tipos_indicios_distintos,\\r\\n        SUM(score_indicio) AS soma_scores_indicios,\\r\\n        AVG(score_indicio) AS media_score_indicios,\\r\\n        MAX(score_indicio) AS max_score_indicio,\\r\\n        \\r\\n        -- \\u2705 CORRE\\u00c7\\u00c3O CR\\u00cdTICA: Ajustado de > 200 para >= 100\\r\\n        -- Isso vai capturar ind\\u00edcios de DOCS_FISCAIS (100), RELACIONAMENTOS (150), etc.\\r\\n        SUM(CASE WHEN score_indicio >= 100 THEN 1 ELSE 0 END) AS qtde_indicios_graves,\\r\\n        \\r\\n        -- \\u2705 NOVO: Contagem por faixas de gravidade\\r\\n        SUM(CASE WHEN score_indicio >= 200 THEN 1 ELSE 0 END) AS qtde_indicios_muito_graves,\\r\\n        SUM(CASE WHEN score_indicio >= 150 AND score_indicio < 200 THEN 1 ELSE 0 END) AS qtde_indicios_moderados,\\r\\n        \\r\\n        -- Contagem por categoria\\r\\n        SUM(CASE WHEN categoria_indicio = 'DOCS_FISCAIS' THEN 1 ELSE 0 END) AS qtde_indicios_docs_fiscais,\\r\\n        SUM(CASE WHEN categoria_indicio = 'RELACIONAMENTOS' THEN 1 ELSE 0 END) AS qtde_indicios_relacionamentos,\\r\\n        SUM(CASE WHEN categoria_indicio = 'DECLARACOES' THEN 1 ELSE 0 END) AS qtde_indicios_declaracoes,\\r\\n        SUM(CASE WHEN categoria_indicio = 'CADASTRO' THEN 1 ELSE 0 END) AS qtde_indicios_cadastro,\\r\\n        \\r\\n        GROUP_CONCAT(CONCAT(CAST(cd_indicio AS STRING), ':', descricao_indicio), ' | ') AS lista_indicios_detalhada\\r\\n        \\r\\n    FROM indicios_processados\\r\\n    GROUP BY cnpj_indicio\\r\\n)\\r\\nSELECT \\r\\n    b.cnpj,\\r\\n    b.ie,\\r\\n    b.nome_contribuinte,\\r\\n    \\r\\n    COALESCE(ai.qtde_indicios, 0) AS qtde_indicios,\\r\\n    COALESCE(ai.qtde_tipos_indicios_distintos, 0) AS qtde_tipos_indicios_distintos,\\r\\n    COALESCE(ai.soma_scores_indicios, 0) AS soma_scores_indicios,\\r\\n    COALESCE(ai.media_score_indicios, 0) AS media_score_indicios,\\r\\n    COALESCE(ai.max_score_indicio, 0) AS max_score_indicio,\\r\\n    COALESCE(ai.qtde_indicios_graves, 0) AS qtde_indicios_graves,\\r\\n    COALESCE(ai.qtde_indicios_muito_graves, 0) AS qtde_indicios_muito_graves,\\r\\n    COALESCE(ai.qtde_indicios_moderados, 0) AS qtde_indicios_moderados,\\r\\n    COALESCE(ai.qtde_indicios_docs_fiscais, 0) AS qtde_indicios_docs_fiscais,\\r\\n    COALESCE(ai.qtde_indicios_relacionamentos, 0) AS qtde_indicios_relacionamentos,\\r\\n    COALESCE(ai.qtde_indicios_declaracoes, 0) AS qtde_indicios_declaracoes,\\r\\n    COALESCE(ai.qtde_indicios_cadastro, 0) AS qtde_indicios_cadastro,\\r\\n    \\r\\n    -- \\u2705 CORRE\\u00c7\\u00c3O: Classifica\\u00e7\\u00e3o ajustada para capturar mais casos\\r\\n    CASE \\r\\n        WHEN COALESCE(ai.soma_scores_indicios, 0) >= 500 OR COALESCE(ai.qtde_indicios_graves, 0) >= 3 THEN 'CR\\u00cdTICO'\\r\\n        WHEN COALESCE(ai.soma_scores_indicios, 0) >= 300 OR COALESCE(ai.qtde_indicios_graves, 0) >= 2 THEN 'ALTO'\\r\\n        WHEN COALESCE(ai.soma_scores_indicios, 0) >= 100 OR COALESCE(ai.qtde_indicios_graves, 0) >= 1 THEN 'M\\u00c9DIO'\\r\\n        WHEN COALESCE(ai.qtde_indicios, 0) >= 1 THEN 'BAIXO'\\r\\n        ELSE 'SEM_INDICIOS'\\r\\n    END AS classificacao_risco_indicios,\\r\\n    \\r\\n    CASE WHEN COALESCE(ai.qtde_indicios, 0) > 0 THEN 1 ELSE 0 END AS flag_tem_indicios,\\r\\n    CASE WHEN COALESCE(ai.qtde_indicios_graves, 0) > 0 THEN 1 ELSE 0 END AS flag_tem_indicios_graves,\\r\\n    CASE WHEN COALESCE(ai.qtde_indicios_relacionamentos, 0) > 0 THEN 1 ELSE 0 END AS flag_indicios_relacionamento,\\r\\n    CASE WHEN COALESCE(ai.qtde_indicios_docs_fiscais, 0) > 0 THEN 1 ELSE 0 END AS flag_indicios_docs_fiscais,\\r\\n    \\r\\n    ai.lista_indicios_detalhada\\r\\n\\r\\nFROM (\\r\\n    SELECT DISTINCT cnpj, ie, nome_contribuinte\\r\\n    FROM teste.luciano_base\\r\\n    WHERE cnpj IS NOT NULL\\r\\n) b\\r\\nLEFT JOIN agregacao_indicios ai ON b.cnpj = ai.cnpj_indicio;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 5: LUCIANO_SCORES (\\u2705 CORRE\\u00c7\\u00c3O PARA IMPALA - SEM PERCENTILE_APPROX)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_scores;\\r\\n\\r\\nCREATE TABLE teste.luciano_scores AS\\r\\nWITH scores_calculados AS (\\r\\n    SELECT \\r\\n        m.cnpj,\\r\\n        m.nome_contribuinte,\\r\\n        m.razao_social,\\r\\n        m.cd_cnae,\\r\\n        m.municipio,\\r\\n        m.uf,\\r\\n        m.gerencia_regional,\\r\\n        \\r\\n        -- SCORE COMPORTAMENTO (0-100)\\r\\n        (\\r\\n            CASE \\r\\n                WHEN m.total_protocolos >= 5 THEN 30\\r\\n                WHEN m.total_protocolos >= 3 THEN 20\\r\\n                WHEN m.total_protocolos >= 2 THEN 10\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN m.taxa_permanencia_cancelamento_perc >= 90 THEN 25\\r\\n                WHEN m.taxa_permanencia_cancelamento_perc >= 75 THEN 20\\r\\n                WHEN m.taxa_permanencia_cancelamento_perc >= 60 THEN 15\\r\\n                WHEN m.taxa_permanencia_cancelamento_perc >= 40 THEN 10\\r\\n                ELSE 5\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN m.anos_distintos_cancelamento >= 4 THEN 15\\r\\n                WHEN m.anos_distintos_cancelamento >= 3 THEN 10\\r\\n                WHEN m.anos_distintos_cancelamento >= 2 THEN 5\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN m.media_anos_atividade < 2 AND m.total_protocolos >= 2 THEN 15\\r\\n                WHEN m.media_anos_atividade < 3 AND m.total_protocolos >= 3 THEN 10\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN m.classificacao_frequencia = 'MUITO_ALTA' THEN 15\\r\\n                WHEN m.classificacao_frequencia = 'ALTA' THEN 10\\r\\n                WHEN m.classificacao_frequencia = 'MODERADA' THEN 5\\r\\n                ELSE 0\\r\\n            END\\r\\n        ) AS score_comportamento,\\r\\n        \\r\\n        -- SCORE CR\\u00c9DITO (0-100)\\r\\n        (\\r\\n            CASE \\r\\n                WHEN c.flag_saldo_alto_cancelada = 1 AND c.saldo_credor_atual > 1000000 THEN 30\\r\\n                WHEN c.flag_saldo_alto_cancelada = 1 AND c.saldo_credor_atual > 500000 THEN 25\\r\\n                WHEN c.flag_saldo_alto_cancelada = 1 THEN 20\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN c.perc_valores_iguais_12m >= 80 THEN 25\\r\\n                WHEN c.perc_valores_iguais_12m >= 60 THEN 20\\r\\n                WHEN c.perc_valores_iguais_12m >= 40 THEN 15\\r\\n                WHEN c.flag_suspeita_valores_repetidos = 1 THEN 10\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN c.flag_saldo_sem_declaracao = 1 AND c.saldo_credor_atual > 100000 THEN 20\\r\\n                WHEN c.flag_saldo_sem_declaracao = 1 THEN 15\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN c.flag_credito_muito_estavel = 1 AND c.perc_valores_iguais_60m > 50 THEN 15\\r\\n                WHEN c.flag_credito_muito_estavel = 1 THEN 10\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN c.flag_crescimento_anormal_saldo = 1 THEN 10\\r\\n                ELSE 0\\r\\n            END\\r\\n        ) AS score_credito,\\r\\n        \\r\\n        -- SCORE IND\\u00cdCIOS (0-100)\\r\\n        (\\r\\n            CASE \\r\\n                WHEN i.soma_scores_indicios >= 1500 THEN 50\\r\\n                WHEN i.soma_scores_indicios >= 1000 THEN 45\\r\\n                WHEN i.soma_scores_indicios >= 700 THEN 40\\r\\n                WHEN i.soma_scores_indicios >= 500 THEN 35\\r\\n                WHEN i.soma_scores_indicios >= 300 THEN 25\\r\\n                WHEN i.soma_scores_indicios >= 100 THEN 15\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN i.qtde_indicios_graves >= 5 THEN 30\\r\\n                WHEN i.qtde_indicios_graves >= 3 THEN 25\\r\\n                WHEN i.qtde_indicios_graves >= 2 THEN 20\\r\\n                WHEN i.qtde_indicios_graves >= 1 THEN 15\\r\\n                ELSE 0\\r\\n            END +\\r\\n            CASE \\r\\n                WHEN i.qtde_tipos_indicios_distintos >= 8 THEN 20\\r\\n                WHEN i.qtde_tipos_indicios_distintos >= 6 THEN 15\\r\\n                WHEN i.qtde_tipos_indicios_distintos >= 4 THEN 10\\r\\n                WHEN i.qtde_tipos_indicios_distintos >= 2 THEN 5\\r\\n                ELSE 0\\r\\n            END\\r\\n        ) AS score_indicios,\\r\\n        \\r\\n        -- M\\u00e9tricas originais\\r\\n        m.total_protocolos,\\r\\n        m.taxa_permanencia_cancelamento_perc,\\r\\n        m.taxa_reativacao_perc,\\r\\n        m.classificacao_frequencia,\\r\\n        m.classificacao_persistencia,\\r\\n        m.efetividade_cancelamento,\\r\\n        m.flag_empresa_reincidente,\\r\\n        m.flag_atualmente_cancelada,\\r\\n        \\r\\n        c.saldo_credor_atual,\\r\\n        c.vl_credito_60m,\\r\\n        c.vl_credito_presumido_60m,\\r\\n        c.flag_saldo_alto_cancelada,\\r\\n        c.flag_suspeita_valores_repetidos,\\r\\n        c.perc_valores_iguais_12m,\\r\\n        c.variacao_saldo_perc_60m,\\r\\n        \\r\\n        i.qtde_indicios,\\r\\n        i.soma_scores_indicios,\\r\\n        i.qtde_indicios_graves,\\r\\n        i.classificacao_risco_indicios,\\r\\n        i.flag_tem_indicios,\\r\\n        i.flag_tem_indicios_graves\\r\\n        \\r\\n    FROM teste.luciano_metricas m\\r\\n    LEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\n    LEFT JOIN teste.luciano_indicios i ON m.cnpj = i.cnpj\\r\\n),\\r\\n\\r\\n-- \\u2705 C\\u00c1LCULO DO SCORE TOTAL E RANKING COM NTILE\\r\\nscores_com_ranking AS (\\r\\n    SELECT \\r\\n        sc.*,\\r\\n        ROUND(\\r\\n            (sc.score_comportamento * 0.25) + \\r\\n            (sc.score_credito * 0.35) + \\r\\n            (sc.score_indicios * 0.40),\\r\\n            2\\r\\n        ) AS score_total,\\r\\n        -- NTILE(100) divide em 100 grupos (percentis)\\r\\n        NTILE(100) OVER (\\r\\n            ORDER BY ROUND(\\r\\n                (sc.score_comportamento * 0.25) + \\r\\n                (sc.score_credito * 0.35) + \\r\\n                (sc.score_indicios * 0.40),\\r\\n                2\\r\\n            ) ASC\\r\\n        ) AS percentil_grupo\\r\\n    FROM scores_calculados sc\\r\\n),\\r\\n\\r\\n-- \\u2705 ENCONTRAR OS LIMIARES DE CADA PERCENTIL\\r\\nlimiares AS (\\r\\n    SELECT\\r\\n        MAX(CASE WHEN percentil_grupo = 50 THEN score_total END) AS p50,\\r\\n        MAX(CASE WHEN percentil_grupo = 80 THEN score_total END) AS p80,\\r\\n        MAX(CASE WHEN percentil_grupo = 95 THEN score_total END) AS p95,\\r\\n        MAX(CASE WHEN percentil_grupo = 97 THEN score_total END) AS p97,\\r\\n        MAX(CASE WHEN percentil_grupo = 99 THEN score_total END) AS p99\\r\\n    FROM scores_com_ranking\\r\\n)\\r\\n\\r\\nSELECT \\r\\n    sr.cnpj,\\r\\n    sr.nome_contribuinte,\\r\\n    sr.razao_social,\\r\\n    sr.cd_cnae,\\r\\n    sr.municipio,\\r\\n    sr.uf,\\r\\n    sr.gerencia_regional,\\r\\n    sr.score_comportamento,\\r\\n    sr.score_credito,\\r\\n    sr.score_indicios,\\r\\n    sr.total_protocolos,\\r\\n    sr.taxa_permanencia_cancelamento_perc,\\r\\n    sr.taxa_reativacao_perc,\\r\\n    sr.classificacao_frequencia,\\r\\n    sr.classificacao_persistencia,\\r\\n    sr.efetividade_cancelamento,\\r\\n    sr.flag_empresa_reincidente,\\r\\n    sr.flag_atualmente_cancelada,\\r\\n    sr.saldo_credor_atual,\\r\\n    sr.vl_credito_60m,\\r\\n    sr.vl_credito_presumido_60m,\\r\\n    sr.flag_saldo_alto_cancelada,\\r\\n    sr.flag_suspeita_valores_repetidos,\\r\\n    sr.perc_valores_iguais_12m,\\r\\n    sr.variacao_saldo_perc_60m,\\r\\n    sr.qtde_indicios,\\r\\n    sr.soma_scores_indicios,\\r\\n    sr.qtde_indicios_graves,\\r\\n    sr.classificacao_risco_indicios,\\r\\n    sr.flag_tem_indicios,\\r\\n    sr.flag_tem_indicios_graves,\\r\\n    sr.score_total,\\r\\n    \\r\\n    -- \\u2705 CLASSIFICA\\u00c7\\u00c3O DE RISCO (baseada nos percentis)\\r\\n    CASE \\r\\n        WHEN sr.score_total >= l.p99 THEN 'CR\\u00cdTICO'\\r\\n        WHEN sr.score_total >= l.p97 THEN 'ALTO'\\r\\n        WHEN sr.score_total >= l.p50 THEN 'M\\u00c9DIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS classificacao_risco_final,\\r\\n    \\r\\n    -- Ranking de fiscaliza\\u00e7\\u00e3o\\r\\n    ROW_NUMBER() OVER (\\r\\n        ORDER BY sr.score_total DESC,\\r\\n                 sr.saldo_credor_atual DESC,\\r\\n                 sr.qtde_indicios_graves DESC\\r\\n    ) AS ranking_fiscalizacao,\\r\\n    \\r\\n    -- \\u2705 N\\u00cdVEL DE ALERTA\\r\\n    CASE \\r\\n        WHEN sr.score_total >= l.p99 \\r\\n             AND (sr.saldo_credor_atual > 50000 OR sr.qtde_indicios_graves >= 1)\\r\\n        THEN 'A\\u00c7\\u00c3O IMEDIATA'\\r\\n        WHEN sr.score_total >= l.p97 THEN 'MUITO URGENTE'\\r\\n        WHEN sr.score_total >= l.p95 THEN 'URGENTE'\\r\\n        WHEN sr.score_total >= l.p80 THEN 'PRIORIDADE ALTA'\\r\\n        ELSE 'MONITORAR'\\r\\n    END AS nivel_alerta,\\r\\n    \\r\\n    -- Prioridade num\\u00e9rica\\r\\n    CASE \\r\\n        WHEN sr.score_total >= l.p99 \\r\\n             AND (sr.saldo_credor_atual > 50000 OR sr.qtde_indicios_graves >= 1) THEN 1\\r\\n        WHEN sr.score_total >= l.p97 THEN 2\\r\\n        WHEN sr.score_total >= l.p95 THEN 3\\r\\n        WHEN sr.score_total >= l.p80 THEN 4\\r\\n        ELSE 5\\r\\n    END AS prioridade_num,\\r\\n    \\r\\n    -- Limiares utilizados (para refer\\u00eancia)\\r\\n    l.p99 AS limiar_critico_p99,\\r\\n    l.p97 AS limiar_alto_p97,\\r\\n    l.p95 AS limiar_urgente_p95,\\r\\n    l.p80 AS limiar_prioridade_p80,\\r\\n    l.p50 AS limiar_medio_p50\\r\\n\\r\\nFROM scores_com_ranking sr\\r\\nCROSS JOIN limiares l;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 6: LUCIANO_TEMPORAL (SEM ALTERA\\u00c7\\u00d5ES)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_temporal;\\r\\n\\r\\nCREATE TABLE teste.luciano_temporal AS\\r\\nSELECT \\r\\n    YEAR(data_inicio_protocolo) AS ano_cancelamento,\\r\\n    MONTH(data_inicio_protocolo) AS mes_cancelamento,\\r\\n    CONCAT(CAST(YEAR(data_inicio_protocolo) AS STRING), '-', LPAD(CAST(MONTH(data_inicio_protocolo) AS STRING), 2, '0')) AS periodo_cancelamento,\\r\\n    \\r\\n    COUNT(DISTINCT protocolo) AS qtde_protocolos,\\r\\n    COUNT(DISTINCT cnpj) AS qtde_empresas_distintas,\\r\\n    COUNT(DISTINCT cod_usuario_inicio) AS qtde_usuarios_distintos,\\r\\n    \\r\\n    SUM(CASE WHEN flag_cancelamento_automatico = 0 THEN 1 ELSE 0 END) AS qtde_individuais,\\r\\n    SUM(CASE WHEN flag_cancelamento_automatico = 1 THEN 1 ELSE 0 END) AS qtde_massivos,\\r\\n    SUM(flag_cancelamento_automatico) AS qtde_automaticos,\\r\\n    COUNT(*) - SUM(flag_cancelamento_automatico) AS qtde_manuais,\\r\\n    \\r\\n    SUM(flag_ainda_cancelada) AS qtde_ainda_canceladas,\\r\\n    SUM(flag_reativada) AS qtde_reativadas,\\r\\n    \\r\\n    ROUND(SUM(flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_permanencia_perc,\\r\\n    ROUND(SUM(flag_reativada) * 100.0 / COUNT(*), 2) AS taxa_reativacao_perc,\\r\\n    \\r\\n    COUNT(DISTINCT uf) AS qtde_ufs,\\r\\n    COUNT(DISTINCT municipio) AS qtde_municipios,\\r\\n    COUNT(DISTINCT gerencia_regional) AS qtde_gerfes,\\r\\n    COUNT(DISTINCT cd_cnae) AS qtde_cnaes_distintos,\\r\\n    \\r\\n    AVG(CASE WHEN flag_reativada = 1 THEN dias_desde_cancelamento END) AS media_dias_ate_reativacao\\r\\n\\r\\nFROM teste.luciano_base\\r\\nWHERE data_inicio_protocolo IS NOT NULL\\r\\nGROUP BY \\r\\n    YEAR(data_inicio_protocolo),\\r\\n    MONTH(data_inicio_protocolo),\\r\\n    CONCAT(CAST(YEAR(data_inicio_protocolo) AS STRING), '-', LPAD(CAST(MONTH(data_inicio_protocolo) AS STRING), 2, '0'))\\r\\nORDER BY ano_cancelamento DESC, mes_cancelamento DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 7: LUCIANO_FISCAL (SEM ALTERA\\u00c7\\u00d5ES)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_fiscal;\\r\\n\\r\\nCREATE TABLE teste.luciano_fiscal AS\\r\\nSELECT \\r\\n    b.cod_usuario_inicio AS matricula_fiscal,\\r\\n    b.nome_fiscal,\\r\\n    \\r\\n    COUNT(DISTINCT b.protocolo) AS qtde_protocolos_fiscal,\\r\\n    COUNT(DISTINCT b.cnpj) AS qtde_empresas_distintas,\\r\\n    COUNT(DISTINCT YEAR(b.data_inicio_protocolo)) AS anos_atuacao,\\r\\n    \\r\\n    SUM(b.flag_ainda_cancelada) AS qtde_cancelamentos_efetivos,\\r\\n    ROUND(SUM(b.flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_efetividade_perc,\\r\\n    ROUND(SUM(b.flag_reativada) * 100.0 / COUNT(*), 2) AS taxa_reativacao_perc,\\r\\n    \\r\\n    AVG(DATEDIFF(b.data_processamento, b.data_inicio_protocolo)) AS media_dias_processamento,\\r\\n    \\r\\n    AVG(b.qtde_protocolos_total) AS media_protocolos_por_empresa,\\r\\n    SUM(CASE WHEN b.qtde_protocolos_total >= 3 THEN 1 ELSE 0 END) AS qtde_casos_reincidentes,\\r\\n    \\r\\n    SUM(CASE WHEN b.flag_cancelamento_automatico = 0 THEN 1 ELSE 0 END) AS qtde_individuais,\\r\\n    SUM(CASE WHEN b.flag_cancelamento_automatico = 1 THEN 1 ELSE 0 END) AS qtde_massivos,\\r\\n    \\r\\n    MIN(b.data_inicio_protocolo) AS data_primeiro_protocolo,\\r\\n    MAX(b.data_inicio_protocolo) AS data_ultimo_protocolo,\\r\\n    \\r\\n    COALESCE(MAX(f.qt_total_chat), 0) AS total_chats,\\r\\n    COALESCE(MAX(f.qt_total_observacoes), 0) AS total_observacoes,\\r\\n    COALESCE(MAX(f.pe_dedicacao_malhas), 0) AS perc_dedicacao_malhas\\r\\n\\r\\nFROM teste.luciano_base b\\r\\nLEFT JOIN usr_sat_malha_trans.mlh_fiscal f ON b.cod_usuario_inicio = f.cd_matricula\\r\\nWHERE b.flag_cancelamento_automatico = 0\\r\\n    AND b.nome_fiscal IS NOT NULL\\r\\nGROUP BY b.cod_usuario_inicio, b.nome_fiscal\\r\\nHAVING COUNT(DISTINCT b.protocolo) >= 5\\r\\nORDER BY qtde_protocolos_fiscal DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 8: LUCIANO_RESUMO (\\u2705 ATUALIZADA COM ALERTAS E PERCENTIS)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_resumo;\\r\\n\\r\\nCREATE TABLE teste.luciano_resumo AS\\r\\nSELECT \\r\\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE) AS data_atualizacao,\\r\\n    \\r\\n    COUNT(DISTINCT s.cnpj) AS total_empresas,\\r\\n    SUM(s.total_protocolos) AS total_protocolos,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Risco (com percentis)\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS empresas_risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS empresas_risco_alto,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'M\\u00c9DIO' THEN 1 ELSE 0 END) AS empresas_risco_medio,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'BAIXO' THEN 1 ELSE 0 END) AS empresas_risco_baixo,\\r\\n    \\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_risco_critico,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_risco_alto,\\r\\n    \\r\\n    -- \\u2705 NOVOS: Contadores de Alertas\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'A\\u00c7\\u00c3O IMEDIATA' THEN 1 ELSE 0 END) AS alertas_acao_imediata,\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'MUITO URGENTE' THEN 1 ELSE 0 END) AS alertas_muito_urgente,\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'URGENTE' THEN 1 ELSE 0 END) AS alertas_urgente,\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'PRIORIDADE ALTA' THEN 1 ELSE 0 END) AS alertas_prioridade_alta,\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'MONITORAR' THEN 1 ELSE 0 END) AS alertas_monitorar,\\r\\n    \\r\\n    -- Scores\\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio_total,\\r\\n    ROUND(MAX(s.score_total), 2) AS score_maximo_total,\\r\\n    ROUND(AVG(s.score_comportamento), 2) AS score_medio_comportamento,\\r\\n    ROUND(AVG(s.score_credito), 2) AS score_medio_credito,\\r\\n    ROUND(AVG(s.score_indicios), 2) AS score_medio_indicios,\\r\\n    \\r\\n    -- \\u2705 NOVOS: Limiares calculados (para refer\\u00eancia)\\r\\n    MAX(s.limiar_critico_p99) AS limiar_critico_p99,\\r\\n    MAX(s.limiar_alto_p97) AS limiar_alto_p97,\\r\\n    MAX(s.limiar_urgente_p95) AS limiar_urgente_p95,\\r\\n    MAX(s.limiar_prioridade_p80) AS limiar_prioridade_p80,\\r\\n    MAX(s.limiar_medio_p50) AS limiar_medio_p50,\\r\\n    \\r\\n    -- Canceladas e Reincidentes\\r\\n    SUM(s.flag_atualmente_cancelada) AS empresas_ainda_canceladas,\\r\\n    COUNT(DISTINCT s.cnpj) - SUM(s.flag_atualmente_cancelada) AS empresas_reativadas,\\r\\n    ROUND(SUM(s.flag_atualmente_cancelada) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_ainda_canceladas,\\r\\n    \\r\\n    SUM(s.flag_empresa_reincidente) AS empresas_reincidentes,\\r\\n    ROUND(SUM(s.flag_empresa_reincidente) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_reincidentes,\\r\\n    \\r\\n    -- Saldos\\r\\n    SUM(s.saldo_credor_atual) AS saldo_credor_total,\\r\\n    ROUND(AVG(s.saldo_credor_atual), 2) AS saldo_credor_medio,\\r\\n    MAX(s.saldo_credor_atual) AS saldo_credor_maximo,\\r\\n    SUM(s.flag_saldo_alto_cancelada) AS empresas_saldo_alto_cancelada,\\r\\n    SUM(s.flag_suspeita_valores_repetidos) AS empresas_valores_suspeitos,\\r\\n    \\r\\n    -- \\u2705 NOVOS: Saldos por n\\u00edvel de alerta\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'A\\u00c7\\u00c3O IMEDIATA' THEN s.saldo_credor_atual ELSE 0 END) AS saldo_acao_imediata,\\r\\n    SUM(CASE WHEN s.nivel_alerta IN ('A\\u00c7\\u00c3O IMEDIATA', 'MUITO URGENTE') THEN s.saldo_credor_atual ELSE 0 END) AS saldo_alertas_urgentes,\\r\\n    \\r\\n    -- Ind\\u00edcios\\r\\n    SUM(s.flag_tem_indicios) AS empresas_com_indicios,\\r\\n    ROUND(SUM(s.flag_tem_indicios) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_com_indicios,\\r\\n    SUM(s.qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(s.qtde_indicios), 2) AS media_indicios_por_empresa,\\r\\n    SUM(s.flag_tem_indicios_graves) AS empresas_indicios_graves,\\r\\n    \\r\\n    -- Taxas\\r\\n    ROUND(AVG(s.taxa_permanencia_cancelamento_perc), 2) AS taxa_media_permanencia,\\r\\n    ROUND(AVG(s.taxa_reativacao_perc), 2) AS taxa_media_reativacao,\\r\\n    \\r\\n    SUM(CASE WHEN s.efetividade_cancelamento = 'EFETIVO' THEN 1 ELSE 0 END) AS qtde_cancelamentos_efetivos,\\r\\n    SUM(CASE WHEN s.efetividade_cancelamento = 'INEFETIVO' THEN 1 ELSE 0 END) AS qtde_cancelamentos_inefetivos,\\r\\n    \\r\\n    -- Autom\\u00e1ticos vs Manuais\\r\\n    SUM(m.qtde_automaticos) AS total_automaticos,\\r\\n    SUM(m.qtde_manuais) AS total_manuais,\\r\\n    ROUND(SUM(m.qtde_automaticos) * 100.0 / SUM(s.total_protocolos), 2) AS perc_automaticos\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nLEFT JOIN teste.luciano_metricas m ON s.cnpj = m.cnpj;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 9: LUCIANO_TOP100 (\\u2705 ATUALIZADA COM ALERTAS)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_top100;\\r\\n\\r\\nCREATE TABLE teste.luciano_top100 AS\\r\\nSELECT \\r\\n    s.ranking_fiscalizacao,\\r\\n    s.cnpj,\\r\\n    s.nome_contribuinte,\\r\\n    s.razao_social,\\r\\n    s.cd_cnae,\\r\\n    s.municipio,\\r\\n    s.uf,\\r\\n    s.gerencia_regional,\\r\\n    \\r\\n    s.classificacao_risco_final,\\r\\n    s.nivel_alerta,\\r\\n    s.prioridade_num,\\r\\n    \\r\\n    s.score_total,\\r\\n    s.score_comportamento,\\r\\n    s.score_credito,\\r\\n    s.score_indicios,\\r\\n    \\r\\n    s.total_protocolos,\\r\\n    s.taxa_permanencia_cancelamento_perc,\\r\\n    s.taxa_reativacao_perc,\\r\\n    s.classificacao_frequencia,\\r\\n    s.classificacao_persistencia,\\r\\n    s.efetividade_cancelamento,\\r\\n    \\r\\n    s.flag_empresa_reincidente,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    s.flag_saldo_alto_cancelada,\\r\\n    s.flag_suspeita_valores_repetidos,\\r\\n    s.flag_tem_indicios,\\r\\n    s.flag_tem_indicios_graves,\\r\\n    \\r\\n    s.saldo_credor_atual,\\r\\n    s.vl_credito_60m,\\r\\n    s.vl_credito_presumido_60m,\\r\\n    s.qtde_indicios,\\r\\n    s.soma_scores_indicios,\\r\\n    s.qtde_indicios_graves,\\r\\n    s.classificacao_risco_indicios,\\r\\n    \\r\\n    s.perc_valores_iguais_12m,\\r\\n    s.variacao_saldo_perc_60m,\\r\\n    \\r\\n    m.padrao_cancelamento_predominante,\\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nLEFT JOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nWHERE s.ranking_fiscalizacao <= 100\\r\\nORDER BY s.ranking_fiscalizacao;\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 10: LUCIANO_CONTABILISTA_BASE (mantida igual)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_base;\\r\\n\\r\\nCREATE TABLE teste.luciano_contabilista_base AS\\r\\nWITH contabilistas_empresas AS (\\r\\n    SELECT \\r\\n        -- Dados do contabilista\\r\\n        ods.nu_cpf_cnpj_contador AS cpf_cnpj_contador,\\r\\n        ods.nm_contador AS nome_contador,\\r\\n        ods.nu_crc_contador AS crc_contador,\\r\\n        ods.nm_email_contador AS email_contador,\\r\\n        ods.nu_telefone_contador AS telefone_contador,\\r\\n        ods.dt_ini_relac_contador AS data_inicio_relacao,\\r\\n        ods.cd_munic_contador AS cod_municipio_contador,\\r\\n        ods.nm_munic_contador AS municipio_contador,\\r\\n        ods.cd_uf_contador AS uf_contador,\\r\\n        \\r\\n        -- Dados da empresa\\r\\n        b.cnpj,\\r\\n        b.ie,\\r\\n        b.nome_contribuinte,\\r\\n        b.razao_social,\\r\\n        b.municipio,\\r\\n        b.gerencia_regional,\\r\\n        b.cd_cnae,\\r\\n        b.descricao_cnae,\\r\\n        b.tipo_contribuinte,\\r\\n        b.regime_apuracao,\\r\\n        \\r\\n        -- Dados do cancelamento\\r\\n        b.protocolo,\\r\\n        b.data_inicio_protocolo,\\r\\n        b.tipo_evento,\\r\\n        b.cod_motivo,\\r\\n        b.flag_cancelamento_automatico,\\r\\n        b.flag_ainda_cancelada,\\r\\n        b.flag_reativada,\\r\\n        b.nome_fiscal,\\r\\n        b.dias_desde_cancelamento,\\r\\n        \\r\\n        -- Scores (se dispon\\u00edveis)\\r\\n        s.score_total,\\r\\n        s.score_comportamento,\\r\\n        s.score_credito,\\r\\n        s.score_indicios,\\r\\n        s.classificacao_risco_final,\\r\\n        s.nivel_alerta,\\r\\n        s.saldo_credor_atual,\\r\\n        s.qtde_indicios,\\r\\n        s.qtde_indicios_graves\\r\\n        \\r\\n    FROM teste.luciano_base b\\r\\n    LEFT JOIN usr_sat_ods.vw_ods_contrib ods \\r\\n        ON b.cnpj = ods.nu_cnpj\\r\\n    LEFT JOIN teste.luciano_scores s\\r\\n        ON b.cnpj = s.cnpj\\r\\n    WHERE ods.nu_cpf_cnpj_contador IS NOT NULL\\r\\n        AND TRIM(ods.nu_cpf_cnpj_contador) != ''\\r\\n)\\r\\nSELECT * FROM contabilistas_empresas;\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- TABELA 11: CARTEIRA TOTAL DO CONTADOR (NOVA)\\r\\n-- ============================================================================\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_carteira;\\r\\nCREATE TABLE teste.luciano_contabilista_carteira AS\\r\\nSELECT \\r\\n    nu_cpf_cnpj_contador AS cpf_cnpj_contador,\\r\\n    nm_contador AS nome_contador,\\r\\n    nu_crc_contador AS crc_contador,\\r\\n    COUNT(DISTINCT nu_ie) AS total_empresas_carteira,\\r\\n    SUM(CASE WHEN cd_sit_cadastral = 1 THEN 1 ELSE 0 END) AS empresas_ativas_carteira,\\r\\n    SUM(CASE WHEN cd_sit_cadastral != 1 THEN 1 ELSE 0 END) AS empresas_nao_ativas_carteira\\r\\nFROM usr_sat_ods.vw_ods_contrib\\r\\nWHERE nu_cpf_cnpj_contador IS NOT NULL\\r\\n  AND TRIM(nu_cpf_cnpj_contador) != ''\\r\\nGROUP BY nu_cpf_cnpj_contador, nm_contador, nu_crc_contador;\\r\\n\\r\\n-- ============================================================================\\r\\n-- TABELA 12: M\\u00c9TRICAS DO CONTADOR (CORRIGIDA v3 - FINAL)\\r\\n-- ============================================================================\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_metricas;\\r\\nCREATE TABLE teste.luciano_contabilista_metricas AS\\r\\nSELECT \\r\\n    b.cpf_cnpj_contador,\\r\\n    b.nome_contador,\\r\\n    b.crc_contador,\\r\\n    b.municipio_contador,\\r\\n    b.uf_contador,\\r\\n    -- Total da carteira (JOIN com tabela de carteira)\\r\\n    COALESCE(cart.total_empresas_carteira, 0) AS total_empresas_carteira,\\r\\n    -- M\\u00e9tricas de cancelamento (flag vem da tabela de m\\u00e9tricas)\\r\\n    COUNT(DISTINCT b.cnpj) AS qtde_empresas_com_cancelamento,\\r\\n    SUM(CASE WHEN m.flag_atualmente_cancelada = 1 THEN 1 ELSE 0 END) AS qtde_empresas_ainda_canceladas,\\r\\n    SUM(CASE WHEN m.flag_atualmente_cancelada = 0 THEN 1 ELSE 0 END) AS qtde_empresas_reativadas,\\r\\n    -- TAXA DE EFETIVIDADE: empresas_ainda_canceladas / empresas_com_cancelamento\\r\\n    ROUND(\\r\\n        SUM(CASE WHEN m.flag_atualmente_cancelada = 1 THEN 1 ELSE 0 END) * 100.0 / \\r\\n        NULLIF(COUNT(DISTINCT b.cnpj), 0), \\r\\n        2\\r\\n    ) AS taxa_efetividade_perc,\\r\\n    -- TAXA CANCELAMENTO CARTEIRA: empresas_ainda_canceladas / total_empresas_carteira\\r\\n    ROUND(\\r\\n        SUM(CASE WHEN m.flag_atualmente_cancelada = 1 THEN 1 ELSE 0 END) * 100.0 / \\r\\n        NULLIF(COALESCE(cart.total_empresas_carteira, 0), 0), \\r\\n        2\\r\\n    ) AS taxa_cancelamento_carteira_perc,\\r\\n    -- Classifica\\u00e7\\u00e3o de risco das empresas\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS qtde_empresas_risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS qtde_empresas_risco_alto,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'M\\u00c9DIO' THEN 1 ELSE 0 END) AS qtde_empresas_risco_medio,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'BAIXO' THEN 1 ELSE 0 END) AS qtde_empresas_risco_baixo,\\r\\n    -- Financeiro (da tabela de cr\\u00e9dito)\\r\\n    SUM(COALESCE(c.saldo_credor_atual, 0)) AS saldo_credor_total,\\r\\n    SUM(COALESCE(c.vl_credito_60m, 0)) AS vlr_creditos_total,\\r\\n    -- Ind\\u00edcios\\r\\n    SUM(COALESCE(i.qtde_indicios, 0)) AS total_indicios,\\r\\n    SUM(COALESCE(i.qtde_indicios_graves, 0)) AS total_indicios_graves\\r\\nFROM teste.luciano_contabilista_base b\\r\\nLEFT JOIN teste.luciano_metricas m ON b.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON b.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_scores s ON b.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON b.cnpj = i.cnpj\\r\\nLEFT JOIN teste.luciano_contabilista_carteira cart ON b.cpf_cnpj_contador = cart.cpf_cnpj_contador\\r\\nGROUP BY \\r\\n    b.cpf_cnpj_contador, b.nome_contador, b.crc_contador, \\r\\n    b.municipio_contador, b.uf_contador, cart.total_empresas_carteira;\\r\\n\\r\\n-- ============================================================================\\r\\n-- TABELA 13: SCORES DO CONTADOR\\r\\n-- ============================================================================\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_scores;\\r\\nCREATE TABLE teste.luciano_contabilista_scores AS\\r\\nSELECT \\r\\n    m.*,\\r\\n    -- Score de Volume (0-30)\\r\\n    LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) AS score_volume,\\r\\n    -- Score de Concentra\\u00e7\\u00e3o (0-25)\\r\\n    LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) AS score_concentracao,\\r\\n    -- Score de Risco das Empresas (0-25)\\r\\n    LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) AS score_risco_empresas,\\r\\n    -- Score Financeiro (0-20)\\r\\n    LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) AS score_financeiro,\\r\\n    -- Score Total (0-100)\\r\\n    LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n    LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n    LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n    LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) AS score_total_contador,\\r\\n    -- Ranking\\r\\n    ROW_NUMBER() OVER (ORDER BY \\r\\n        LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n        LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n        LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n        LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) DESC\\r\\n    ) AS ranking_contador,\\r\\n    -- Percentil\\r\\n    NTILE(100) OVER (ORDER BY \\r\\n        LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n        LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n        LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n        LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n    ) AS percentil_contador,\\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 95 THEN 'CR\\u00cdTICO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 90 THEN 'ALTO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 75 THEN 'M\\u00c9DIO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 50 THEN 'BAIXO'\\r\\n        ELSE 'MUITO BAIXO'\\r\\n    END AS classificacao_risco_contador,\\r\\n    -- N\\u00edvel de Alerta\\r\\n    CASE\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 95 AND (m.qtde_empresas_risco_critico >= 2 OR m.saldo_credor_total > 1000000) THEN 'INVESTIGAR'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 90 THEN 'ATEN\\u00c7\\u00c3O ESPECIAL'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 75 THEN 'MONITORAR'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS nivel_alerta_contador\\r\\nFROM teste.luciano_contabilista_metricas m;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 13: LUCIANO_CONTABILISTA_TOP50\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_top50;\\r\\n\\r\\nCREATE TABLE teste.luciano_contabilista_top50 AS\\r\\nSELECT *\\r\\nFROM teste.luciano_contabilista_scores\\r\\nWHERE ranking_contador <= 50\\r\\nORDER BY ranking_contador;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- VERIFICA\\u00c7\\u00c3O\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT 'RESUMO GERAL' AS analise,\\r\\n    COUNT(*) AS total_contadores,\\r\\n    SUM(total_empresas_carteira) AS total_empresas_carteira,\\r\\n    SUM(qtde_empresas_ainda_canceladas) AS total_canceladas,\\r\\n    ROUND(AVG(taxa_efetividade_perc), 2) AS media_taxa_efetividade,\\r\\n    ROUND(AVG(taxa_cancelamento_carteira_perc), 2) AS media_taxa_cancel_carteira\\r\\nFROM teste.luciano_contabilista_scores;\\r\\n\\r\\nSELECT 'TOP 10 POR TAXA CANCELAMENTO CARTEIRA (PIORES)' AS analise,\\r\\n    ranking_contador,\\r\\n    nome_contador,\\r\\n    total_empresas_carteira,\\r\\n    qtde_empresas_ainda_canceladas,\\r\\n    taxa_cancelamento_carteira_perc,\\r\\n    taxa_efetividade_perc,\\r\\n    classificacao_risco_contador\\r\\nFROM teste.luciano_contabilista_scores\\r\\nORDER BY taxa_cancelamento_carteira_perc DESC\\r\\nLIMIT 10;\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O RISCO' AS analise, \\r\\n    classificacao_risco_contador, \\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(AVG(taxa_cancelamento_carteira_perc), 2) AS media_taxa_cancel_carteira,\\r\\n    ROUND(AVG(taxa_efetividade_perc), 2) AS media_taxa_efetividade\\r\\nFROM teste.luciano_contabilista_scores\\r\\nGROUP BY classificacao_risco_contador\\r\\nORDER BY \\r\\n    CASE classificacao_risco_contador\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n        ELSE 5\\r\\n    END;\\r\\n\\r\\n-- =====================================================================\\r\\n-- VERIFICA\\u00c7\\u00c3O FINAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O DE RISCO' AS analise, classificacao_risco_final, COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.luciano_scores\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        ELSE 4\\r\\n    END;\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O DE ALERTAS' AS analise, nivel_alerta, COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.luciano_scores\\r\\nGROUP BY nivel_alerta\\r\\nORDER BY MIN(prioridade_num);\\r\\n\\r\\nSELECT 'LIMIARES CALCULADOS' AS analise,\\r\\n    MAX(limiar_critico_p99) AS limiar_critico_p99,\\r\\n    MAX(limiar_alto_p97) AS limiar_alto_p97,\\r\\n    MAX(limiar_urgente_p95) AS limiar_urgente_p95,\\r\\n    MAX(limiar_prioridade_p80) AS limiar_prioridade_p80,\\r\\n    MAX(limiar_medio_p50) AS limiar_medio_p50\\r\\nFROM teste.luciano_scores;\\r\\n\\r\\n-- Verificar ind\\u00edcios graves (CORRE\\u00c7\\u00c3O)\\r\\nSELECT 'IND\\u00cdCIOS GRAVES' AS analise,\\r\\n    SUM(CASE WHEN qtde_indicios_graves >= 1 THEN 1 ELSE 0 END) AS empresas_indicios_graves_1,\\r\\n    SUM(CASE WHEN qtde_indicios_graves >= 2 THEN 1 ELSE 0 END) AS empresas_indicios_graves_2,\\r\\n    SUM(CASE WHEN qtde_indicios_graves >= 3 THEN 1 ELSE 0 END) AS empresas_indicios_graves_3\\r\\nFROM teste.luciano_indicios;\", \"statementsList\": [\"\\r\\n\\r\\nCREATE TABLE teste.luciano_resumo AS\\r\\nSELECT \\r\\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE) AS data_atualizacao,\\r\\n    \\r\\n    COUNT(DISTINCT s.cnpj) AS total_empresas,\\r\\n    SUM(s.total_protocolos) AS total_protocolos,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o de Risco (com percentis)\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS empresas_risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS empresas_risco_alto,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'M\\u00c9DIO' THEN 1 ELSE 0 END) AS empresas_risco_medio,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'BAIXO' THEN 1 ELSE 0 END) AS empresas_risco_baixo,\\r\\n    \\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_risco_critico,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_risco_alto,\\r\\n    \\r\\n    -- \\u2705 NOVOS: Contadores de Alertas\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'A\\u00c7\\u00c3O IMEDIATA' THEN 1 ELSE 0 END) AS alertas_acao_imediata,\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'MUITO URGENTE' THEN 1 ELSE 0 END) AS alertas_muito_urgente,\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'URGENTE' THEN 1 ELSE 0 END) AS alertas_urgente,\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'PRIORIDADE ALTA' THEN 1 ELSE 0 END) AS alertas_prioridade_alta,\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'MONITORAR' THEN 1 ELSE 0 END) AS alertas_monitorar,\\r\\n    \\r\\n    -- Scores\\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio_total,\\r\\n    ROUND(MAX(s.score_total), 2) AS score_maximo_total,\\r\\n    ROUND(AVG(s.score_comportamento), 2) AS score_medio_comportamento,\\r\\n    ROUND(AVG(s.score_credito), 2) AS score_medio_credito,\\r\\n    ROUND(AVG(s.score_indicios), 2) AS score_medio_indicios,\\r\\n    \\r\\n    -- \\u2705 NOVOS: Limiares calculados (para refer\\u00eancia)\\r\\n    MAX(s.limiar_critico_p99) AS limiar_critico_p99,\\r\\n    MAX(s.limiar_alto_p97) AS limiar_alto_p97,\\r\\n    MAX(s.limiar_urgente_p95) AS limiar_urgente_p95,\\r\\n    MAX(s.limiar_prioridade_p80) AS limiar_prioridade_p80,\\r\\n    MAX(s.limiar_medio_p50) AS limiar_medio_p50,\\r\\n    \\r\\n    -- Canceladas e Reincidentes\\r\\n    SUM(s.flag_atualmente_cancelada) AS empresas_ainda_canceladas,\\r\\n    COUNT(DISTINCT s.cnpj) - SUM(s.flag_atualmente_cancelada) AS empresas_reativadas,\\r\\n    ROUND(SUM(s.flag_atualmente_cancelada) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_ainda_canceladas,\\r\\n    \\r\\n    SUM(s.flag_empresa_reincidente) AS empresas_reincidentes,\\r\\n    ROUND(SUM(s.flag_empresa_reincidente) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_reincidentes,\\r\\n    \\r\\n    -- Saldos\\r\\n    SUM(s.saldo_credor_atual) AS saldo_credor_total,\\r\\n    ROUND(AVG(s.saldo_credor_atual), 2) AS saldo_credor_medio,\\r\\n    MAX(s.saldo_credor_atual) AS saldo_credor_maximo,\\r\\n    SUM(s.flag_saldo_alto_cancelada) AS empresas_saldo_alto_cancelada,\\r\\n    SUM(s.flag_suspeita_valores_repetidos) AS empresas_valores_suspeitos,\\r\\n    \\r\\n    -- \\u2705 NOVOS: Saldos por n\\u00edvel de alerta\\r\\n    SUM(CASE WHEN s.nivel_alerta = 'A\\u00c7\\u00c3O IMEDIATA' THEN s.saldo_credor_atual ELSE 0 END) AS saldo_acao_imediata,\\r\\n    SUM(CASE WHEN s.nivel_alerta IN ('A\\u00c7\\u00c3O IMEDIATA', 'MUITO URGENTE') THEN s.saldo_credor_atual ELSE 0 END) AS saldo_alertas_urgentes,\\r\\n    \\r\\n    -- Ind\\u00edcios\\r\\n    SUM(s.flag_tem_indicios) AS empresas_com_indicios,\\r\\n    ROUND(SUM(s.flag_tem_indicios) * 100.0 / COUNT(DISTINCT s.cnpj), 2) AS perc_com_indicios,\\r\\n    SUM(s.qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(s.qtde_indicios), 2) AS media_indicios_por_empresa,\\r\\n    SUM(s.flag_tem_indicios_graves) AS empresas_indicios_graves,\\r\\n    \\r\\n    -- Taxas\\r\\n    ROUND(AVG(s.taxa_permanencia_cancelamento_perc), 2) AS taxa_media_permanencia,\\r\\n    ROUND(AVG(s.taxa_reativacao_perc), 2) AS taxa_media_reativacao,\\r\\n    \\r\\n    SUM(CASE WHEN s.efetividade_cancelamento = 'EFETIVO' THEN 1 ELSE 0 END) AS qtde_cancelamentos_efetivos,\\r\\n    SUM(CASE WHEN s.efetividade_cancelamento = 'INEFETIVO' THEN 1 ELSE 0 END) AS qtde_cancelamentos_inefetivos,\\r\\n    \\r\\n    -- Autom\\u00e1ticos vs Manuais\\r\\n    SUM(m.qtde_automaticos) AS total_automaticos,\\r\\n    SUM(m.qtde_manuais) AS total_manuais,\\r\\n    ROUND(SUM(m.qtde_automaticos) * 100.0 / SUM(s.total_protocolos), 2) AS perc_automaticos\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nLEFT JOIN teste.luciano_metricas m ON s.cnpj = m.cnpj;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 9: LUCIANO_TOP100 (\\u2705 ATUALIZADA COM ALERTAS)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_top100;\", \"\\r\\n\\r\\nCREATE TABLE teste.luciano_top100 AS\\r\\nSELECT \\r\\n    s.ranking_fiscalizacao,\\r\\n    s.cnpj,\\r\\n    s.nome_contribuinte,\\r\\n    s.razao_social,\\r\\n    s.cd_cnae,\\r\\n    s.municipio,\\r\\n    s.uf,\\r\\n    s.gerencia_regional,\\r\\n    \\r\\n    s.classificacao_risco_final,\\r\\n    s.nivel_alerta,\\r\\n    s.prioridade_num,\\r\\n    \\r\\n    s.score_total,\\r\\n    s.score_comportamento,\\r\\n    s.score_credito,\\r\\n    s.score_indicios,\\r\\n    \\r\\n    s.total_protocolos,\\r\\n    s.taxa_permanencia_cancelamento_perc,\\r\\n    s.taxa_reativacao_perc,\\r\\n    s.classificacao_frequencia,\\r\\n    s.classificacao_persistencia,\\r\\n    s.efetividade_cancelamento,\\r\\n    \\r\\n    s.flag_empresa_reincidente,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    s.flag_saldo_alto_cancelada,\\r\\n    s.flag_suspeita_valores_repetidos,\\r\\n    s.flag_tem_indicios,\\r\\n    s.flag_tem_indicios_graves,\\r\\n    \\r\\n    s.saldo_credor_atual,\\r\\n    s.vl_credito_60m,\\r\\n    s.vl_credito_presumido_60m,\\r\\n    s.qtde_indicios,\\r\\n    s.soma_scores_indicios,\\r\\n    s.qtde_indicios_graves,\\r\\n    s.classificacao_risco_indicios,\\r\\n    \\r\\n    s.perc_valores_iguais_12m,\\r\\n    s.variacao_saldo_perc_60m,\\r\\n    \\r\\n    m.padrao_cancelamento_predominante,\\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nLEFT JOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nWHERE s.ranking_fiscalizacao <= 100\\r\\nORDER BY s.ranking_fiscalizacao;\", \"\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 10: LUCIANO_CONTABILISTA_BASE (mantida igual)\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_base;\", \"\\r\\n\\r\\nCREATE TABLE teste.luciano_contabilista_base AS\\r\\nWITH contabilistas_empresas AS (\\r\\n    SELECT \\r\\n        -- Dados do contabilista\\r\\n        ods.nu_cpf_cnpj_contador AS cpf_cnpj_contador,\\r\\n        ods.nm_contador AS nome_contador,\\r\\n        ods.nu_crc_contador AS crc_contador,\\r\\n        ods.nm_email_contador AS email_contador,\\r\\n        ods.nu_telefone_contador AS telefone_contador,\\r\\n        ods.dt_ini_relac_contador AS data_inicio_relacao,\\r\\n        ods.cd_munic_contador AS cod_municipio_contador,\\r\\n        ods.nm_munic_contador AS municipio_contador,\\r\\n        ods.cd_uf_contador AS uf_contador,\\r\\n        \\r\\n        -- Dados da empresa\\r\\n        b.cnpj,\\r\\n        b.ie,\\r\\n        b.nome_contribuinte,\\r\\n        b.razao_social,\\r\\n        b.municipio,\\r\\n        b.gerencia_regional,\\r\\n        b.cd_cnae,\\r\\n        b.descricao_cnae,\\r\\n        b.tipo_contribuinte,\\r\\n        b.regime_apuracao,\\r\\n        \\r\\n        -- Dados do cancelamento\\r\\n        b.protocolo,\\r\\n        b.data_inicio_protocolo,\\r\\n        b.tipo_evento,\\r\\n        b.cod_motivo,\\r\\n        b.flag_cancelamento_automatico,\\r\\n        b.flag_ainda_cancelada,\\r\\n        b.flag_reativada,\\r\\n        b.nome_fiscal,\\r\\n        b.dias_desde_cancelamento,\\r\\n        \\r\\n        -- Scores (se dispon\\u00edveis)\\r\\n        s.score_total,\\r\\n        s.score_comportamento,\\r\\n        s.score_credito,\\r\\n        s.score_indicios,\\r\\n        s.classificacao_risco_final,\\r\\n        s.nivel_alerta,\\r\\n        s.saldo_credor_atual,\\r\\n        s.qtde_indicios,\\r\\n        s.qtde_indicios_graves\\r\\n        \\r\\n    FROM teste.luciano_base b\\r\\n    LEFT JOIN usr_sat_ods.vw_ods_contrib ods \\r\\n        ON b.cnpj = ods.nu_cnpj\\r\\n    LEFT JOIN teste.luciano_scores s\\r\\n        ON b.cnpj = s.cnpj\\r\\n    WHERE ods.nu_cpf_cnpj_contador IS NOT NULL\\r\\n        AND TRIM(ods.nu_cpf_cnpj_contador) != ''\\r\\n)\\r\\nSELECT * FROM contabilistas_empresas;\", \"\\r\\n\\r\\n\\r\\n-- ============================================================================\\r\\n-- TABELA 11: CARTEIRA TOTAL DO CONTADOR (NOVA)\\r\\n-- ============================================================================\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_carteira;\", \"\\r\\nCREATE TABLE teste.luciano_contabilista_carteira AS\\r\\nSELECT \\r\\n    nu_cpf_cnpj_contador AS cpf_cnpj_contador,\\r\\n    nm_contador AS nome_contador,\\r\\n    nu_crc_contador AS crc_contador,\\r\\n    COUNT(DISTINCT nu_ie) AS total_empresas_carteira,\\r\\n    SUM(CASE WHEN cd_sit_cadastral = 1 THEN 1 ELSE 0 END) AS empresas_ativas_carteira,\\r\\n    SUM(CASE WHEN cd_sit_cadastral != 1 THEN 1 ELSE 0 END) AS empresas_nao_ativas_carteira\\r\\nFROM usr_sat_ods.vw_ods_contrib\\r\\nWHERE nu_cpf_cnpj_contador IS NOT NULL\\r\\n  AND TRIM(nu_cpf_cnpj_contador) != ''\\r\\nGROUP BY nu_cpf_cnpj_contador, nm_contador, nu_crc_contador;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- TABELA 12: M\\u00c9TRICAS DO CONTADOR (CORRIGIDA v3 - FINAL)\\r\\n-- ============================================================================\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_metricas;\", \"\\r\\nCREATE TABLE teste.luciano_contabilista_metricas AS\\r\\nSELECT \\r\\n    b.cpf_cnpj_contador,\\r\\n    b.nome_contador,\\r\\n    b.crc_contador,\\r\\n    b.municipio_contador,\\r\\n    b.uf_contador,\\r\\n    -- Total da carteira (JOIN com tabela de carteira)\\r\\n    COALESCE(cart.total_empresas_carteira, 0) AS total_empresas_carteira,\\r\\n    -- M\\u00e9tricas de cancelamento (flag vem da tabela de m\\u00e9tricas)\\r\\n    COUNT(DISTINCT b.cnpj) AS qtde_empresas_com_cancelamento,\\r\\n    SUM(CASE WHEN m.flag_atualmente_cancelada = 1 THEN 1 ELSE 0 END) AS qtde_empresas_ainda_canceladas,\\r\\n    SUM(CASE WHEN m.flag_atualmente_cancelada = 0 THEN 1 ELSE 0 END) AS qtde_empresas_reativadas,\\r\\n    -- TAXA DE EFETIVIDADE: empresas_ainda_canceladas / empresas_com_cancelamento\\r\\n    ROUND(\\r\\n        SUM(CASE WHEN m.flag_atualmente_cancelada = 1 THEN 1 ELSE 0 END) * 100.0 / \\r\\n        NULLIF(COUNT(DISTINCT b.cnpj), 0), \\r\\n        2\\r\\n    ) AS taxa_efetividade_perc,\\r\\n    -- TAXA CANCELAMENTO CARTEIRA: empresas_ainda_canceladas / total_empresas_carteira\\r\\n    ROUND(\\r\\n        SUM(CASE WHEN m.flag_atualmente_cancelada = 1 THEN 1 ELSE 0 END) * 100.0 / \\r\\n        NULLIF(COALESCE(cart.total_empresas_carteira, 0), 0), \\r\\n        2\\r\\n    ) AS taxa_cancelamento_carteira_perc,\\r\\n    -- Classifica\\u00e7\\u00e3o de risco das empresas\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS qtde_empresas_risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS qtde_empresas_risco_alto,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'M\\u00c9DIO' THEN 1 ELSE 0 END) AS qtde_empresas_risco_medio,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'BAIXO' THEN 1 ELSE 0 END) AS qtde_empresas_risco_baixo,\\r\\n    -- Financeiro (da tabela de cr\\u00e9dito)\\r\\n    SUM(COALESCE(c.saldo_credor_atual, 0)) AS saldo_credor_total,\\r\\n    SUM(COALESCE(c.vl_credito_60m, 0)) AS vlr_creditos_total,\\r\\n    -- Ind\\u00edcios\\r\\n    SUM(COALESCE(i.qtde_indicios, 0)) AS total_indicios,\\r\\n    SUM(COALESCE(i.qtde_indicios_graves, 0)) AS total_indicios_graves\\r\\nFROM teste.luciano_contabilista_base b\\r\\nLEFT JOIN teste.luciano_metricas m ON b.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON b.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_scores s ON b.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON b.cnpj = i.cnpj\\r\\nLEFT JOIN teste.luciano_contabilista_carteira cart ON b.cpf_cnpj_contador = cart.cpf_cnpj_contador\\r\\nGROUP BY \\r\\n    b.cpf_cnpj_contador, b.nome_contador, b.crc_contador, \\r\\n    b.municipio_contador, b.uf_contador, cart.total_empresas_carteira;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- TABELA 13: SCORES DO CONTADOR\\r\\n-- ============================================================================\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_scores;\", \"\\r\\nCREATE TABLE teste.luciano_contabilista_scores AS\\r\\nSELECT \\r\\n    m.*,\\r\\n    -- Score de Volume (0-30)\\r\\n    LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) AS score_volume,\\r\\n    -- Score de Concentra\\u00e7\\u00e3o (0-25)\\r\\n    LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) AS score_concentracao,\\r\\n    -- Score de Risco das Empresas (0-25)\\r\\n    LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) AS score_risco_empresas,\\r\\n    -- Score Financeiro (0-20)\\r\\n    LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) AS score_financeiro,\\r\\n    -- Score Total (0-100)\\r\\n    LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n    LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n    LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n    LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) AS score_total_contador,\\r\\n    -- Ranking\\r\\n    ROW_NUMBER() OVER (ORDER BY \\r\\n        LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n        LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n        LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n        LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) DESC\\r\\n    ) AS ranking_contador,\\r\\n    -- Percentil\\r\\n    NTILE(100) OVER (ORDER BY \\r\\n        LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n        LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n        LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n        LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n    ) AS percentil_contador,\\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 95 THEN 'CR\\u00cdTICO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 90 THEN 'ALTO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 75 THEN 'M\\u00c9DIO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 50 THEN 'BAIXO'\\r\\n        ELSE 'MUITO BAIXO'\\r\\n    END AS classificacao_risco_contador,\\r\\n    -- N\\u00edvel de Alerta\\r\\n    CASE\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 95 AND (m.qtde_empresas_risco_critico >= 2 OR m.saldo_credor_total > 1000000) THEN 'INVESTIGAR'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 90 THEN 'ATEN\\u00c7\\u00c3O ESPECIAL'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 75 THEN 'MONITORAR'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS nivel_alerta_contador\\r\\nFROM teste.luciano_contabilista_metricas m;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- TABELA 13: LUCIANO_CONTABILISTA_TOP50\\r\\n-- =====================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.luciano_contabilista_top50;\", \"\\r\\n\\r\\nCREATE TABLE teste.luciano_contabilista_top50 AS\\r\\nSELECT *\\r\\nFROM teste.luciano_contabilista_scores\\r\\nWHERE ranking_contador <= 50\\r\\nORDER BY ranking_contador;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- VERIFICA\\u00c7\\u00c3O\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT 'RESUMO GERAL' AS analise,\\r\\n    COUNT(*) AS total_contadores,\\r\\n    SUM(total_empresas_carteira) AS total_empresas_carteira,\\r\\n    SUM(qtde_empresas_ainda_canceladas) AS total_canceladas,\\r\\n    ROUND(AVG(taxa_efetividade_perc), 2) AS media_taxa_efetividade,\\r\\n    ROUND(AVG(taxa_cancelamento_carteira_perc), 2) AS media_taxa_cancel_carteira\\r\\nFROM teste.luciano_contabilista_scores;\", \"\\r\\n\\r\\nSELECT 'TOP 10 POR TAXA CANCELAMENTO CARTEIRA (PIORES)' AS analise,\\r\\n    ranking_contador,\\r\\n    nome_contador,\\r\\n    total_empresas_carteira,\\r\\n    qtde_empresas_ainda_canceladas,\\r\\n    taxa_cancelamento_carteira_perc,\\r\\n    taxa_efetividade_perc,\\r\\n    classificacao_risco_contador\\r\\nFROM teste.luciano_contabilista_scores\\r\\nORDER BY taxa_cancelamento_carteira_perc DESC\\r\\nLIMIT 10;\", \"\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O RISCO' AS analise, \\r\\n    classificacao_risco_contador, \\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(AVG(taxa_cancelamento_carteira_perc), 2) AS media_taxa_cancel_carteira,\\r\\n    ROUND(AVG(taxa_efetividade_perc), 2) AS media_taxa_efetividade\\r\\nFROM teste.luciano_contabilista_scores\\r\\nGROUP BY classificacao_risco_contador\\r\\nORDER BY \\r\\n    CASE classificacao_risco_contador\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n        ELSE 5\\r\\n    END;\", \"\\r\\n\\r\\n-- =====================================================================\\r\\n-- VERIFICA\\u00c7\\u00c3O FINAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O DE RISCO' AS analise, classificacao_risco_final, COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.luciano_scores\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        ELSE 4\\r\\n    END;\", \"\\r\\n\\r\\nSELECT 'DISTRIBUI\\u00c7\\u00c3O DE ALERTAS' AS analise, nivel_alerta, COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.luciano_scores\\r\\nGROUP BY nivel_alerta\\r\\nORDER BY MIN(prioridade_num);\", \"\\r\\n\\r\\nSELECT 'LIMIARES CALCULADOS' AS analise,\\r\\n    MAX(limiar_critico_p99) AS limiar_critico_p99,\\r\\n    MAX(limiar_alto_p97) AS limiar_alto_p97,\\r\\n    MAX(limiar_urgente_p95) AS limiar_urgente_p95,\\r\\n    MAX(limiar_prioridade_p80) AS limiar_prioridade_p80,\\r\\n    MAX(limiar_medio_p50) AS limiar_medio_p50\\r\\nFROM teste.luciano_scores;\", \"\\r\\n\\r\\n-- Verificar ind\\u00edcios graves (CORRE\\u00c7\\u00c3O)\\r\\nSELECT 'IND\\u00cdCIOS GRAVES' AS analise,\\r\\n    SUM(CASE WHEN qtde_indicios_graves >= 1 THEN 1 ELSE 0 END) AS empresas_indicios_graves_1,\\r\\n    SUM(CASE WHEN qtde_indicios_graves >= 2 THEN 1 ELSE 0 END) AS empresas_indicios_graves_2,\\r\\n    SUM(CASE WHEN qtde_indicios_graves >= 3 THEN 1 ELSE 0 END) AS empresas_indicios_graves_3\\r\\nFROM teste.luciano_indicios;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Example: SELECT * FROM tablename, or press CTRL + space\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\nCREATE TABLE teste.luciano_contabilista_scores AS\\r\\nSELECT \\r\\n    m.*,\\r\\n    -- Score de Volume (0-30)\\r\\n    LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) AS score_volume,\\r\\n    -- Score de Concentra\\u00e7\\u00e3o (0-25)\\r\\n    LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) AS score_concentracao,\\r\\n    -- Score de Risco das Empresas (0-25)\\r\\n    LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) AS score_risco_empresas,\\r\\n    -- Score Financeiro (0-20)\\r\\n    LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) AS score_financeiro,\\r\\n    -- Score Total (0-100)\\r\\n    LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n    LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n    LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n    LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) AS score_total_contador,\\r\\n    -- Ranking\\r\\n    ROW_NUMBER() OVER (ORDER BY \\r\\n        LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n        LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n        LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n        LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0)) DESC\\r\\n    ) AS ranking_contador,\\r\\n    -- Percentil\\r\\n    NTILE(100) OVER (ORDER BY \\r\\n        LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n        LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n        LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n        LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n    ) AS percentil_contador,\\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 95 THEN 'CR\\u00cdTICO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 90 THEN 'ALTO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 75 THEN 'M\\u00c9DIO'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 50 THEN 'BAIXO'\\r\\n        ELSE 'MUITO BAIXO'\\r\\n    END AS classificacao_risco_contador,\\r\\n    -- N\\u00edvel de Alerta\\r\\n    CASE\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 95 AND (m.qtde_empresas_risco_critico >= 2 OR m.saldo_credor_total > 1000000) THEN 'INVESTIGAR'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 90 THEN 'ATEN\\u00c7\\u00c3O ESPECIAL'\\r\\n        WHEN NTILE(100) OVER (ORDER BY \\r\\n            LEAST(30, ROUND(m.qtde_empresas_ainda_canceladas * 3.0, 0)) +\\r\\n            LEAST(25, ROUND(COALESCE(m.taxa_cancelamento_carteira_perc, 0) * 0.5, 0)) +\\r\\n            LEAST(25, (COALESCE(m.qtde_empresas_risco_critico, 0) * 5 + COALESCE(m.qtde_empresas_risco_alto, 0) * 2)) +\\r\\n            LEAST(20, ROUND(COALESCE(m.saldo_credor_total, 0) / 500000.0, 0))\\r\\n        ) >= 75 THEN 'MONITORAR'\\r\\n        ELSE 'NORMAL'\\r\\n    END AS nivel_alerta_contador\\r\\nFROM teste.luciano_contabilista_metricas m;\", \"result\": {\"id\": \"6ecb3e6d-717a-661e-f75b-6882270794cc\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"q9ifCKRXQGSiwKUOjLxDEw==\", \"guid\": \"V1fQRkHrQS4AAAAAYR4TYw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"8c4bed5375d43da3:f94d3d5b07033c87\", \"session_id\": 23351, \"session_type\": \"impala\", \"statement_id\": 6, \"has_more_statements\": true, \"statements_count\": 13, \"previous_statement_hash\": \"fa84a8841fa8f85726e191129ce18d14677c2524429f2fa1783b5762\", \"start\": {\"row\": 151, \"column\": 0}, \"end\": {\"row\": 161, \"column\": 39}, \"statement\": \"-- =====================================================================\\n-- VERIFICA\\u00c7\\u00c3O\\n-- =====================================================================\\n\\nSELECT 'RESUMO GERAL' AS analise,\\n    COUNT(*) AS total_contadores,\\n    SUM(total_empresas_carteira) AS total_empresas_carteira,\\n    SUM(qtde_empresas_ainda_canceladas) AS total_canceladas,\\n    ROUND(AVG(taxa_efetividade_perc), 2) AS media_taxa_efetividade,\\n    ROUND(AVG(taxa_cancelamento_carteira_perc), 2) AS media_taxa_cancel_carteira\\nFROM teste.luciano_contabilista_scores\"}, \"meta\": [], \"rows\": 1, \"hasMore\": false, \"statement_id\": 6, \"statement_range\": {\"start\": {\"row\": 151, \"column\": 0}, \"end\": {\"row\": 161, \"column\": 39}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-12-01T21:21:10.245Z\", \"endTime\": \"2025-12-01T21:21:10.440Z\", \"executionTime\": 195, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"analise\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"total_empresas_carteira\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"analise\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"total_empresas_carteira\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1764624069952, \"lastAceSelectionRowOffset\": 1099, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 225, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- =====================================================================\r\n-- PROJETO LUCIANO - VERSO 2.0 (LIMIARES PERCENTIS + INDCIOS CORRIGIDOS)\r\n-- =====================================================================\r\n-- ALTERAES IMPLEMENTADAS:\r\n-- 1. Classificao de Risco: CRTICO (Top 1%), ALTO (Top 3%), MDIO (Top 50%), BAIXO (Restante)\r\n-- 2. Alertas: AO IMEDIATA (critrio atual), MUITO URGENTE (Top 3%), URGENTE (Top 5%), \r\n--             PRIORIDADE ALTA (Top 20%), MONITORAR (Restante)\r\n-- 3. Indcios Graves: Ajustado limiar para score >= 100 (antes era > 200)\r\n-- =====================================================================\r\n\r\n\r\n-- =====================================================================\r\n-- TABELA 1: LUCIANO_BASE (SEM ALTERAES)\r\n-- =====================================================================\r\n\r\nDROP TABLE IF EXISTS teste.luciano_base;\r\n\r\nCREATE TABLE teste.luciano_base AS\r\nWITH data_referencia AS (\r\n    SELECT \r\n        CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE) AS data_hoje,\r\n        ADD_MONTHS(CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS DATE), -60) AS data_60m_atras\r\n),\r\nprotocolos_enriquecidos AS (\r\n    SELECT \r\n        -- Dados do protocolo\r\n        p.rpr_protocolo AS protocolo,\r\n        p.rpr_rge_ruc AS ie_original,\r\n        p.rpr_dt_inicio AS data_inicio_protocolo,\r\n        p.rpr_dt_processo AS data_processamento,\r\n        p.rpr_parecer AS parecer,\r\n        \r\n        -- Eventos e Motivos\r\n        p.rpr_tge_vevento AS cod_evento,\r\n        CASE \r\n            WHEN p.rpr_tge_vevento = 1 THEN 'CANCELAMENTO'\r\n            WHEN p.rpr_tge_vevento = 3 THEN 'REATIVACAO_EXCLUSAO'\r\n            WHEN p.rpr_tge_vevento = 5 THEN 'REATIVACAO_AUTOMATICA'\r\n            ELSE 'OUTRO'\r\n        END AS tipo_evento,\r\n        \r\n        p.rpr_tge_vmotivo AS cod_motivo,\r\n        \r\n        -- Identificao do usurio\r\n        p.rpr_tus_cod_usr_inicio AS cod_usuario_inicio,\r\n        CASE \r\n            WHEN p.rpr_tus_cod_usr_inicio LIKE 'SAT%' T",
    "last_modified": "2025-12-11T23:39:09.961",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "638b4b71-396e-44c4-bbc5-e56afe09dddd",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 178003,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "LUCIANO: Analises",
    "description": "",
    "uuid": "43af7546-6acd-48ae-7492-475aa7518720",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 178003, \"uuid\": \"43af7546-6acd-48ae-7492-475aa7518720\", \"name\": \"LUCIANO: Analises\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"37c1bfc3-8c34-b7d4-fb45-f1fc3717ba82\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 1137, \"column\": 72}, \"errors\": [{\"message\": \"ParseException: Syntax error in line 1031:undefined:\\n...==========================\\n                            ^\\nEncountered: EOF\\nExpected: ALTER, COMMENT, COMPUTE, COPY, CREATE, DELETE, DESCRIBE, DROP, EXPLAIN, GRANT, INSERT, INVALIDATE, LOAD, REFRESH, REVOKE, SELECT, SET, SHOW, TRUNCATE, UNSET, UPDATE, UPSERT, USE, VALUES, WITH\\n\\n\\nCAUSED BY: Exception: Syntax error\\n\", \"help\": null, \"line\": 1030}], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryHistory\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =====================================================================\\r\\n-- PROJETO LUCIANO - CONSULTAS ANAL\\u00cdTICAS COMPLETAS\\r\\n-- =====================================================================\\r\\n\\r\\n-- =====================================================================\\r\\n-- 1. DASHBOARD EXECUTIVO - VIS\\u00c3O GERAL DO PROJETO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== DASHBOARD EXECUTIVO LUCIANO ===' AS secao,\\r\\n    '' AS metrica,\\r\\n    '' AS valor,\\r\\n    '' AS observacao\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'VOLUMETRIA GERAL',\\r\\n    'Total de Empresas Analisadas',\\r\\n    CAST(total_empresas AS STRING),\\r\\n    'Empresas \\u00fanicas no per\\u00edodo de 60 meses'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'VOLUMETRIA GERAL',\\r\\n    'Total de Protocolos',\\r\\n    CAST(total_protocolos AS STRING),\\r\\n    'Cancelamentos processados'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'RISCO',\\r\\n    'Empresas Risco CR\\u00cdTICO',\\r\\n    CONCAT(CAST(empresas_risco_critico AS STRING), ' (', CAST(perc_risco_critico AS STRING), '%)'),\\r\\n    'Prioridade m\\u00e1xima de fiscaliza\\u00e7\\u00e3o'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'RISCO',\\r\\n    'Empresas Risco ALTO',\\r\\n    CONCAT(CAST(empresas_risco_alto AS STRING), ' (', CAST(perc_risco_alto AS STRING), '%)'),\\r\\n    'Segunda prioridade'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'EFETIVIDADE',\\r\\n    'Taxa M\\u00e9dia de Perman\\u00eancia',\\r\\n    CONCAT(CAST(taxa_media_permanencia AS STRING), '%'),\\r\\n    'Empresas que continuam canceladas'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'CR\\u00c9DITO',\\r\\n    'Saldo Credor Total em Risco',\\r\\n    CONCAT('R$ ', CAST(ROUND(saldo_credor_total, 2) AS STRING)),\\r\\n    'Valor acumulado em empresas canceladas'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'IND\\u00cdCIOS',\\r\\n    'Empresas com Ind\\u00edcios',\\r\\n    CONCAT(CAST(empresas_com_indicios AS STRING), ' (', CAST(perc_com_indicios AS STRING), '%)'),\\r\\n    'Empresas sinalizadas por irregularidades'\\r\\nFROM teste.luciano_resumo;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 2. ESTAT\\u00cdSTICAS GERAIS DETALHADAS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== ESTAT\\u00cdSTICAS GERAIS DO PROJETO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT cnpj) AS total_empresas,\\r\\n    SUM(total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(total_protocolos), 2) AS media_protocolos_por_empresa,\\r\\n    MAX(total_protocolos) AS max_protocolos_empresa,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o de Risco\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS qtde_critico,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS qtde_alto,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'M\\u00c9DIO' THEN 1 ELSE 0 END) AS qtde_medio,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'BAIXO' THEN 1 ELSE 0 END) AS qtde_baixo,\\r\\n    \\r\\n    -- Scores\\r\\n    ROUND(AVG(score_total), 2) AS score_medio,\\r\\n    ROUND(STDDEV(score_total), 2) AS desvio_padrao_score,\\r\\n    ROUND(MIN(score_total), 2) AS score_minimo,\\r\\n    ROUND(MAX(score_total), 2) AS score_maximo,\\r\\n    ROUND(APPX_MEDIAN(score_total), 2) AS mediana_score,\\r\\n    -- Nota: Impala n\\u00e3o suporta PERCENTILE_APPROX, usar subqueries se necess\\u00e1rio\\r\\n    -- Para an\\u00e1lise de distribui\\u00e7\\u00e3o, considerar quartis via subquery separada\\r\\n    \\r\\n    -- Status Atual\\r\\n    SUM(flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    COUNT(*) - SUM(flag_atualmente_cancelada) AS reativadas,\\r\\n    ROUND(SUM(flag_atualmente_cancelada) * 100.0 / COUNT(*), 2) AS perc_canceladas,\\r\\n    \\r\\n    -- Reincid\\u00eancia\\r\\n    SUM(flag_empresa_reincidente) AS empresas_reincidentes,\\r\\n    ROUND(SUM(flag_empresa_reincidente) * 100.0 / COUNT(*), 2) AS perc_reincidentes,\\r\\n    \\r\\n    -- Cr\\u00e9dito\\r\\n    SUM(saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS saldo_medio,\\r\\n    SUM(CASE WHEN saldo_credor_atual > 1000000 THEN 1 ELSE 0 END) AS empresas_saldo_acima_1M,\\r\\n    SUM(CASE WHEN saldo_credor_atual > 10000000 THEN 1 ELSE 0 END) AS empresas_saldo_acima_10M,\\r\\n    \\r\\n    -- Ind\\u00edcios\\r\\n    SUM(flag_tem_indicios) AS com_indicios,\\r\\n    SUM(flag_tem_indicios_graves) AS com_indicios_graves,\\r\\n    SUM(qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(CASE WHEN flag_tem_indicios = 1 THEN qtde_indicios END), 2) AS media_indicios_quando_tem\\r\\n\\r\\nFROM teste.luciano_scores;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 3. AN\\u00c1LISE POR CLASSIFICA\\u00c7\\u00c3O DE RISCO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR CLASSIFICA\\u00c7\\u00c3O DE RISCO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_final,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    -- Scores m\\u00e9dios\\r\\n    ROUND(AVG(score_total), 2) AS score_total_medio,\\r\\n    ROUND(AVG(score_comportamento), 2) AS score_comportamento_medio,\\r\\n    ROUND(AVG(score_credito), 2) AS score_credito_medio,\\r\\n    ROUND(AVG(score_indicios), 2) AS score_indicios_medio,\\r\\n    \\r\\n    -- Protocolos\\r\\n    SUM(total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    -- Status\\r\\n    SUM(flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    \\r\\n    -- Cr\\u00e9dito\\r\\n    SUM(saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS saldo_medio,\\r\\n    MAX(saldo_credor_atual) AS saldo_maximo,\\r\\n    \\r\\n    -- Ind\\u00edcios\\r\\n    SUM(qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(qtde_indicios), 2) AS media_indicios,\\r\\n    SUM(qtde_indicios_graves) AS indicios_graves,\\r\\n    \\r\\n    -- Flags de alerta\\r\\n    SUM(flag_saldo_alto_cancelada) AS flag_saldo_alto,\\r\\n    SUM(flag_suspeita_valores_repetidos) AS flag_valores_repetidos\\r\\n\\r\\nFROM teste.luciano_scores\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 4. AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O MENSAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O MENSAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    periodo_cancelamento,\\r\\n    ano_cancelamento,\\r\\n    mes_cancelamento,\\r\\n    \\r\\n    qtde_protocolos,\\r\\n    qtde_empresas_distintas,\\r\\n    qtde_usuarios_distintos,\\r\\n    \\r\\n    qtde_automaticos,\\r\\n    qtde_manuais,\\r\\n    ROUND(qtde_automaticos * 100.0 / qtde_protocolos, 2) AS perc_automaticos,\\r\\n    \\r\\n    qtde_ainda_canceladas,\\r\\n    qtde_reativadas,\\r\\n    taxa_permanencia_perc,\\r\\n    taxa_reativacao_perc,\\r\\n    \\r\\n    ROUND(media_dias_ate_reativacao, 0) AS dias_medios_reativacao,\\r\\n    \\r\\n    -- Comparativo com per\\u00edodo anterior\\r\\n    LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento) AS protocolos_periodo_anterior,\\r\\n    ROUND(\\r\\n        (qtde_protocolos - LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento)) * 100.0 /\\r\\n        NULLIF(LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento), 0),\\r\\n        2\\r\\n    ) AS variacao_perc_protocolos,\\r\\n    \\r\\n    -- M\\u00e9dia m\\u00f3vel 3 meses\\r\\n    ROUND(AVG(qtde_protocolos) OVER (\\r\\n        ORDER BY ano_cancelamento, mes_cancelamento \\r\\n        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\\r\\n    ), 2) AS media_movel_3m\\r\\n\\r\\nFROM teste.luciano_temporal\\r\\nORDER BY ano_cancelamento DESC, mes_cancelamento DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 5. AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O ANUAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O ANUAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    ano_cancelamento,\\r\\n    \\r\\n    SUM(qtde_protocolos) AS total_protocolos,\\r\\n    SUM(qtde_empresas_distintas) AS empresas_distintas,\\r\\n    \\r\\n    SUM(qtde_automaticos) AS total_automaticos,\\r\\n    SUM(qtde_manuais) AS total_manuais,\\r\\n    ROUND(SUM(qtde_automaticos) * 100.0 / SUM(qtde_protocolos), 2) AS perc_automaticos,\\r\\n    \\r\\n    SUM(qtde_ainda_canceladas) AS total_ainda_canceladas,\\r\\n    SUM(qtde_reativadas) AS total_reativadas,\\r\\n    ROUND(SUM(qtde_ainda_canceladas) * 100.0 / SUM(qtde_protocolos), 2) AS taxa_permanencia_anual,\\r\\n    \\r\\n    COUNT(DISTINCT periodo_cancelamento) AS meses_com_atividade,\\r\\n    ROUND(AVG(qtde_protocolos), 2) AS media_mensal_protocolos,\\r\\n    MAX(qtde_protocolos) AS pico_mensal,\\r\\n    \\r\\n    -- Comparativo ano anterior\\r\\n    LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento) AS protocolos_ano_anterior,\\r\\n    ROUND(\\r\\n        (SUM(qtde_protocolos) - LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento)) * 100.0 /\\r\\n        NULLIF(LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento), 0),\\r\\n        2\\r\\n    ) AS variacao_anual_perc\\r\\n\\r\\nFROM teste.luciano_temporal\\r\\nGROUP BY ano_cancelamento\\r\\nORDER BY ano_cancelamento DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 6. AN\\u00c1LISE POR REGI\\u00c3O/MUNIC\\u00cdPIO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR MUNIC\\u00cdPIO - TOP 20 ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.municipio,\\r\\n    m.uf,\\r\\n    m.gerencia_regional,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS empresas_alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    \\r\\n    SUM(CASE WHEN m.flag_empresa_reincidente = 1 THEN 1 ELSE 0 END) AS reincidentes,\\r\\n    \\r\\n    COUNT(DISTINCT m.cd_cnae) AS diversidade_cnaes\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nLEFT JOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nWHERE m.municipio IS NOT NULL\\r\\nGROUP BY m.municipio, m.uf, m.gerencia_regional\\r\\nHAVING COUNT(DISTINCT m.cnpj) >= 5\\r\\nORDER BY qtde_empresas DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 7. AN\\u00c1LISE POR GER\\u00caNCIA REGIONAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR GER\\u00caNCIA REGIONAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.gerencia_regional,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    COUNT(DISTINCT m.municipio) AS qtde_municipios,\\r\\n    COUNT(DISTINCT m.cd_cnae) AS qtde_cnaes,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS risco_alto,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_credor_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_credor_medio,\\r\\n    \\r\\n    SUM(i.qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(i.qtde_indicios), 2) AS media_indicios\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nLEFT JOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON m.cnpj = i.cnpj\\r\\nWHERE m.gerencia_regional IS NOT NULL\\r\\nGROUP BY m.gerencia_regional\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 8. AN\\u00c1LISE POR CNAE (ATIVIDADE ECON\\u00d4MICA)\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR CNAE - TOP 15 ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.cd_cnae,\\r\\n    MAX(m.descricao_cnae) AS descricao_cnae,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    ROUND(AVG(s.score_comportamento), 2) AS score_comportamento,\\r\\n    ROUND(AVG(s.score_credito), 2) AS score_credito,\\r\\n    ROUND(AVG(s.score_indicios), 2) AS score_indicios,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio,\\r\\n    \\r\\n    SUM(i.qtde_indicios) AS total_indicios,\\r\\n    SUM(i.qtde_indicios_graves) AS indicios_graves,\\r\\n    \\r\\n    SUM(m.flag_empresa_reincidente) AS reincidentes,\\r\\n    ROUND(SUM(m.flag_empresa_reincidente) * 100.0 / COUNT(*), 2) AS perc_reincidentes\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nLEFT JOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON m.cnpj = i.cnpj\\r\\nWHERE m.cd_cnae IS NOT NULL\\r\\nGROUP BY m.cd_cnae\\r\\nHAVING COUNT(DISTINCT m.cnpj) >= 10\\r\\nORDER BY qtde_empresas DESC\\r\\nLIMIT 15;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 9. AN\\u00c1LISE DE CR\\u00c9DITO DETALHADA\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE CR\\u00c9DITO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    -- Faixas de saldo credor\\r\\n    CASE \\r\\n        WHEN saldo_credor_atual <= 0 THEN '0 - Sem saldo'\\r\\n        WHEN saldo_credor_atual <= 10000 THEN '1 - At\\u00e9 10k'\\r\\n        WHEN saldo_credor_atual <= 100000 THEN '2 - 10k a 100k'\\r\\n        WHEN saldo_credor_atual <= 500000 THEN '3 - 100k a 500k'\\r\\n        WHEN saldo_credor_atual <= 1000000 THEN '4 - 500k a 1M'\\r\\n        WHEN saldo_credor_atual <= 10000000 THEN '5 - 1M a 10M'\\r\\n        ELSE '6 - Acima de 10M'\\r\\n    END AS faixa_saldo,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(saldo_credor_atual) AS saldo_total_faixa,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS saldo_medio,\\r\\n    \\r\\n    SUM(vl_credito_60m) AS credito_60m_total,\\r\\n    SUM(vl_credito_presumido_60m) AS credito_presumido_total,\\r\\n    \\r\\n    SUM(flag_saldo_alto_cancelada) AS flag_saldo_alto,\\r\\n    SUM(flag_suspeita_valores_repetidos) AS flag_valores_repetidos,\\r\\n    SUM(flag_saldo_sem_declaracao) AS flag_sem_declaracao,\\r\\n    SUM(flag_credito_muito_estavel) AS flag_muito_estavel,\\r\\n    SUM(flag_crescimento_anormal_saldo) AS flag_crescimento_anormal,\\r\\n    \\r\\n    -- Total de flags\\r\\n    SUM(flag_saldo_alto_cancelada + flag_suspeita_valores_repetidos + \\r\\n        flag_saldo_sem_declaracao + flag_credito_muito_estavel + \\r\\n        flag_crescimento_anormal_saldo) AS total_alertas\\r\\n\\r\\nFROM teste.luciano_credito\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN saldo_credor_atual <= 0 THEN '0 - Sem saldo'\\r\\n        WHEN saldo_credor_atual <= 10000 THEN '1 - At\\u00e9 10k'\\r\\n        WHEN saldo_credor_atual <= 100000 THEN '2 - 10k a 100k'\\r\\n        WHEN saldo_credor_atual <= 500000 THEN '3 - 100k a 500k'\\r\\n        WHEN saldo_credor_atual <= 1000000 THEN '4 - 500k a 1M'\\r\\n        WHEN saldo_credor_atual <= 10000000 THEN '5 - 1M a 10M'\\r\\n        ELSE '6 - Acima de 10M'\\r\\n    END\\r\\nORDER BY faixa_saldo;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 10. EMPRESAS COM MAIOR SALDO CREDOR CANCELADAS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== TOP 20 EMPRESAS - SALDO CREDOR EM RISCO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    c.cnpj,\\r\\n    c.nome_contribuinte,\\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    \\r\\n    c.saldo_credor_atual,\\r\\n    c.vl_credito_60m,\\r\\n    c.vl_credito_presumido_60m,\\r\\n    c.vl_saldo_credor_60m,\\r\\n    \\r\\n    c.perc_valores_iguais_12m,\\r\\n    c.variacao_saldo_perc_60m,\\r\\n    \\r\\n    m.total_protocolos,\\r\\n    m.taxa_permanencia_cancelamento_perc,\\r\\n    m.classificacao_frequencia,\\r\\n    \\r\\n    i.qtde_indicios,\\r\\n    i.classificacao_risco_indicios,\\r\\n    \\r\\n    -- Flags de alerta\\r\\n    c.flag_saldo_alto_cancelada,\\r\\n    c.flag_suspeita_valores_repetidos,\\r\\n    c.flag_saldo_sem_declaracao,\\r\\n    c.flag_crescimento_anormal_saldo\\r\\n\\r\\nFROM teste.luciano_credito c\\r\\nJOIN teste.luciano_scores s ON c.cnpj = s.cnpj\\r\\nJOIN teste.luciano_metricas m ON c.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON c.cnpj = i.cnpj\\r\\nWHERE s.flag_atualmente_cancelada = 1\\r\\n    AND c.saldo_credor_atual > 0\\r\\nORDER BY c.saldo_credor_atual DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 11. AN\\u00c1LISE DE IND\\u00cdCIOS DETALHADA\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE IND\\u00cdCIOS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_indicios,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(qtde_indicios), 2) AS media_indicios,\\r\\n    MAX(qtde_indicios) AS max_indicios,\\r\\n    \\r\\n    SUM(qtde_indicios_graves) AS total_graves,\\r\\n    ROUND(AVG(qtde_indicios_graves), 2) AS media_graves,\\r\\n    \\r\\n    SUM(soma_scores_indicios) AS soma_total_scores,\\r\\n    ROUND(AVG(soma_scores_indicios), 2) AS media_scores,\\r\\n    \\r\\n    -- Por categoria\\r\\n    SUM(qtde_indicios_docs_fiscais) AS indicios_docs_fiscais,\\r\\n    SUM(qtde_indicios_relacionamentos) AS indicios_relacionamentos,\\r\\n    SUM(qtde_indicios_declaracoes) AS indicios_declaracoes,\\r\\n    SUM(qtde_indicios_cadastro) AS indicios_cadastro,\\r\\n    \\r\\n    -- Flags\\r\\n    SUM(flag_tem_indicios) AS com_indicios,\\r\\n    SUM(flag_tem_indicios_graves) AS com_indicios_graves\\r\\n\\r\\nFROM teste.luciano_indicios\\r\\nGROUP BY classificacao_risco_indicios\\r\\nORDER BY \\r\\n    CASE classificacao_risco_indicios\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n        WHEN 'SEM_INDICIOS' THEN 5\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 12. EMPRESAS COM MAIS IND\\u00cdCIOS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== TOP 20 EMPRESAS - MAIS IND\\u00cdCIOS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    i.cnpj,\\r\\n    i.nome_contribuinte,\\r\\n    i.classificacao_risco_indicios,\\r\\n    \\r\\n    i.qtde_indicios,\\r\\n    i.qtde_tipos_indicios_distintos,\\r\\n    i.soma_scores_indicios,\\r\\n    i.qtde_indicios_graves,\\r\\n    \\r\\n    i.qtde_indicios_docs_fiscais,\\r\\n    i.qtde_indicios_relacionamentos,\\r\\n    i.qtde_indicios_declaracoes,\\r\\n    i.qtde_indicios_cadastro,\\r\\n    \\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    \\r\\n    c.saldo_credor_atual,\\r\\n    \\r\\n    m.total_protocolos,\\r\\n    m.taxa_permanencia_cancelamento_perc\\r\\n\\r\\nFROM teste.luciano_indicios i\\r\\nJOIN teste.luciano_scores s ON i.cnpj = s.cnpj\\r\\nJOIN teste.luciano_metricas m ON i.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON i.cnpj = c.cnpj\\r\\nWHERE i.qtde_indicios > 0\\r\\nORDER BY i.soma_scores_indicios DESC, i.qtde_indicios DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 13. AN\\u00c1LISE DE DESEMPENHO DOS FISCAIS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE DESEMPENHO DOS FISCAIS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    matricula_fiscal,\\r\\n    nome_fiscal,\\r\\n    \\r\\n    qtde_protocolos_fiscal,\\r\\n    qtde_empresas_distintas,\\r\\n    anos_atuacao,\\r\\n    \\r\\n    qtde_cancelamentos_efetivos,\\r\\n    taxa_efetividade_perc,\\r\\n    taxa_reativacao_perc,\\r\\n    \\r\\n    ROUND(media_dias_processamento, 1) AS dias_processamento_medio,\\r\\n    \\r\\n    ROUND(media_protocolos_por_empresa, 2) AS media_protocolos_empresa,\\r\\n    qtde_casos_reincidentes,\\r\\n    \\r\\n    qtde_individuais,\\r\\n    qtde_massivos,\\r\\n    \\r\\n    -- M\\u00e9tricas do fiscal\\r\\n    total_chats,\\r\\n    total_observacoes,\\r\\n    perc_dedicacao_malhas,\\r\\n    \\r\\n    -- Per\\u00edodo de atua\\u00e7\\u00e3o\\r\\n    data_primeiro_protocolo,\\r\\n    data_ultimo_protocolo,\\r\\n    DATEDIFF(data_ultimo_protocolo, data_primeiro_protocolo) AS dias_atuacao\\r\\n\\r\\nFROM teste.luciano_fiscal\\r\\nORDER BY qtde_protocolos_fiscal DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 14. RANKING FISCAIS - EFETIVIDADE\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== RANKING FISCAIS - MAIOR EFETIVIDADE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    ROW_NUMBER() OVER (ORDER BY taxa_efetividade_perc DESC, qtde_protocolos_fiscal DESC) AS ranking,\\r\\n    matricula_fiscal,\\r\\n    nome_fiscal,\\r\\n    qtde_protocolos_fiscal,\\r\\n    qtde_cancelamentos_efetivos,\\r\\n    taxa_efetividade_perc,\\r\\n    taxa_reativacao_perc,\\r\\n    ROUND(media_dias_processamento, 1) AS dias_processamento,\\r\\n    qtde_casos_reincidentes\\r\\n\\r\\nFROM teste.luciano_fiscal\\r\\nWHERE qtde_protocolos_fiscal >= 10\\r\\nORDER BY taxa_efetividade_perc DESC, qtde_protocolos_fiscal DESC\\r\\nLIMIT 15;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 15. AN\\u00c1LISE CRUZADA: RISCO x CR\\u00c9DITO x IND\\u00cdCIOS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== MATRIZ RISCO x CR\\u00c9DITO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.classificacao_risco_final,\\r\\n    \\r\\n    -- Faixas de cr\\u00e9dito\\r\\n    SUM(CASE WHEN c.saldo_credor_atual <= 0 THEN 1 ELSE 0 END) AS sem_saldo,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 0 AND c.saldo_credor_atual <= 100000 THEN 1 ELSE 0 END) AS ate_100k,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 100000 AND c.saldo_credor_atual <= 1000000 THEN 1 ELSE 0 END) AS de_100k_a_1M,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 1000000 THEN 1 ELSE 0 END) AS acima_1M,\\r\\n    \\r\\n    COUNT(*) AS total,\\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nGROUP BY s.classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE s.classificacao_risco_final\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 16. AN\\u00c1LISE DE REINCID\\u00caNCIA\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE REINCID\\u00caNCIA ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    CASE \\r\\n        WHEN m.total_protocolos = 1 THEN '1 - \\u00danico protocolo'\\r\\n        WHEN m.total_protocolos = 2 THEN '2 - Dois protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 3 AND 5 THEN '3 - De 3 a 5 protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 6 AND 10 THEN '4 - De 6 a 10 protocolos'\\r\\n        ELSE '5 - Mais de 10 protocolos'\\r\\n    END AS faixa_protocolos,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos_grupo,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    ROUND(AVG(m.taxa_reativacao_perc), 2) AS taxa_reativacao_media,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    SUM(s.flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    \\r\\n    SUM(s.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(s.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN m.total_protocolos = 1 THEN '1 - \\u00danico protocolo'\\r\\n        WHEN m.total_protocolos = 2 THEN '2 - Dois protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 3 AND 5 THEN '3 - De 3 a 5 protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 6 AND 10 THEN '4 - De 6 a 10 protocolos'\\r\\n        ELSE '5 - Mais de 10 protocolos'\\r\\n    END\\r\\nORDER BY faixa_protocolos;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 17. ALERTAS CR\\u00cdTICOS - CASOS PRIORIT\\u00c1RIOS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== ALERTAS CR\\u00cdTICOS - CASOS PRIORIT\\u00c1RIOS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.cnpj,\\r\\n    s.nome_contribuinte,\\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    s.ranking_fiscalizacao,\\r\\n    \\r\\n    -- Motivos do alerta\\r\\n    CONCAT(\\r\\n        CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN '[RISCO_CR\\u00cdTICO] ' ELSE '' END,\\r\\n        CASE WHEN c.saldo_credor_atual > 1000000 AND s.flag_atualmente_cancelada = 1 THEN '[SALDO>1M_CANCELADA] ' ELSE '' END,\\r\\n        CASE WHEN i.qtde_indicios_graves >= 3 THEN '[IND\\u00cdCIOS_GRAVES>=3] ' ELSE '' END,\\r\\n        CASE WHEN m.total_protocolos >= 5 THEN '[MUITO_REINCIDENTE] ' ELSE '' END,\\r\\n        CASE WHEN c.flag_crescimento_anormal_saldo = 1 THEN '[CRESCIMENTO_ANORMAL] ' ELSE '' END,\\r\\n        CASE WHEN c.perc_valores_iguais_12m >= 80 THEN '[VALORES_REPETIDOS] ' ELSE '' END\\r\\n    ) AS alertas,\\r\\n    \\r\\n    m.total_protocolos,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    c.saldo_credor_atual,\\r\\n    i.qtde_indicios,\\r\\n    i.qtde_indicios_graves,\\r\\n    \\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON s.cnpj = i.cnpj\\r\\nWHERE \\r\\n    s.classificacao_risco_final = 'CR\\u00cdTICO'\\r\\n    OR (c.saldo_credor_atual > 1000000 AND s.flag_atualmente_cancelada = 1)\\r\\n    OR i.qtde_indicios_graves >= 3\\r\\n    OR (m.total_protocolos >= 5 AND s.flag_atualmente_cancelada = 1)\\r\\nORDER BY s.score_total DESC, c.saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 18. PADR\\u00d5ES DE CANCELAMENTO (AUTOM\\u00c1TICO vs MANUAL)\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE PADR\\u00c3O DE CANCELAMENTO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.padrao_cancelamento_predominante,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(m.qtde_automaticos) AS total_automaticos,\\r\\n    SUM(m.qtde_manuais) AS total_manuais,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia,\\r\\n    ROUND(AVG(m.taxa_reativacao_perc), 2) AS taxa_reativacao,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    SUM(m.flag_empresa_reincidente) AS reincidentes\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nGROUP BY m.padrao_cancelamento_predominante;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 19. EFETIVIDADE DO CANCELAMENTO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE EFETIVIDADE DO CANCELAMENTO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.efetividade_cancelamento,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    ROUND(AVG(m.dias_medios_reativacao), 0) AS dias_medios_reativacao,\\r\\n    \\r\\n    SUM(m.flag_empresa_reincidente) AS reincidentes,\\r\\n    ROUND(SUM(m.flag_empresa_reincidente) * 100.0 / COUNT(*), 2) AS perc_reincidentes,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nGROUP BY m.efetividade_cancelamento\\r\\nORDER BY \\r\\n    CASE m.efetividade_cancelamento\\r\\n        WHEN 'EFETIVO' THEN 1\\r\\n        WHEN 'PARCIALMENTE_EFETIVO' THEN 2\\r\\n        WHEN 'POUCO_EFETIVO' THEN 3\\r\\n        WHEN 'INEFETIVO' THEN 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 20. COMPARATIVO AUTOM\\u00c1TICO vs MANUAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== COMPARATIVO AUTOM\\u00c1TICO vs MANUAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    'AUTOM\\u00c1TICO' AS tipo_cancelamento,\\r\\n    COUNT(DISTINCT b.cnpj) AS empresas_afetadas,\\r\\n    COUNT(*) AS total_eventos,\\r\\n    SUM(b.flag_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(SUM(b.flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_permanencia,\\r\\n    SUM(b.flag_reativada) AS reativadas,\\r\\n    ROUND(AVG(b.dias_desde_cancelamento), 0) AS dias_medios\\r\\nFROM teste.luciano_base b\\r\\nWHERE b.flag_cancelamento_automatico = 1\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'MANUAL' AS tipo_cancelamento,\\r\\n    COUNT(DISTINCT b.cnpj) AS empresas_afetadas,\\r\\n    COUNT(*) AS total_eventos,\\r\\n    SUM(b.flag_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(SUM(b.flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_permanencia,\\r\\n    SUM(b.flag_reativada) AS reativadas,\\r\\n    ROUND(AVG(b.dias_desde_cancelamento), 0) AS dias_medios\\r\\nFROM teste.luciano_base b\\r\\nWHERE b.flag_cancelamento_automatico = 0;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 21. AN\\u00c1LISE DE TIPO DE CONTRIBUINTE\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR TIPO DE CONTRIBUINTE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.tipo_contribuinte,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nWHERE m.tipo_contribuinte IS NOT NULL\\r\\nGROUP BY m.tipo_contribuinte\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 22. AN\\u00c1LISE POR REGIME DE APURA\\u00c7\\u00c3O\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR REGIME DE APURA\\u00c7\\u00c3O ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.regime_apuracao,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS risco_alto,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    SUM(c.vl_credito_presumido_60m) AS credito_presumido_total,\\r\\n    \\r\\n    SUM(i.qtde_indicios) AS total_indicios\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON m.cnpj = i.cnpj\\r\\nWHERE m.regime_apuracao IS NOT NULL\\r\\nGROUP BY m.regime_apuracao\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 23. TOP 100 COMPLETO COM TODAS AS M\\u00c9TRICAS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== TOP 100 - PRIORIDADE DE FISCALIZA\\u00c7\\u00c3O ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    ranking_fiscalizacao,\\r\\n    cnpj,\\r\\n    nome_contribuinte,\\r\\n    razao_social,\\r\\n    cd_cnae,\\r\\n    municipio,\\r\\n    uf,\\r\\n    \\r\\n    classificacao_risco_final,\\r\\n    score_total,\\r\\n    score_comportamento,\\r\\n    score_credito,\\r\\n    score_indicios,\\r\\n    \\r\\n    total_protocolos,\\r\\n    taxa_permanencia_cancelamento_perc,\\r\\n    classificacao_frequencia,\\r\\n    efetividade_cancelamento,\\r\\n    \\r\\n    flag_atualmente_cancelada,\\r\\n    flag_empresa_reincidente,\\r\\n    \\r\\n    saldo_credor_atual,\\r\\n    vl_credito_60m,\\r\\n    \\r\\n    qtde_indicios,\\r\\n    qtde_indicios_graves,\\r\\n    classificacao_risco_indicios,\\r\\n    \\r\\n    -- Flags de alerta\\r\\n    flag_saldo_alto_cancelada,\\r\\n    flag_suspeita_valores_repetidos,\\r\\n    flag_tem_indicios_graves,\\r\\n    \\r\\n    padrao_cancelamento_predominante,\\r\\n    data_primeiro_cancelamento,\\r\\n    data_ultimo_cancelamento\\r\\n\\r\\nFROM teste.luciano_top100\\r\\nORDER BY ranking_fiscalizacao;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 24. SUM\\u00c1RIO ESTAT\\u00cdSTICO FINAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== SUM\\u00c1RIO ESTAT\\u00cdSTICO FINAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    -- Volume\\r\\n    'VOLUME' AS categoria,\\r\\n    'Total de Empresas' AS metrica,\\r\\n    CAST(COUNT(DISTINCT cnpj) AS STRING) AS valor\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'VOLUME', 'Total de Protocolos', CAST(SUM(total_protocolos) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'VOLUME', 'M\\u00e9dia Protocolos/Empresa', CAST(ROUND(AVG(total_protocolos), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'RISCO', 'Empresas Cr\\u00edtico', CONCAT(CAST(SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS STRING), ' (', CAST(ROUND(SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'RISCO', 'Empresas Alto', CONCAT(CAST(SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS STRING), ' (', CAST(ROUND(SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'SCORE', 'Score M\\u00e9dio', CAST(ROUND(AVG(score_total), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'SCORE', 'Score M\\u00e1ximo', CAST(ROUND(MAX(score_total), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'STATUS', 'Ainda Canceladas', CONCAT(CAST(SUM(flag_atualmente_cancelada) AS STRING), ' (', CAST(ROUND(SUM(flag_atualmente_cancelada) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'STATUS', 'Reincidentes', CONCAT(CAST(SUM(flag_empresa_reincidente) AS STRING), ' (', CAST(ROUND(SUM(flag_empresa_reincidente) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'CR\\u00c9DITO', 'Saldo Credor Total', CONCAT('R$ ', CAST(ROUND(SUM(saldo_credor_atual), 2) AS STRING))\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'CR\\u00c9DITO', 'Saldo Credor M\\u00e9dio', CONCAT('R$ ', CAST(ROUND(AVG(saldo_credor_atual), 2) AS STRING))\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'IND\\u00cdCIOS', 'Empresas com Ind\\u00edcios', CONCAT(CAST(SUM(flag_tem_indicios) AS STRING), ' (', CAST(ROUND(SUM(flag_tem_indicios) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'IND\\u00cdCIOS', 'Total de Ind\\u00edcios', CAST(SUM(qtde_indicios) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'ALERTAS', 'Saldo Alto + Cancelada', CAST(SUM(flag_saldo_alto_cancelada) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'ALERTAS', 'Valores Suspeitos', CAST(SUM(flag_suspeita_valores_repetidos) AS STRING)\\r\\nFROM teste.luciano_scores;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 25. QUERY PARA EXPORTA\\u00c7\\u00c3O - LISTA COMPLETA PARA EXCEL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== EXPORTA\\u00c7\\u00c3O COMPLETA PARA AN\\u00c1LISE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.ranking_fiscalizacao,\\r\\n    s.cnpj,\\r\\n    s.nome_contribuinte,\\r\\n    m.razao_social,\\r\\n    m.cd_cnae,\\r\\n    m.descricao_cnae,\\r\\n    m.municipio,\\r\\n    m.uf,\\r\\n    m.gerencia_regional,\\r\\n    m.tipo_contribuinte,\\r\\n    m.regime_apuracao,\\r\\n    m.grupo_economico,\\r\\n    \\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    s.score_comportamento,\\r\\n    s.score_credito,\\r\\n    s.score_indicios,\\r\\n    \\r\\n    s.total_protocolos,\\r\\n    m.anos_distintos_cancelamento,\\r\\n    m.qtde_usuarios_distintos,\\r\\n    m.qtde_automaticos,\\r\\n    m.qtde_manuais,\\r\\n    m.padrao_cancelamento_predominante,\\r\\n    \\r\\n    s.taxa_permanencia_cancelamento_perc,\\r\\n    s.taxa_reativacao_perc,\\r\\n    s.classificacao_frequencia,\\r\\n    s.classificacao_persistencia,\\r\\n    s.efetividade_cancelamento,\\r\\n    \\r\\n    s.flag_empresa_reincidente,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    \\r\\n    c.saldo_credor_atual,\\r\\n    c.vl_credito_12m,\\r\\n    c.vl_credito_60m,\\r\\n    c.vl_credito_presumido_12m,\\r\\n    c.vl_credito_presumido_60m,\\r\\n    c.perc_valores_iguais_12m,\\r\\n    c.variacao_saldo_perc_60m,\\r\\n    c.flag_saldo_alto_cancelada,\\r\\n    c.flag_suspeita_valores_repetidos,\\r\\n    c.flag_saldo_sem_declaracao,\\r\\n    c.flag_crescimento_anormal_saldo,\\r\\n    \\r\\n    i.qtde_indicios,\\r\\n    i.qtde_tipos_indicios_distintos,\\r\\n    i.soma_scores_indicios,\\r\\n    i.qtde_indicios_graves,\\r\\n    i.classificacao_risco_indicios,\\r\\n    i.qtde_indicios_docs_fiscais,\\r\\n    i.qtde_indicios_relacionamentos,\\r\\n    i.qtde_indicios_declaracoes,\\r\\n    i.qtde_indicios_cadastro,\\r\\n    \\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento,\\r\\n    m.dias_entre_primeiro_ultimo,\\r\\n    m.media_dias_desde_cancelamento,\\r\\n    m.lista_fiscais_envolvidos\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON s.cnpj = i.cnpj\\r\\nORDER BY s.ranking_fiscalizacao;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- FIM DAS CONSULTAS ANAL\\u00cdTICAS\\r\\n-- =====================================================================\", \"statementsList\": [\"-- =====================================================================\\r\\n-- PROJETO LUCIANO - CONSULTAS ANAL\\u00cdTICAS COMPLETAS\\r\\n-- =====================================================================\\r\\n\\r\\n-- =====================================================================\\r\\n-- 1. DASHBOARD EXECUTIVO - VIS\\u00c3O GERAL DO PROJETO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== DASHBOARD EXECUTIVO LUCIANO ===' AS secao,\\r\\n    '' AS metrica,\\r\\n    '' AS valor,\\r\\n    '' AS observacao\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'VOLUMETRIA GERAL',\\r\\n    'Total de Empresas Analisadas',\\r\\n    CAST(total_empresas AS STRING),\\r\\n    'Empresas \\u00fanicas no per\\u00edodo de 60 meses'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'VOLUMETRIA GERAL',\\r\\n    'Total de Protocolos',\\r\\n    CAST(total_protocolos AS STRING),\\r\\n    'Cancelamentos processados'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'RISCO',\\r\\n    'Empresas Risco CR\\u00cdTICO',\\r\\n    CONCAT(CAST(empresas_risco_critico AS STRING), ' (', CAST(perc_risco_critico AS STRING), '%)'),\\r\\n    'Prioridade m\\u00e1xima de fiscaliza\\u00e7\\u00e3o'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'RISCO',\\r\\n    'Empresas Risco ALTO',\\r\\n    CONCAT(CAST(empresas_risco_alto AS STRING), ' (', CAST(perc_risco_alto AS STRING), '%)'),\\r\\n    'Segunda prioridade'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'EFETIVIDADE',\\r\\n    'Taxa M\\u00e9dia de Perman\\u00eancia',\\r\\n    CONCAT(CAST(taxa_media_permanencia AS STRING), '%'),\\r\\n    'Empresas que continuam canceladas'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'CR\\u00c9DITO',\\r\\n    'Saldo Credor Total em Risco',\\r\\n    CONCAT('R$ ', CAST(ROUND(saldo_credor_total, 2) AS STRING)),\\r\\n    'Valor acumulado em empresas canceladas'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'IND\\u00cdCIOS',\\r\\n    'Empresas com Ind\\u00edcios',\\r\\n    CONCAT(CAST(empresas_com_indicios AS STRING), ' (', CAST(perc_com_indicios AS STRING), '%)'),\\r\\n    'Empresas sinalizadas por irregularidades'\\r\\nFROM teste.luciano_resumo;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 2. ESTAT\\u00cdSTICAS GERAIS DETALHADAS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== ESTAT\\u00cdSTICAS GERAIS DO PROJETO ===' AS titulo;\", \"\\r\\n\\r\\nSELECT \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT cnpj) AS total_empresas,\\r\\n    SUM(total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(total_protocolos), 2) AS media_protocolos_por_empresa,\\r\\n    MAX(total_protocolos) AS max_protocolos_empresa,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o de Risco\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS qtde_critico,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS qtde_alto,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'M\\u00c9DIO' THEN 1 ELSE 0 END) AS qtde_medio,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'BAIXO' THEN 1 ELSE 0 END) AS qtde_baixo,\\r\\n    \\r\\n    -- Scores\\r\\n    ROUND(AVG(score_total), 2) AS score_medio,\\r\\n    ROUND(STDDEV(score_total), 2) AS desvio_padrao_score,\\r\\n    ROUND(MIN(score_total), 2) AS score_minimo,\\r\\n    ROUND(MAX(score_total), 2) AS score_maximo,\\r\\n    ROUND(APPX_MEDIAN(score_total), 2) AS mediana_score,\\r\\n    -- Nota: Impala n\\u00e3o suporta PERCENTILE_APPROX, usar subqueries se necess\\u00e1rio\\r\\n    -- Para an\\u00e1lise de distribui\\u00e7\\u00e3o, considerar quartis via subquery separada\\r\\n    \\r\\n    -- Status Atual\\r\\n    SUM(flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    COUNT(*) - SUM(flag_atualmente_cancelada) AS reativadas,\\r\\n    ROUND(SUM(flag_atualmente_cancelada) * 100.0 / COUNT(*), 2) AS perc_canceladas,\\r\\n    \\r\\n    -- Reincid\\u00eancia\\r\\n    SUM(flag_empresa_reincidente) AS empresas_reincidentes,\\r\\n    ROUND(SUM(flag_empresa_reincidente) * 100.0 / COUNT(*), 2) AS perc_reincidentes,\\r\\n    \\r\\n    -- Cr\\u00e9dito\\r\\n    SUM(saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS saldo_medio,\\r\\n    SUM(CASE WHEN saldo_credor_atual > 1000000 THEN 1 ELSE 0 END) AS empresas_saldo_acima_1M,\\r\\n    SUM(CASE WHEN saldo_credor_atual > 10000000 THEN 1 ELSE 0 END) AS empresas_saldo_acima_10M,\\r\\n    \\r\\n    -- Ind\\u00edcios\\r\\n    SUM(flag_tem_indicios) AS com_indicios,\\r\\n    SUM(flag_tem_indicios_graves) AS com_indicios_graves,\\r\\n    SUM(qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(CASE WHEN flag_tem_indicios = 1 THEN qtde_indicios END), 2) AS media_indicios_quando_tem\\r\\n\\r\\nFROM teste.luciano_scores;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 3. AN\\u00c1LISE POR CLASSIFICA\\u00c7\\u00c3O DE RISCO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR CLASSIFICA\\u00c7\\u00c3O DE RISCO ===' AS titulo;\", \"\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_final,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    -- Scores m\\u00e9dios\\r\\n    ROUND(AVG(score_total), 2) AS score_total_medio,\\r\\n    ROUND(AVG(score_comportamento), 2) AS score_comportamento_medio,\\r\\n    ROUND(AVG(score_credito), 2) AS score_credito_medio,\\r\\n    ROUND(AVG(score_indicios), 2) AS score_indicios_medio,\\r\\n    \\r\\n    -- Protocolos\\r\\n    SUM(total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    -- Status\\r\\n    SUM(flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    \\r\\n    -- Cr\\u00e9dito\\r\\n    SUM(saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS saldo_medio,\\r\\n    MAX(saldo_credor_atual) AS saldo_maximo,\\r\\n    \\r\\n    -- Ind\\u00edcios\\r\\n    SUM(qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(qtde_indicios), 2) AS media_indicios,\\r\\n    SUM(qtde_indicios_graves) AS indicios_graves,\\r\\n    \\r\\n    -- Flags de alerta\\r\\n    SUM(flag_saldo_alto_cancelada) AS flag_saldo_alto,\\r\\n    SUM(flag_suspeita_valores_repetidos) AS flag_valores_repetidos\\r\\n\\r\\nFROM teste.luciano_scores\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 4. AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O MENSAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O MENSAL ===' AS titulo;\", \"\\r\\n\\r\\nSELECT \\r\\n    periodo_cancelamento,\\r\\n    ano_cancelamento,\\r\\n    mes_cancelamento,\\r\\n    \\r\\n    qtde_protocolos,\\r\\n    qtde_empresas_distintas,\\r\\n    qtde_usuarios_distintos,\\r\\n    \\r\\n    qtde_automaticos,\\r\\n    qtde_manuais,\\r\\n    ROUND(qtde_automaticos * 100.0 / qtde_protocolos, 2) AS perc_automaticos,\\r\\n    \\r\\n    qtde_ainda_canceladas,\\r\\n    qtde_reativadas,\\r\\n    taxa_permanencia_perc,\\r\\n    taxa_reativacao_perc,\\r\\n    \\r\\n    ROUND(media_dias_ate_reativacao, 0) AS dias_medios_reativacao,\\r\\n    \\r\\n    -- Comparativo com per\\u00edodo anterior\\r\\n    LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento) AS protocolos_periodo_anterior,\\r\\n    ROUND(\\r\\n        (qtde_protocolos - LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento)) * 100.0 /\\r\\n        NULLIF(LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento), 0),\\r\\n        2\\r\\n    ) AS variacao_perc_protocolos,\\r\\n    \\r\\n    -- M\\u00e9dia m\\u00f3vel 3 meses\\r\\n    ROUND(AVG(qtde_protocolos) OVER (\\r\\n        ORDER BY ano_cancelamento, mes_cancelamento \\r\\n        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\\r\\n    ), 2) AS media_movel_3m\\r\\n\\r\\nFROM teste.luciano_temporal\\r\\nORDER BY ano_cancelamento DESC, mes_cancelamento DESC;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 5. AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O ANUAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O ANUAL ===' AS titulo;\", \"\\r\\n\\r\\nSELECT \\r\\n    ano_cancelamento,\\r\\n    \\r\\n    SUM(qtde_protocolos) AS total_protocolos,\\r\\n    SUM(qtde_empresas_distintas) AS empresas_distintas,\\r\\n    \\r\\n    SUM(qtde_automaticos) AS total_automaticos,\\r\\n    SUM(qtde_manuais) AS total_manuais,\\r\\n    ROUND(SUM(qtde_automaticos) * 100.0 / SUM(qtde_protocolos), 2) AS perc_automaticos,\\r\\n    \\r\\n    SUM(qtde_ainda_canceladas) AS total_ainda_canceladas,\\r\\n    SUM(qtde_reativadas) AS total_reativadas,\\r\\n    ROUND(SUM(qtde_ainda_canceladas) * 100.0 / SUM(qtde_protocolos), 2) AS taxa_permanencia_anual,\\r\\n    \\r\\n    COUNT(DISTINCT periodo_cancelamento) AS meses_com_atividade,\\r\\n    ROUND(AVG(qtde_protocolos), 2) AS media_mensal_protocolos,\\r\\n    MAX(qtde_protocolos) AS pico_mensal,\\r\\n    \\r\\n    -- Comparativo ano anterior\\r\\n    LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento) AS protocolos_ano_anterior,\\r\\n    ROUND(\\r\\n        (SUM(qtde_protocolos) - LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento)) * 100.0 /\\r\\n        NULLIF(LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento), 0),\\r\\n        2\\r\\n    ) AS variacao_anual_perc\\r\\n\\r\\nFROM teste.luciano_temporal\\r\\nGROUP BY ano_cancelamento\\r\\nORDER BY ano_cancelamento DESC;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 6. AN\\u00c1LISE POR REGI\\u00c3O/MUNIC\\u00cdPIO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR MUNIC\\u00cdPIO - TOP 20 ===' AS titulo;\", \"\\r\\n\\r\\nSELECT \\r\\n    m.municipio,\\r\\n    m.uf,\\r\\n    m.gerencia_regional,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS empresas_alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    \\r\\n    SUM(CASE WHEN m.flag_empresa_reincidente = 1 THEN 1 ELSE 0 END) AS reincidentes,\\r\\n    \\r\\n    COUNT(DISTINCT m.cd_cnae) AS diversidade_cnaes\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nLEFT JOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nWHERE m.municipio IS NOT NULL\\r\\nGROUP BY m.municipio, m.uf, m.gerencia_regional\\r\\nHAVING COUNT(DISTINCT m.cnpj) >= 5\\r\\nORDER BY qtde_empresas DESC\\r\\nLIMIT 20;\"], \"aceSize\": 100, \"status\": \"failed\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- =====================================================================\\r\\n-- PROJETO LUCIANO - CONSULTAS ANAL\\u00cdTICAS COMPLETAS\\r\\n-- =====================================================================\\r\\n\\r\\n-- =====================================================================\\r\\n-- 1. DASHBOARD EXECUTIVO - VIS\\u00c3O GERAL DO PROJETO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== DASHBOARD EXECUTIVO LUCIANO ===' AS secao,\\r\\n    '' AS metrica,\\r\\n    '' AS valor,\\r\\n    '' AS observacao\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'VOLUMETRIA GERAL',\\r\\n    'Total de Empresas Analisadas',\\r\\n    CAST(total_empresas AS STRING),\\r\\n    'Empresas \\u00fanicas no per\\u00edodo de 60 meses'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'VOLUMETRIA GERAL',\\r\\n    'Total de Protocolos',\\r\\n    CAST(total_protocolos AS STRING),\\r\\n    'Cancelamentos processados'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'RISCO',\\r\\n    'Empresas Risco CR\\u00cdTICO',\\r\\n    CONCAT(CAST(empresas_risco_critico AS STRING), ' (', CAST(perc_risco_critico AS STRING), '%)'),\\r\\n    'Prioridade m\\u00e1xima de fiscaliza\\u00e7\\u00e3o'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'RISCO',\\r\\n    'Empresas Risco ALTO',\\r\\n    CONCAT(CAST(empresas_risco_alto AS STRING), ' (', CAST(perc_risco_alto AS STRING), '%)'),\\r\\n    'Segunda prioridade'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'EFETIVIDADE',\\r\\n    'Taxa M\\u00e9dia de Perman\\u00eancia',\\r\\n    CONCAT(CAST(taxa_media_permanencia AS STRING), '%'),\\r\\n    'Empresas que continuam canceladas'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'CR\\u00c9DITO',\\r\\n    'Saldo Credor Total em Risco',\\r\\n    CONCAT('R$ ', CAST(ROUND(saldo_credor_total, 2) AS STRING)),\\r\\n    'Valor acumulado em empresas canceladas'\\r\\nFROM teste.luciano_resumo\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'IND\\u00cdCIOS',\\r\\n    'Empresas com Ind\\u00edcios',\\r\\n    CONCAT(CAST(empresas_com_indicios AS STRING), ' (', CAST(perc_com_indicios AS STRING), '%)'),\\r\\n    'Empresas sinalizadas por irregularidades'\\r\\nFROM teste.luciano_resumo;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 2. ESTAT\\u00cdSTICAS GERAIS DETALHADAS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== ESTAT\\u00cdSTICAS GERAIS DO PROJETO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT cnpj) AS total_empresas,\\r\\n    SUM(total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(total_protocolos), 2) AS media_protocolos_por_empresa,\\r\\n    MAX(total_protocolos) AS max_protocolos_empresa,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o de Risco\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS qtde_critico,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS qtde_alto,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'M\\u00c9DIO' THEN 1 ELSE 0 END) AS qtde_medio,\\r\\n    SUM(CASE WHEN classificacao_risco_final = 'BAIXO' THEN 1 ELSE 0 END) AS qtde_baixo,\\r\\n    \\r\\n    -- Scores\\r\\n    ROUND(AVG(score_total), 2) AS score_medio,\\r\\n    ROUND(STDDEV(score_total), 2) AS desvio_padrao_score,\\r\\n    ROUND(MIN(score_total), 2) AS score_minimo,\\r\\n    ROUND(MAX(score_total), 2) AS score_maximo,\\r\\n    ROUND(APPX_MEDIAN(score_total), 2) AS mediana_score,\\r\\n    -- Nota: Impala n\\u00e3o suporta PERCENTILE_APPROX, usar subqueries se necess\\u00e1rio\\r\\n    -- Para an\\u00e1lise de distribui\\u00e7\\u00e3o, considerar quartis via subquery separada\\r\\n    \\r\\n    -- Status Atual\\r\\n    SUM(flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    COUNT(*) - SUM(flag_atualmente_cancelada) AS reativadas,\\r\\n    ROUND(SUM(flag_atualmente_cancelada) * 100.0 / COUNT(*), 2) AS perc_canceladas,\\r\\n    \\r\\n    -- Reincid\\u00eancia\\r\\n    SUM(flag_empresa_reincidente) AS empresas_reincidentes,\\r\\n    ROUND(SUM(flag_empresa_reincidente) * 100.0 / COUNT(*), 2) AS perc_reincidentes,\\r\\n    \\r\\n    -- Cr\\u00e9dito\\r\\n    SUM(saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS saldo_medio,\\r\\n    SUM(CASE WHEN saldo_credor_atual > 1000000 THEN 1 ELSE 0 END) AS empresas_saldo_acima_1M,\\r\\n    SUM(CASE WHEN saldo_credor_atual > 10000000 THEN 1 ELSE 0 END) AS empresas_saldo_acima_10M,\\r\\n    \\r\\n    -- Ind\\u00edcios\\r\\n    SUM(flag_tem_indicios) AS com_indicios,\\r\\n    SUM(flag_tem_indicios_graves) AS com_indicios_graves,\\r\\n    SUM(qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(CASE WHEN flag_tem_indicios = 1 THEN qtde_indicios END), 2) AS media_indicios_quando_tem\\r\\n\\r\\nFROM teste.luciano_scores;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 3. AN\\u00c1LISE POR CLASSIFICA\\u00c7\\u00c3O DE RISCO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR CLASSIFICA\\u00c7\\u00c3O DE RISCO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_final,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    -- Scores m\\u00e9dios\\r\\n    ROUND(AVG(score_total), 2) AS score_total_medio,\\r\\n    ROUND(AVG(score_comportamento), 2) AS score_comportamento_medio,\\r\\n    ROUND(AVG(score_credito), 2) AS score_credito_medio,\\r\\n    ROUND(AVG(score_indicios), 2) AS score_indicios_medio,\\r\\n    \\r\\n    -- Protocolos\\r\\n    SUM(total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    -- Status\\r\\n    SUM(flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    \\r\\n    -- Cr\\u00e9dito\\r\\n    SUM(saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS saldo_medio,\\r\\n    MAX(saldo_credor_atual) AS saldo_maximo,\\r\\n    \\r\\n    -- Ind\\u00edcios\\r\\n    SUM(qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(qtde_indicios), 2) AS media_indicios,\\r\\n    SUM(qtde_indicios_graves) AS indicios_graves,\\r\\n    \\r\\n    -- Flags de alerta\\r\\n    SUM(flag_saldo_alto_cancelada) AS flag_saldo_alto,\\r\\n    SUM(flag_suspeita_valores_repetidos) AS flag_valores_repetidos\\r\\n\\r\\nFROM teste.luciano_scores\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 4. AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O MENSAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O MENSAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    periodo_cancelamento,\\r\\n    ano_cancelamento,\\r\\n    mes_cancelamento,\\r\\n    \\r\\n    qtde_protocolos,\\r\\n    qtde_empresas_distintas,\\r\\n    qtde_usuarios_distintos,\\r\\n    \\r\\n    qtde_automaticos,\\r\\n    qtde_manuais,\\r\\n    ROUND(qtde_automaticos * 100.0 / qtde_protocolos, 2) AS perc_automaticos,\\r\\n    \\r\\n    qtde_ainda_canceladas,\\r\\n    qtde_reativadas,\\r\\n    taxa_permanencia_perc,\\r\\n    taxa_reativacao_perc,\\r\\n    \\r\\n    ROUND(media_dias_ate_reativacao, 0) AS dias_medios_reativacao,\\r\\n    \\r\\n    -- Comparativo com per\\u00edodo anterior\\r\\n    LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento) AS protocolos_periodo_anterior,\\r\\n    ROUND(\\r\\n        (qtde_protocolos - LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento)) * 100.0 /\\r\\n        NULLIF(LAG(qtde_protocolos) OVER (ORDER BY ano_cancelamento, mes_cancelamento), 0),\\r\\n        2\\r\\n    ) AS variacao_perc_protocolos,\\r\\n    \\r\\n    -- M\\u00e9dia m\\u00f3vel 3 meses\\r\\n    ROUND(AVG(qtde_protocolos) OVER (\\r\\n        ORDER BY ano_cancelamento, mes_cancelamento \\r\\n        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\\r\\n    ), 2) AS media_movel_3m\\r\\n\\r\\nFROM teste.luciano_temporal\\r\\nORDER BY ano_cancelamento DESC, mes_cancelamento DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 5. AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O ANUAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE TEMPORAL - EVOLU\\u00c7\\u00c3O ANUAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    ano_cancelamento,\\r\\n    \\r\\n    SUM(qtde_protocolos) AS total_protocolos,\\r\\n    SUM(qtde_empresas_distintas) AS empresas_distintas,\\r\\n    \\r\\n    SUM(qtde_automaticos) AS total_automaticos,\\r\\n    SUM(qtde_manuais) AS total_manuais,\\r\\n    ROUND(SUM(qtde_automaticos) * 100.0 / SUM(qtde_protocolos), 2) AS perc_automaticos,\\r\\n    \\r\\n    SUM(qtde_ainda_canceladas) AS total_ainda_canceladas,\\r\\n    SUM(qtde_reativadas) AS total_reativadas,\\r\\n    ROUND(SUM(qtde_ainda_canceladas) * 100.0 / SUM(qtde_protocolos), 2) AS taxa_permanencia_anual,\\r\\n    \\r\\n    COUNT(DISTINCT periodo_cancelamento) AS meses_com_atividade,\\r\\n    ROUND(AVG(qtde_protocolos), 2) AS media_mensal_protocolos,\\r\\n    MAX(qtde_protocolos) AS pico_mensal,\\r\\n    \\r\\n    -- Comparativo ano anterior\\r\\n    LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento) AS protocolos_ano_anterior,\\r\\n    ROUND(\\r\\n        (SUM(qtde_protocolos) - LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento)) * 100.0 /\\r\\n        NULLIF(LAG(SUM(qtde_protocolos)) OVER (ORDER BY ano_cancelamento), 0),\\r\\n        2\\r\\n    ) AS variacao_anual_perc\\r\\n\\r\\nFROM teste.luciano_temporal\\r\\nGROUP BY ano_cancelamento\\r\\nORDER BY ano_cancelamento DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 6. AN\\u00c1LISE POR REGI\\u00c3O/MUNIC\\u00cdPIO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR MUNIC\\u00cdPIO - TOP 20 ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.municipio,\\r\\n    m.uf,\\r\\n    m.gerencia_regional,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS empresas_alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    \\r\\n    SUM(CASE WHEN m.flag_empresa_reincidente = 1 THEN 1 ELSE 0 END) AS reincidentes,\\r\\n    \\r\\n    COUNT(DISTINCT m.cd_cnae) AS diversidade_cnaes\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nLEFT JOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nWHERE m.municipio IS NOT NULL\\r\\nGROUP BY m.municipio, m.uf, m.gerencia_regional\\r\\nHAVING COUNT(DISTINCT m.cnpj) >= 5\\r\\nORDER BY qtde_empresas DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 7. AN\\u00c1LISE POR GER\\u00caNCIA REGIONAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR GER\\u00caNCIA REGIONAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.gerencia_regional,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    COUNT(DISTINCT m.municipio) AS qtde_municipios,\\r\\n    COUNT(DISTINCT m.cd_cnae) AS qtde_cnaes,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS risco_alto,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_credor_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_credor_medio,\\r\\n    \\r\\n    SUM(i.qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(i.qtde_indicios), 2) AS media_indicios\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nLEFT JOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON m.cnpj = i.cnpj\\r\\nWHERE m.gerencia_regional IS NOT NULL\\r\\nGROUP BY m.gerencia_regional\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 8. AN\\u00c1LISE POR CNAE (ATIVIDADE ECON\\u00d4MICA)\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR CNAE - TOP 15 ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.cd_cnae,\\r\\n    MAX(m.descricao_cnae) AS descricao_cnae,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    ROUND(AVG(s.score_comportamento), 2) AS score_comportamento,\\r\\n    ROUND(AVG(s.score_credito), 2) AS score_credito,\\r\\n    ROUND(AVG(s.score_indicios), 2) AS score_indicios,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio,\\r\\n    \\r\\n    SUM(i.qtde_indicios) AS total_indicios,\\r\\n    SUM(i.qtde_indicios_graves) AS indicios_graves,\\r\\n    \\r\\n    SUM(m.flag_empresa_reincidente) AS reincidentes,\\r\\n    ROUND(SUM(m.flag_empresa_reincidente) * 100.0 / COUNT(*), 2) AS perc_reincidentes\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nLEFT JOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON m.cnpj = i.cnpj\\r\\nWHERE m.cd_cnae IS NOT NULL\\r\\nGROUP BY m.cd_cnae\\r\\nHAVING COUNT(DISTINCT m.cnpj) >= 10\\r\\nORDER BY qtde_empresas DESC\\r\\nLIMIT 15;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 9. AN\\u00c1LISE DE CR\\u00c9DITO DETALHADA\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE CR\\u00c9DITO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    -- Faixas de saldo credor\\r\\n    CASE \\r\\n        WHEN saldo_credor_atual <= 0 THEN '0 - Sem saldo'\\r\\n        WHEN saldo_credor_atual <= 10000 THEN '1 - At\\u00e9 10k'\\r\\n        WHEN saldo_credor_atual <= 100000 THEN '2 - 10k a 100k'\\r\\n        WHEN saldo_credor_atual <= 500000 THEN '3 - 100k a 500k'\\r\\n        WHEN saldo_credor_atual <= 1000000 THEN '4 - 500k a 1M'\\r\\n        WHEN saldo_credor_atual <= 10000000 THEN '5 - 1M a 10M'\\r\\n        ELSE '6 - Acima de 10M'\\r\\n    END AS faixa_saldo,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(saldo_credor_atual) AS saldo_total_faixa,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS saldo_medio,\\r\\n    \\r\\n    SUM(vl_credito_60m) AS credito_60m_total,\\r\\n    SUM(vl_credito_presumido_60m) AS credito_presumido_total,\\r\\n    \\r\\n    SUM(flag_saldo_alto_cancelada) AS flag_saldo_alto,\\r\\n    SUM(flag_suspeita_valores_repetidos) AS flag_valores_repetidos,\\r\\n    SUM(flag_saldo_sem_declaracao) AS flag_sem_declaracao,\\r\\n    SUM(flag_credito_muito_estavel) AS flag_muito_estavel,\\r\\n    SUM(flag_crescimento_anormal_saldo) AS flag_crescimento_anormal,\\r\\n    \\r\\n    -- Total de flags\\r\\n    SUM(flag_saldo_alto_cancelada + flag_suspeita_valores_repetidos + \\r\\n        flag_saldo_sem_declaracao + flag_credito_muito_estavel + \\r\\n        flag_crescimento_anormal_saldo) AS total_alertas\\r\\n\\r\\nFROM teste.luciano_credito\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN saldo_credor_atual <= 0 THEN '0 - Sem saldo'\\r\\n        WHEN saldo_credor_atual <= 10000 THEN '1 - At\\u00e9 10k'\\r\\n        WHEN saldo_credor_atual <= 100000 THEN '2 - 10k a 100k'\\r\\n        WHEN saldo_credor_atual <= 500000 THEN '3 - 100k a 500k'\\r\\n        WHEN saldo_credor_atual <= 1000000 THEN '4 - 500k a 1M'\\r\\n        WHEN saldo_credor_atual <= 10000000 THEN '5 - 1M a 10M'\\r\\n        ELSE '6 - Acima de 10M'\\r\\n    END\\r\\nORDER BY faixa_saldo;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 10. EMPRESAS COM MAIOR SALDO CREDOR CANCELADAS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== TOP 20 EMPRESAS - SALDO CREDOR EM RISCO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    c.cnpj,\\r\\n    c.nome_contribuinte,\\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    \\r\\n    c.saldo_credor_atual,\\r\\n    c.vl_credito_60m,\\r\\n    c.vl_credito_presumido_60m,\\r\\n    c.vl_saldo_credor_60m,\\r\\n    \\r\\n    c.perc_valores_iguais_12m,\\r\\n    c.variacao_saldo_perc_60m,\\r\\n    \\r\\n    m.total_protocolos,\\r\\n    m.taxa_permanencia_cancelamento_perc,\\r\\n    m.classificacao_frequencia,\\r\\n    \\r\\n    i.qtde_indicios,\\r\\n    i.classificacao_risco_indicios,\\r\\n    \\r\\n    -- Flags de alerta\\r\\n    c.flag_saldo_alto_cancelada,\\r\\n    c.flag_suspeita_valores_repetidos,\\r\\n    c.flag_saldo_sem_declaracao,\\r\\n    c.flag_crescimento_anormal_saldo\\r\\n\\r\\nFROM teste.luciano_credito c\\r\\nJOIN teste.luciano_scores s ON c.cnpj = s.cnpj\\r\\nJOIN teste.luciano_metricas m ON c.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON c.cnpj = i.cnpj\\r\\nWHERE s.flag_atualmente_cancelada = 1\\r\\n    AND c.saldo_credor_atual > 0\\r\\nORDER BY c.saldo_credor_atual DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 11. AN\\u00c1LISE DE IND\\u00cdCIOS DETALHADA\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE IND\\u00cdCIOS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_indicios,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(qtde_indicios) AS total_indicios,\\r\\n    ROUND(AVG(qtde_indicios), 2) AS media_indicios,\\r\\n    MAX(qtde_indicios) AS max_indicios,\\r\\n    \\r\\n    SUM(qtde_indicios_graves) AS total_graves,\\r\\n    ROUND(AVG(qtde_indicios_graves), 2) AS media_graves,\\r\\n    \\r\\n    SUM(soma_scores_indicios) AS soma_total_scores,\\r\\n    ROUND(AVG(soma_scores_indicios), 2) AS media_scores,\\r\\n    \\r\\n    -- Por categoria\\r\\n    SUM(qtde_indicios_docs_fiscais) AS indicios_docs_fiscais,\\r\\n    SUM(qtde_indicios_relacionamentos) AS indicios_relacionamentos,\\r\\n    SUM(qtde_indicios_declaracoes) AS indicios_declaracoes,\\r\\n    SUM(qtde_indicios_cadastro) AS indicios_cadastro,\\r\\n    \\r\\n    -- Flags\\r\\n    SUM(flag_tem_indicios) AS com_indicios,\\r\\n    SUM(flag_tem_indicios_graves) AS com_indicios_graves\\r\\n\\r\\nFROM teste.luciano_indicios\\r\\nGROUP BY classificacao_risco_indicios\\r\\nORDER BY \\r\\n    CASE classificacao_risco_indicios\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n        WHEN 'SEM_INDICIOS' THEN 5\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 12. EMPRESAS COM MAIS IND\\u00cdCIOS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== TOP 20 EMPRESAS - MAIS IND\\u00cdCIOS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    i.cnpj,\\r\\n    i.nome_contribuinte,\\r\\n    i.classificacao_risco_indicios,\\r\\n    \\r\\n    i.qtde_indicios,\\r\\n    i.qtde_tipos_indicios_distintos,\\r\\n    i.soma_scores_indicios,\\r\\n    i.qtde_indicios_graves,\\r\\n    \\r\\n    i.qtde_indicios_docs_fiscais,\\r\\n    i.qtde_indicios_relacionamentos,\\r\\n    i.qtde_indicios_declaracoes,\\r\\n    i.qtde_indicios_cadastro,\\r\\n    \\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    \\r\\n    c.saldo_credor_atual,\\r\\n    \\r\\n    m.total_protocolos,\\r\\n    m.taxa_permanencia_cancelamento_perc\\r\\n\\r\\nFROM teste.luciano_indicios i\\r\\nJOIN teste.luciano_scores s ON i.cnpj = s.cnpj\\r\\nJOIN teste.luciano_metricas m ON i.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON i.cnpj = c.cnpj\\r\\nWHERE i.qtde_indicios > 0\\r\\nORDER BY i.soma_scores_indicios DESC, i.qtde_indicios DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 13. AN\\u00c1LISE DE DESEMPENHO DOS FISCAIS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE DESEMPENHO DOS FISCAIS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    matricula_fiscal,\\r\\n    nome_fiscal,\\r\\n    \\r\\n    qtde_protocolos_fiscal,\\r\\n    qtde_empresas_distintas,\\r\\n    anos_atuacao,\\r\\n    \\r\\n    qtde_cancelamentos_efetivos,\\r\\n    taxa_efetividade_perc,\\r\\n    taxa_reativacao_perc,\\r\\n    \\r\\n    ROUND(media_dias_processamento, 1) AS dias_processamento_medio,\\r\\n    \\r\\n    ROUND(media_protocolos_por_empresa, 2) AS media_protocolos_empresa,\\r\\n    qtde_casos_reincidentes,\\r\\n    \\r\\n    qtde_individuais,\\r\\n    qtde_massivos,\\r\\n    \\r\\n    -- M\\u00e9tricas do fiscal\\r\\n    total_chats,\\r\\n    total_observacoes,\\r\\n    perc_dedicacao_malhas,\\r\\n    \\r\\n    -- Per\\u00edodo de atua\\u00e7\\u00e3o\\r\\n    data_primeiro_protocolo,\\r\\n    data_ultimo_protocolo,\\r\\n    DATEDIFF(data_ultimo_protocolo, data_primeiro_protocolo) AS dias_atuacao\\r\\n\\r\\nFROM teste.luciano_fiscal\\r\\nORDER BY qtde_protocolos_fiscal DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 14. RANKING FISCAIS - EFETIVIDADE\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== RANKING FISCAIS - MAIOR EFETIVIDADE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    ROW_NUMBER() OVER (ORDER BY taxa_efetividade_perc DESC, qtde_protocolos_fiscal DESC) AS ranking,\\r\\n    matricula_fiscal,\\r\\n    nome_fiscal,\\r\\n    qtde_protocolos_fiscal,\\r\\n    qtde_cancelamentos_efetivos,\\r\\n    taxa_efetividade_perc,\\r\\n    taxa_reativacao_perc,\\r\\n    ROUND(media_dias_processamento, 1) AS dias_processamento,\\r\\n    qtde_casos_reincidentes\\r\\n\\r\\nFROM teste.luciano_fiscal\\r\\nWHERE qtde_protocolos_fiscal >= 10\\r\\nORDER BY taxa_efetividade_perc DESC, qtde_protocolos_fiscal DESC\\r\\nLIMIT 15;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 15. AN\\u00c1LISE CRUZADA: RISCO x CR\\u00c9DITO x IND\\u00cdCIOS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== MATRIZ RISCO x CR\\u00c9DITO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.classificacao_risco_final,\\r\\n    \\r\\n    -- Faixas de cr\\u00e9dito\\r\\n    SUM(CASE WHEN c.saldo_credor_atual <= 0 THEN 1 ELSE 0 END) AS sem_saldo,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 0 AND c.saldo_credor_atual <= 100000 THEN 1 ELSE 0 END) AS ate_100k,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 100000 AND c.saldo_credor_atual <= 1000000 THEN 1 ELSE 0 END) AS de_100k_a_1M,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 1000000 THEN 1 ELSE 0 END) AS acima_1M,\\r\\n    \\r\\n    COUNT(*) AS total,\\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nGROUP BY s.classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE s.classificacao_risco_final\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 16. AN\\u00c1LISE DE REINCID\\u00caNCIA\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE REINCID\\u00caNCIA ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    CASE \\r\\n        WHEN m.total_protocolos = 1 THEN '1 - \\u00danico protocolo'\\r\\n        WHEN m.total_protocolos = 2 THEN '2 - Dois protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 3 AND 5 THEN '3 - De 3 a 5 protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 6 AND 10 THEN '4 - De 6 a 10 protocolos'\\r\\n        ELSE '5 - Mais de 10 protocolos'\\r\\n    END AS faixa_protocolos,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos_grupo,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    ROUND(AVG(m.taxa_reativacao_perc), 2) AS taxa_reativacao_media,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    SUM(s.flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    \\r\\n    SUM(s.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(s.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN m.total_protocolos = 1 THEN '1 - \\u00danico protocolo'\\r\\n        WHEN m.total_protocolos = 2 THEN '2 - Dois protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 3 AND 5 THEN '3 - De 3 a 5 protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 6 AND 10 THEN '4 - De 6 a 10 protocolos'\\r\\n        ELSE '5 - Mais de 10 protocolos'\\r\\n    END\\r\\nORDER BY faixa_protocolos;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 17. ALERTAS CR\\u00cdTICOS - CASOS PRIORIT\\u00c1RIOS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== ALERTAS CR\\u00cdTICOS - CASOS PRIORIT\\u00c1RIOS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.cnpj,\\r\\n    s.nome_contribuinte,\\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    s.ranking_fiscalizacao,\\r\\n    \\r\\n    -- Motivos do alerta\\r\\n    CONCAT(\\r\\n        CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN '[RISCO_CR\\u00cdTICO] ' ELSE '' END,\\r\\n        CASE WHEN c.saldo_credor_atual > 1000000 AND s.flag_atualmente_cancelada = 1 THEN '[SALDO>1M_CANCELADA] ' ELSE '' END,\\r\\n        CASE WHEN i.qtde_indicios_graves >= 3 THEN '[IND\\u00cdCIOS_GRAVES>=3] ' ELSE '' END,\\r\\n        CASE WHEN m.total_protocolos >= 5 THEN '[MUITO_REINCIDENTE] ' ELSE '' END,\\r\\n        CASE WHEN c.flag_crescimento_anormal_saldo = 1 THEN '[CRESCIMENTO_ANORMAL] ' ELSE '' END,\\r\\n        CASE WHEN c.perc_valores_iguais_12m >= 80 THEN '[VALORES_REPETIDOS] ' ELSE '' END\\r\\n    ) AS alertas,\\r\\n    \\r\\n    m.total_protocolos,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    c.saldo_credor_atual,\\r\\n    i.qtde_indicios,\\r\\n    i.qtde_indicios_graves,\\r\\n    \\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON s.cnpj = i.cnpj\\r\\nWHERE \\r\\n    s.classificacao_risco_final = 'CR\\u00cdTICO'\\r\\n    OR (c.saldo_credor_atual > 1000000 AND s.flag_atualmente_cancelada = 1)\\r\\n    OR i.qtde_indicios_graves >= 3\\r\\n    OR (m.total_protocolos >= 5 AND s.flag_atualmente_cancelada = 1)\\r\\nORDER BY s.score_total DESC, c.saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 18. PADR\\u00d5ES DE CANCELAMENTO (AUTOM\\u00c1TICO vs MANUAL)\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE PADR\\u00c3O DE CANCELAMENTO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.padrao_cancelamento_predominante,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(m.qtde_automaticos) AS total_automaticos,\\r\\n    SUM(m.qtde_manuais) AS total_manuais,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia,\\r\\n    ROUND(AVG(m.taxa_reativacao_perc), 2) AS taxa_reativacao,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    SUM(m.flag_empresa_reincidente) AS reincidentes\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nGROUP BY m.padrao_cancelamento_predominante;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 19. EFETIVIDADE DO CANCELAMENTO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE EFETIVIDADE DO CANCELAMENTO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.efetividade_cancelamento,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    ROUND(AVG(m.dias_medios_reativacao), 0) AS dias_medios_reativacao,\\r\\n    \\r\\n    SUM(m.flag_empresa_reincidente) AS reincidentes,\\r\\n    ROUND(SUM(m.flag_empresa_reincidente) * 100.0 / COUNT(*), 2) AS perc_reincidentes,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nGROUP BY m.efetividade_cancelamento\\r\\nORDER BY \\r\\n    CASE m.efetividade_cancelamento\\r\\n        WHEN 'EFETIVO' THEN 1\\r\\n        WHEN 'PARCIALMENTE_EFETIVO' THEN 2\\r\\n        WHEN 'POUCO_EFETIVO' THEN 3\\r\\n        WHEN 'INEFETIVO' THEN 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 20. COMPARATIVO AUTOM\\u00c1TICO vs MANUAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== COMPARATIVO AUTOM\\u00c1TICO vs MANUAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    'AUTOM\\u00c1TICO' AS tipo_cancelamento,\\r\\n    COUNT(DISTINCT b.cnpj) AS empresas_afetadas,\\r\\n    COUNT(*) AS total_eventos,\\r\\n    SUM(b.flag_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(SUM(b.flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_permanencia,\\r\\n    SUM(b.flag_reativada) AS reativadas,\\r\\n    ROUND(AVG(b.dias_desde_cancelamento), 0) AS dias_medios\\r\\nFROM teste.luciano_base b\\r\\nWHERE b.flag_cancelamento_automatico = 1\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'MANUAL' AS tipo_cancelamento,\\r\\n    COUNT(DISTINCT b.cnpj) AS empresas_afetadas,\\r\\n    COUNT(*) AS total_eventos,\\r\\n    SUM(b.flag_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(SUM(b.flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_permanencia,\\r\\n    SUM(b.flag_reativada) AS reativadas,\\r\\n    ROUND(AVG(b.dias_desde_cancelamento), 0) AS dias_medios\\r\\nFROM teste.luciano_base b\\r\\nWHERE b.flag_cancelamento_automatico = 0;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 21. AN\\u00c1LISE DE TIPO DE CONTRIBUINTE\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR TIPO DE CONTRIBUINTE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.tipo_contribuinte,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nWHERE m.tipo_contribuinte IS NOT NULL\\r\\nGROUP BY m.tipo_contribuinte\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 22. AN\\u00c1LISE POR REGIME DE APURA\\u00c7\\u00c3O\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR REGIME DE APURA\\u00c7\\u00c3O ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.regime_apuracao,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS risco_alto,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    SUM(c.vl_credito_presumido_60m) AS credito_presumido_total,\\r\\n    \\r\\n    SUM(i.qtde_indicios) AS total_indicios\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON m.cnpj = i.cnpj\\r\\nWHERE m.regime_apuracao IS NOT NULL\\r\\nGROUP BY m.regime_apuracao\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 23. TOP 100 COMPLETO COM TODAS AS M\\u00c9TRICAS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== TOP 100 - PRIORIDADE DE FISCALIZA\\u00c7\\u00c3O ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    ranking_fiscalizacao,\\r\\n    cnpj,\\r\\n    nome_contribuinte,\\r\\n    razao_social,\\r\\n    cd_cnae,\\r\\n    municipio,\\r\\n    uf,\\r\\n    \\r\\n    classificacao_risco_final,\\r\\n    score_total,\\r\\n    score_comportamento,\\r\\n    score_credito,\\r\\n    score_indicios,\\r\\n    \\r\\n    total_protocolos,\\r\\n    taxa_permanencia_cancelamento_perc,\\r\\n    classificacao_frequencia,\\r\\n    efetividade_cancelamento,\\r\\n    \\r\\n    flag_atualmente_cancelada,\\r\\n    flag_empresa_reincidente,\\r\\n    \\r\\n    saldo_credor_atual,\\r\\n    vl_credito_60m,\\r\\n    \\r\\n    qtde_indicios,\\r\\n    qtde_indicios_graves,\\r\\n    classificacao_risco_indicios,\\r\\n    \\r\\n    -- Flags de alerta\\r\\n    flag_saldo_alto_cancelada,\\r\\n    flag_suspeita_valores_repetidos,\\r\\n    flag_tem_indicios_graves,\\r\\n    \\r\\n    padrao_cancelamento_predominante,\\r\\n    data_primeiro_cancelamento,\\r\\n    data_ultimo_cancelamento\\r\\n\\r\\nFROM teste.luciano_top100\\r\\nORDER BY ranking_fiscalizacao;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 24. SUM\\u00c1RIO ESTAT\\u00cdSTICO FINAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== SUM\\u00c1RIO ESTAT\\u00cdSTICO FINAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    -- Volume\\r\\n    'VOLUME' AS categoria,\\r\\n    'Total de Empresas' AS metrica,\\r\\n    CAST(COUNT(DISTINCT cnpj) AS STRING) AS valor\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'VOLUME', 'Total de Protocolos', CAST(SUM(total_protocolos) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'VOLUME', 'M\\u00e9dia Protocolos/Empresa', CAST(ROUND(AVG(total_protocolos), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'RISCO', 'Empresas Cr\\u00edtico', CONCAT(CAST(SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS STRING), ' (', CAST(ROUND(SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'RISCO', 'Empresas Alto', CONCAT(CAST(SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS STRING), ' (', CAST(ROUND(SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'SCORE', 'Score M\\u00e9dio', CAST(ROUND(AVG(score_total), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'SCORE', 'Score M\\u00e1ximo', CAST(ROUND(MAX(score_total), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'STATUS', 'Ainda Canceladas', CONCAT(CAST(SUM(flag_atualmente_cancelada) AS STRING), ' (', CAST(ROUND(SUM(flag_atualmente_cancelada) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'STATUS', 'Reincidentes', CONCAT(CAST(SUM(flag_empresa_reincidente) AS STRING), ' (', CAST(ROUND(SUM(flag_empresa_reincidente) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'CR\\u00c9DITO', 'Saldo Credor Total', CONCAT('R$ ', CAST(ROUND(SUM(saldo_credor_atual), 2) AS STRING))\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'CR\\u00c9DITO', 'Saldo Credor M\\u00e9dio', CONCAT('R$ ', CAST(ROUND(AVG(saldo_credor_atual), 2) AS STRING))\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'IND\\u00cdCIOS', 'Empresas com Ind\\u00edcios', CONCAT(CAST(SUM(flag_tem_indicios) AS STRING), ' (', CAST(ROUND(SUM(flag_tem_indicios) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'IND\\u00cdCIOS', 'Total de Ind\\u00edcios', CAST(SUM(qtde_indicios) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'ALERTAS', 'Saldo Alto + Cancelada', CAST(SUM(flag_saldo_alto_cancelada) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'ALERTAS', 'Valores Suspeitos', CAST(SUM(flag_suspeita_valores_repetidos) AS STRING)\\r\\nFROM teste.luciano_scores;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 25. QUERY PARA EXPORTA\\u00c7\\u00c3O - LISTA COMPLETA PARA EXCEL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== EXPORTA\\u00c7\\u00c3O COMPLETA PARA AN\\u00c1LISE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.ranking_fiscalizacao,\\r\\n    s.cnpj,\\r\\n    s.nome_contribuinte,\\r\\n    m.razao_social,\\r\\n    m.cd_cnae,\\r\\n    m.descricao_cnae,\\r\\n    m.municipio,\\r\\n    m.uf,\\r\\n    m.gerencia_regional,\\r\\n    m.tipo_contribuinte,\\r\\n    m.regime_apuracao,\\r\\n    m.grupo_economico,\\r\\n    \\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    s.score_comportamento,\\r\\n    s.score_credito,\\r\\n    s.score_indicios,\\r\\n    \\r\\n    s.total_protocolos,\\r\\n    m.anos_distintos_cancelamento,\\r\\n    m.qtde_usuarios_distintos,\\r\\n    m.qtde_automaticos,\\r\\n    m.qtde_manuais,\\r\\n    m.padrao_cancelamento_predominante,\\r\\n    \\r\\n    s.taxa_permanencia_cancelamento_perc,\\r\\n    s.taxa_reativacao_perc,\\r\\n    s.classificacao_frequencia,\\r\\n    s.classificacao_persistencia,\\r\\n    s.efetividade_cancelamento,\\r\\n    \\r\\n    s.flag_empresa_reincidente,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    \\r\\n    c.saldo_credor_atual,\\r\\n    c.vl_credito_12m,\\r\\n    c.vl_credito_60m,\\r\\n    c.vl_credito_presumido_12m,\\r\\n    c.vl_credito_presumido_60m,\\r\\n    c.perc_valores_iguais_12m,\\r\\n    c.variacao_saldo_perc_60m,\\r\\n    c.flag_saldo_alto_cancelada,\\r\\n    c.flag_suspeita_valores_repetidos,\\r\\n    c.flag_saldo_sem_declaracao,\\r\\n    c.flag_crescimento_anormal_saldo,\\r\\n    \\r\\n    i.qtde_indicios,\\r\\n    i.qtde_tipos_indicios_distintos,\\r\\n    i.soma_scores_indicios,\\r\\n    i.qtde_indicios_graves,\\r\\n    i.classificacao_risco_indicios,\\r\\n    i.qtde_indicios_docs_fiscais,\\r\\n    i.qtde_indicios_relacionamentos,\\r\\n    i.qtde_indicios_declaracoes,\\r\\n    i.qtde_indicios_cadastro,\\r\\n    \\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento,\\r\\n    m.dias_entre_primeiro_ultimo,\\r\\n    m.media_dias_desde_cancelamento,\\r\\n    m.lista_fiscais_envolvidos\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON s.cnpj = i.cnpj\\r\\nORDER BY s.ranking_fiscalizacao;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- FIM DAS CONSULTAS ANAL\\u00cdTICAS\\r\\n-- =====================================================================\", \"result\": {\"id\": \"dd9f9ff6-0e32-c0ff-05eb-873e61c89e9d\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"has_more_statements\": true, \"statement_id\": 23, \"statements_count\": 25, \"previous_statement_hash\": \"f3aea2dd3c5de204e35cca19448d7750d662ea7a952e1f60229f1736\"}, \"meta\": [], \"rows\": 48548, \"hasMore\": false, \"statement_id\": 23, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 25, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-11-25T21:46:26.918Z\", \"endTime\": \"2025-11-25T21:46:26.918Z\", \"executionTime\": 0, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"cnpj\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"score_total\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1764107186902, \"lastAceSelectionRowOffset\": 606, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"\\r\\n-- =====================================================================\\r\\n-- 14. RANKING FISCAIS - EFETIVIDADE\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== RANKING FISCAIS - MAIOR EFETIVIDADE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    ROW_NUMBER() OVER (ORDER BY taxa_efetividade_perc DESC, qtde_protocolos_fiscal DESC) AS ranking,\\r\\n    matricula_fiscal,\\r\\n    nome_fiscal,\\r\\n    qtde_protocolos_fiscal,\\r\\n    qtde_cancelamentos_efetivos,\\r\\n    taxa_efetividade_perc,\\r\\n    taxa_reativacao_perc,\\r\\n    ROUND(media_dias_processamento, 1) AS dias_processamento,\\r\\n    qtde_casos_reincidentes\\r\\n\\r\\nFROM teste.luciano_fiscal\\r\\nWHERE qtde_protocolos_fiscal >= 10\\r\\nORDER BY taxa_efetividade_perc DESC, qtde_protocolos_fiscal DESC\\r\\nLIMIT 15;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 15. AN\\u00c1LISE CRUZADA: RISCO x CR\\u00c9DITO x IND\\u00cdCIOS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== MATRIZ RISCO x CR\\u00c9DITO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.classificacao_risco_final,\\r\\n    \\r\\n    -- Faixas de cr\\u00e9dito\\r\\n    SUM(CASE WHEN c.saldo_credor_atual <= 0 THEN 1 ELSE 0 END) AS sem_saldo,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 0 AND c.saldo_credor_atual <= 100000 THEN 1 ELSE 0 END) AS ate_100k,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 100000 AND c.saldo_credor_atual <= 1000000 THEN 1 ELSE 0 END) AS de_100k_a_1M,\\r\\n    SUM(CASE WHEN c.saldo_credor_atual > 1000000 THEN 1 ELSE 0 END) AS acima_1M,\\r\\n    \\r\\n    COUNT(*) AS total,\\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nGROUP BY s.classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE s.classificacao_risco_final\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 16. AN\\u00c1LISE DE REINCID\\u00caNCIA\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE DE REINCID\\u00caNCIA ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    CASE \\r\\n        WHEN m.total_protocolos = 1 THEN '1 - \\u00danico protocolo'\\r\\n        WHEN m.total_protocolos = 2 THEN '2 - Dois protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 3 AND 5 THEN '3 - De 3 a 5 protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 6 AND 10 THEN '4 - De 6 a 10 protocolos'\\r\\n        ELSE '5 - Mais de 10 protocolos'\\r\\n    END AS faixa_protocolos,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos_grupo,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    ROUND(AVG(m.taxa_reativacao_perc), 2) AS taxa_reativacao_media,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    SUM(s.flag_atualmente_cancelada) AS ainda_canceladas,\\r\\n    \\r\\n    SUM(s.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(s.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN m.total_protocolos = 1 THEN '1 - \\u00danico protocolo'\\r\\n        WHEN m.total_protocolos = 2 THEN '2 - Dois protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 3 AND 5 THEN '3 - De 3 a 5 protocolos'\\r\\n        WHEN m.total_protocolos BETWEEN 6 AND 10 THEN '4 - De 6 a 10 protocolos'\\r\\n        ELSE '5 - Mais de 10 protocolos'\\r\\n    END\\r\\nORDER BY faixa_protocolos;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 17. ALERTAS CR\\u00cdTICOS - CASOS PRIORIT\\u00c1RIOS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== ALERTAS CR\\u00cdTICOS - CASOS PRIORIT\\u00c1RIOS ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.cnpj,\\r\\n    s.nome_contribuinte,\\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    s.ranking_fiscalizacao,\\r\\n    \\r\\n    -- Motivos do alerta\\r\\n    CONCAT(\\r\\n        CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN '[RISCO_CR\\u00cdTICO] ' ELSE '' END,\\r\\n        CASE WHEN c.saldo_credor_atual > 1000000 AND s.flag_atualmente_cancelada = 1 THEN '[SALDO>1M_CANCELADA] ' ELSE '' END,\\r\\n        CASE WHEN i.qtde_indicios_graves >= 3 THEN '[IND\\u00cdCIOS_GRAVES>=3] ' ELSE '' END,\\r\\n        CASE WHEN m.total_protocolos >= 5 THEN '[MUITO_REINCIDENTE] ' ELSE '' END,\\r\\n        CASE WHEN c.flag_crescimento_anormal_saldo = 1 THEN '[CRESCIMENTO_ANORMAL] ' ELSE '' END,\\r\\n        CASE WHEN c.perc_valores_iguais_12m >= 80 THEN '[VALORES_REPETIDOS] ' ELSE '' END\\r\\n    ) AS alertas,\\r\\n    \\r\\n    m.total_protocolos,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    c.saldo_credor_atual,\\r\\n    i.qtde_indicios,\\r\\n    i.qtde_indicios_graves,\\r\\n    \\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON s.cnpj = i.cnpj\\r\\nWHERE \\r\\n    s.classificacao_risco_final = 'CR\\u00cdTICO'\\r\\n    OR (c.saldo_credor_atual > 1000000 AND s.flag_atualmente_cancelada = 1)\\r\\n    OR i.qtde_indicios_graves >= 3\\r\\n    OR (m.total_protocolos >= 5 AND s.flag_atualmente_cancelada = 1)\\r\\nORDER BY s.score_total DESC, c.saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 18. PADR\\u00d5ES DE CANCELAMENTO (AUTOM\\u00c1TICO vs MANUAL)\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE PADR\\u00c3O DE CANCELAMENTO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.padrao_cancelamento_predominante,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(m.qtde_automaticos) AS total_automaticos,\\r\\n    SUM(m.qtde_manuais) AS total_manuais,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia,\\r\\n    ROUND(AVG(m.taxa_reativacao_perc), 2) AS taxa_reativacao,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    SUM(m.flag_empresa_reincidente) AS reincidentes\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nGROUP BY m.padrao_cancelamento_predominante;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 19. EFETIVIDADE DO CANCELAMENTO\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE EFETIVIDADE DO CANCELAMENTO ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.efetividade_cancelamento,\\r\\n    \\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS perc_total,\\r\\n    \\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    \\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia_media,\\r\\n    ROUND(AVG(m.dias_medios_reativacao), 0) AS dias_medios_reativacao,\\r\\n    \\r\\n    SUM(m.flag_empresa_reincidente) AS reincidentes,\\r\\n    ROUND(SUM(m.flag_empresa_reincidente) * 100.0 / COUNT(*), 2) AS perc_reincidentes,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nGROUP BY m.efetividade_cancelamento\\r\\nORDER BY \\r\\n    CASE m.efetividade_cancelamento\\r\\n        WHEN 'EFETIVO' THEN 1\\r\\n        WHEN 'PARCIALMENTE_EFETIVO' THEN 2\\r\\n        WHEN 'POUCO_EFETIVO' THEN 3\\r\\n        WHEN 'INEFETIVO' THEN 4\\r\\n    END;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 20. COMPARATIVO AUTOM\\u00c1TICO vs MANUAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== COMPARATIVO AUTOM\\u00c1TICO vs MANUAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    'AUTOM\\u00c1TICO' AS tipo_cancelamento,\\r\\n    COUNT(DISTINCT b.cnpj) AS empresas_afetadas,\\r\\n    COUNT(*) AS total_eventos,\\r\\n    SUM(b.flag_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(SUM(b.flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_permanencia,\\r\\n    SUM(b.flag_reativada) AS reativadas,\\r\\n    ROUND(AVG(b.dias_desde_cancelamento), 0) AS dias_medios\\r\\nFROM teste.luciano_base b\\r\\nWHERE b.flag_cancelamento_automatico = 1\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'MANUAL' AS tipo_cancelamento,\\r\\n    COUNT(DISTINCT b.cnpj) AS empresas_afetadas,\\r\\n    COUNT(*) AS total_eventos,\\r\\n    SUM(b.flag_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(SUM(b.flag_ainda_cancelada) * 100.0 / COUNT(*), 2) AS taxa_permanencia,\\r\\n    SUM(b.flag_reativada) AS reativadas,\\r\\n    ROUND(AVG(b.dias_desde_cancelamento), 0) AS dias_medios\\r\\nFROM teste.luciano_base b\\r\\nWHERE b.flag_cancelamento_automatico = 0;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 21. AN\\u00c1LISE DE TIPO DE CONTRIBUINTE\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR TIPO DE CONTRIBUINTE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.tipo_contribuinte,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    ROUND(AVG(m.total_protocolos), 2) AS media_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) AS alto_risco,\\r\\n    ROUND(SUM(CASE WHEN s.classificacao_risco_final IN ('CR\\u00cdTICO', 'ALTO') THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perc_alto_risco,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(m.qtde_ainda_cancelada) AS ainda_canceladas,\\r\\n    ROUND(AVG(m.taxa_permanencia_cancelamento_perc), 2) AS taxa_permanencia,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    ROUND(AVG(c.saldo_credor_atual), 2) AS saldo_medio\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nWHERE m.tipo_contribuinte IS NOT NULL\\r\\nGROUP BY m.tipo_contribuinte\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 22. AN\\u00c1LISE POR REGIME DE APURA\\u00c7\\u00c3O\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== AN\\u00c1LISE POR REGIME DE APURA\\u00c7\\u00c3O ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    m.regime_apuracao,\\r\\n    \\r\\n    COUNT(DISTINCT m.cnpj) AS qtde_empresas,\\r\\n    SUM(m.total_protocolos) AS total_protocolos,\\r\\n    \\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS risco_critico,\\r\\n    SUM(CASE WHEN s.classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS risco_alto,\\r\\n    \\r\\n    ROUND(AVG(s.score_total), 2) AS score_medio,\\r\\n    \\r\\n    SUM(c.saldo_credor_atual) AS saldo_total,\\r\\n    SUM(c.vl_credito_presumido_60m) AS credito_presumido_total,\\r\\n    \\r\\n    SUM(i.qtde_indicios) AS total_indicios\\r\\n\\r\\nFROM teste.luciano_metricas m\\r\\nJOIN teste.luciano_scores s ON m.cnpj = s.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON m.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON m.cnpj = i.cnpj\\r\\nWHERE m.regime_apuracao IS NOT NULL\\r\\nGROUP BY m.regime_apuracao\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 23. TOP 100 COMPLETO COM TODAS AS M\\u00c9TRICAS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== TOP 100 - PRIORIDADE DE FISCALIZA\\u00c7\\u00c3O ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    ranking_fiscalizacao,\\r\\n    cnpj,\\r\\n    nome_contribuinte,\\r\\n    razao_social,\\r\\n    cd_cnae,\\r\\n    municipio,\\r\\n    uf,\\r\\n    \\r\\n    classificacao_risco_final,\\r\\n    score_total,\\r\\n    score_comportamento,\\r\\n    score_credito,\\r\\n    score_indicios,\\r\\n    \\r\\n    total_protocolos,\\r\\n    taxa_permanencia_cancelamento_perc,\\r\\n    classificacao_frequencia,\\r\\n    efetividade_cancelamento,\\r\\n    \\r\\n    flag_atualmente_cancelada,\\r\\n    flag_empresa_reincidente,\\r\\n    \\r\\n    saldo_credor_atual,\\r\\n    vl_credito_60m,\\r\\n    \\r\\n    qtde_indicios,\\r\\n    qtde_indicios_graves,\\r\\n    classificacao_risco_indicios,\\r\\n    \\r\\n    -- Flags de alerta\\r\\n    flag_saldo_alto_cancelada,\\r\\n    flag_suspeita_valores_repetidos,\\r\\n    flag_tem_indicios_graves,\\r\\n    \\r\\n    padrao_cancelamento_predominante,\\r\\n    data_primeiro_cancelamento,\\r\\n    data_ultimo_cancelamento\\r\\n\\r\\nFROM teste.luciano_top100\\r\\nORDER BY ranking_fiscalizacao;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 24. SUM\\u00c1RIO ESTAT\\u00cdSTICO FINAL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== SUM\\u00c1RIO ESTAT\\u00cdSTICO FINAL ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    -- Volume\\r\\n    'VOLUME' AS categoria,\\r\\n    'Total de Empresas' AS metrica,\\r\\n    CAST(COUNT(DISTINCT cnpj) AS STRING) AS valor\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'VOLUME', 'Total de Protocolos', CAST(SUM(total_protocolos) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'VOLUME', 'M\\u00e9dia Protocolos/Empresa', CAST(ROUND(AVG(total_protocolos), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'RISCO', 'Empresas Cr\\u00edtico', CONCAT(CAST(SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) AS STRING), ' (', CAST(ROUND(SUM(CASE WHEN classificacao_risco_final = 'CR\\u00cdTICO' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'RISCO', 'Empresas Alto', CONCAT(CAST(SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) AS STRING), ' (', CAST(ROUND(SUM(CASE WHEN classificacao_risco_final = 'ALTO' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'SCORE', 'Score M\\u00e9dio', CAST(ROUND(AVG(score_total), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'SCORE', 'Score M\\u00e1ximo', CAST(ROUND(MAX(score_total), 2) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'STATUS', 'Ainda Canceladas', CONCAT(CAST(SUM(flag_atualmente_cancelada) AS STRING), ' (', CAST(ROUND(SUM(flag_atualmente_cancelada) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'STATUS', 'Reincidentes', CONCAT(CAST(SUM(flag_empresa_reincidente) AS STRING), ' (', CAST(ROUND(SUM(flag_empresa_reincidente) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'CR\\u00c9DITO', 'Saldo Credor Total', CONCAT('R$ ', CAST(ROUND(SUM(saldo_credor_atual), 2) AS STRING))\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'CR\\u00c9DITO', 'Saldo Credor M\\u00e9dio', CONCAT('R$ ', CAST(ROUND(AVG(saldo_credor_atual), 2) AS STRING))\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'IND\\u00cdCIOS', 'Empresas com Ind\\u00edcios', CONCAT(CAST(SUM(flag_tem_indicios) AS STRING), ' (', CAST(ROUND(SUM(flag_tem_indicios) * 100.0 / COUNT(*), 1) AS STRING), '%)')\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'IND\\u00cdCIOS', 'Total de Ind\\u00edcios', CAST(SUM(qtde_indicios) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'ALERTAS', 'Saldo Alto + Cancelada', CAST(SUM(flag_saldo_alto_cancelada) AS STRING)\\r\\nFROM teste.luciano_scores\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT 'ALERTAS', 'Valores Suspeitos', CAST(SUM(flag_suspeita_valores_repetidos) AS STRING)\\r\\nFROM teste.luciano_scores;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- 25. QUERY PARA EXPORTA\\u00c7\\u00c3O - LISTA COMPLETA PARA EXCEL\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT \\r\\n    '=== EXPORTA\\u00c7\\u00c3O COMPLETA PARA AN\\u00c1LISE ===' AS titulo;\\r\\n\\r\\nSELECT \\r\\n    s.ranking_fiscalizacao,\\r\\n    s.cnpj,\\r\\n    s.nome_contribuinte,\\r\\n    m.razao_social,\\r\\n    m.cd_cnae,\\r\\n    m.descricao_cnae,\\r\\n    m.municipio,\\r\\n    m.uf,\\r\\n    m.gerencia_regional,\\r\\n    m.tipo_contribuinte,\\r\\n    m.regime_apuracao,\\r\\n    m.grupo_economico,\\r\\n    \\r\\n    s.classificacao_risco_final,\\r\\n    s.score_total,\\r\\n    s.score_comportamento,\\r\\n    s.score_credito,\\r\\n    s.score_indicios,\\r\\n    \\r\\n    s.total_protocolos,\\r\\n    m.anos_distintos_cancelamento,\\r\\n    m.qtde_usuarios_distintos,\\r\\n    m.qtde_automaticos,\\r\\n    m.qtde_manuais,\\r\\n    m.padrao_cancelamento_predominante,\\r\\n    \\r\\n    s.taxa_permanencia_cancelamento_perc,\\r\\n    s.taxa_reativacao_perc,\\r\\n    s.classificacao_frequencia,\\r\\n    s.classificacao_persistencia,\\r\\n    s.efetividade_cancelamento,\\r\\n    \\r\\n    s.flag_empresa_reincidente,\\r\\n    s.flag_atualmente_cancelada,\\r\\n    \\r\\n    c.saldo_credor_atual,\\r\\n    c.vl_credito_12m,\\r\\n    c.vl_credito_60m,\\r\\n    c.vl_credito_presumido_12m,\\r\\n    c.vl_credito_presumido_60m,\\r\\n    c.perc_valores_iguais_12m,\\r\\n    c.variacao_saldo_perc_60m,\\r\\n    c.flag_saldo_alto_cancelada,\\r\\n    c.flag_suspeita_valores_repetidos,\\r\\n    c.flag_saldo_sem_declaracao,\\r\\n    c.flag_crescimento_anormal_saldo,\\r\\n    \\r\\n    i.qtde_indicios,\\r\\n    i.qtde_tipos_indicios_distintos,\\r\\n    i.soma_scores_indicios,\\r\\n    i.qtde_indicios_graves,\\r\\n    i.classificacao_risco_indicios,\\r\\n    i.qtde_indicios_docs_fiscais,\\r\\n    i.qtde_indicios_relacionamentos,\\r\\n    i.qtde_indicios_declaracoes,\\r\\n    i.qtde_indicios_cadastro,\\r\\n    \\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento,\\r\\n    m.dias_entre_primeiro_ultimo,\\r\\n    m.media_dias_desde_cancelamento,\\r\\n    m.lista_fiscais_envolvidos\\r\\n\\r\\nFROM teste.luciano_scores s\\r\\nJOIN teste.luciano_metricas m ON s.cnpj = m.cnpj\\r\\nLEFT JOIN teste.luciano_credito c ON s.cnpj = c.cnpj\\r\\nLEFT JOIN teste.luciano_indicios i ON s.cnpj = i.cnpj\\r\\nORDER BY s.ranking_fiscalizacao;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- FIM DAS CONSULTAS ANAL\\u00cdTICAS\\r\\n-- =====================================================================\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 606, \"column\": 0}, \"end\": {\"row\": 1137, \"column\": 72}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query f44c062d79291076:2d1b3f9100000000: 81% Complete (9 out of 11)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"f44c062d79291076:2d1b3f9100000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=f44c062d79291076:2d1b3f9100000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query f44c062d79291076:2d1b3f9100000000: 81% Complete (9 out of 11)\", \"progress\": 100, \"jobs\": [{\"name\": \"f44c062d79291076:2d1b3f9100000000\", \"url\": \"/hue/jobbrowser#!id=f44c062d79291076:2d1b3f9100000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 18944.07778, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 193, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- =====================================================================\r\n-- PROJETO LUCIANO - CONSULTAS ANALTICAS COMPLETAS\r\n-- =====================================================================\r\n\r\n-- =====================================================================\r\n-- 1. DASHBOARD EXECUTIVO - VISO GERAL DO PROJETO\r\n-- =====================================================================\r\n\r\nSELECT \r\n    '=== DASHBOARD EXECUTIVO LUCIANO ===' AS secao,\r\n    '' AS metrica,\r\n    '' AS valor,\r\n    '' AS observacao\r\n\r\nUNION ALL\r\n\r\nSELECT \r\n    'VOLUMETRIA GERAL',\r\n    'Total de Empresas Analisadas',\r\n    CAST(total_empresas AS STRING),\r\n    'Empresas nicas no perodo de 60 meses'\r\nFROM teste.luciano_resumo\r\n\r\nUNION ALL\r\n\r\nSELECT \r\n    'VOLUMETRIA GERAL',\r\n    'Total de Protocolos',\r\n    CAST(total_protocolos AS STRING),\r\n    'Cancelamentos processados'\r\nFROM teste.luciano_resumo\r\n\r\nUNION ALL\r\n\r\nSELECT \r\n    'RISCO',\r\n    'Empresas Risco CRTICO',\r\n    CONCAT(CAST(empresas_risco_critico AS STRING), ' (', CAST(perc_risco_critico AS STRING), '%)'),\r\n    'Prioridade mxima de fiscalizao'\r\nFROM teste.luciano_resumo\r\n\r\nUNION ALL\r\n\r\nSELECT \r\n    'RISCO',\r\n    'Empresas Risco ALTO',\r\n    CONCAT(CAST(empresas_risco_alto AS STRING), ' (', CAST(perc_risco_alto AS STRING), '%)'),\r\n    'Segunda prioridade'\r\nFROM teste.luciano_resumo\r\n\r\nUNION ALL\r\n\r\nSELECT \r\n    'EFETIVIDADE',\r\n    'Taxa Mdia de Permanncia',\r\n    CONCAT(CAST(taxa_media_permanencia AS STRING), '%'),\r\n    'Empresas que continuam canceladas'\r\nFROM teste.luciano_resumo\r\n\r\nUNION ALL\r\n\r\nSELECT \r\n    'CRDITO',\r\n    'Saldo Credor Total em Risco',\r\n    CONCAT('R$ ', CAST(ROUND(saldo_credor_total, 2) AS STRING)),\r\n    'Valor acumulado em empresas canceladas'\r\nFROM teste.luciano_resumo\r\n\r\nUNION ALL\r\n\r\nSELECT \r\n    'INDCIOS',\r\n    'Empresas com Indcios',\r\n    CONCAT(CAST(empresas_com_indicios AS STRING), ' (', CAST(perc_com_indicios AS STRING), '%)'),\r\n    'Empresas sinalizadas por irregularidades'\r\nFROM teste.l",
    "last_modified": "2025-11-25T18:47:00.052",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "638b4b71-396e-44c4-bbc5-e56afe09dddd",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 179511,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "LUCIANO: Criar tbl Fiscal Trevisan",
    "description": "",
    "uuid": "e0304d1d-9f74-f0fc-da0b-02ba9a919f07",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 179511, \"uuid\": \"357b5e7d-1ad4-472b-86ee-bd84f99d818d\", \"name\": \"LUCIANO: Criar tbl Fiscal Trevisan\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"e0304d1d-9f74-f0fc-da0b-02ba9a919f07\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"1f6a7f54-1f9e-74a3-3449-fef80d70d09a\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 661, \"column\": 78}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =====================================================================\\r\\n-- PROJETO LUCIANO - CRIA\\u00c7\\u00c3O DA TABELA cancel_luciano\\r\\n-- =====================================================================\\r\\n-- VERS\\u00c3O IMPALA OTIMIZADA\\r\\n-- Execute este script no Impala ANTES de rodar o Python\\r\\n-- =====================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 1: CRIAR TABELA COM CNPJs DO FISCAL\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_cnpjs;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_cnpjs AS\\r\\nSELECT DISTINCT\\r\\n    b.cnpj,\\r\\n    REGEXP_REPLACE(TRIM(CAST(b.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    b.ie,\\r\\n    b.nome_contribuinte,\\r\\n    b.razao_social,\\r\\n    b.municipio,\\r\\n    b.uf,\\r\\n    b.gerencia_regional,\\r\\n    b.cd_cnae,\\r\\n    b.descricao_cnae,\\r\\n    b.tipo_contribuinte,\\r\\n    b.regime_apuracao,\\r\\n    b.situacao_cadastral_atual,\\r\\n    b.protocolo,\\r\\n    b.data_inicio_protocolo AS data_cancelamento,\\r\\n    b.data_processamento,\\r\\n    b.cod_motivo,\\r\\n    b.parecer,\\r\\n    b.tipo_evento,\\r\\n    b.nome_fiscal,\\r\\n    b.flag_cancelamento_automatico,\\r\\n    b.flag_ainda_cancelada,\\r\\n    b.flag_reativada,\\r\\n    b.dias_desde_cancelamento,\\r\\n    m.total_protocolos AS total_protocolos_empresa,\\r\\n    m.taxa_permanencia_cancelamento_perc,\\r\\n    m.taxa_reativacao_perc,\\r\\n    m.flag_empresa_reincidente,\\r\\n    m.flag_atualmente_cancelada,\\r\\n    m.classificacao_frequencia,\\r\\n    m.classificacao_persistencia,\\r\\n    m.efetividade_cancelamento,\\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento\\r\\nFROM teste.luciano_base b\\r\\nLEFT JOIN teste.luciano_metricas m ON b.cnpj = m.cnpj\\r\\nWHERE (b.nome_fiscal LIKE '%LUCIANO%TREVISAN%'\\r\\n   OR b.nome_fiscal LIKE '%LUCIANO%FREITAS%'\\r\\n   OR UPPER(b.nome_fiscal) LIKE '%LUCIANO TREVISAN FREITAS%')\\r\\n  AND YEAR(b.data_inicio_protocolo) = 2025;\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 2: NF-e EMITIDAS (SA\\u00cdDAS) - OTIMIZADO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_nfe_emit;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_nfe_emit AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COUNT(DISTINCT nfe.chave) AS qtde_nfe_emitidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vnf, 0)) AS vl_total_nfe_emitidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vicms, 0)) AS vl_icms_nfe_emitidas,\\r\\n    MIN(nfe.procnfe.nfe.infnfe.ide.dhemi) AS primeira_nfe_emitida,\\r\\n    MAX(nfe.procnfe.nfe.infnfe.ide.dhemi) AS ultima_nfe_emitida,\\r\\n    COUNT(DISTINCT nfe.procnfe.nfe.infnfe.dest.cnpj) AS qtde_destinatarios_distintos\\r\\nFROM nfe.nfe nfe\\r\\n-- JOIN com a tabela de CNPJs (MUITO mais eficiente que IN)\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE nfe.ano_emissao >= 2021\\r\\n  AND nfe.procnfe.nfe.infnfe.ide.tpnf = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 3: NF-e RECEBIDAS (ENTRADAS) - OTIMIZADO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_nfe_rec;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_nfe_rec AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COUNT(DISTINCT nfe.chave) AS qtde_nfe_recebidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vnf, 0)) AS vl_total_nfe_recebidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vicms, 0)) AS vl_icms_nfe_recebidas,\\r\\n    MIN(nfe.procnfe.nfe.infnfe.ide.dhemi) AS primeira_nfe_recebida,\\r\\n    MAX(nfe.procnfe.nfe.infnfe.ide.dhemi) AS ultima_nfe_recebida,\\r\\n    COUNT(DISTINCT nfe.procnfe.nfe.infnfe.emit.cnpj) AS qtde_fornecedores_distintos\\r\\nFROM nfe.nfe nfe\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE nfe.ano_emissao >= 2021\\r\\n  AND nfe.procnfe.nfe.infnfe.ide.tpnf = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 4: IND\\u00cdCIOS CORRIGIDOS\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_indicios;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_indicios AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    \\r\\n    COUNT(*) AS qtde_indicios,\\r\\n    COUNT(DISTINCT ei.cd_indicio) AS qtde_tipos_indicios,\\r\\n    SUM(COALESCE(ei.nu_score, 0)) AS soma_scores_indicios,\\r\\n    ROUND(AVG(COALESCE(ei.nu_score, 0)), 2) AS media_score_indicios,\\r\\n    MAX(COALESCE(ei.nu_score, 0)) AS max_score_indicio,\\r\\n    \\r\\n    -- Ind\\u00edcios graves: score >= 50\\r\\n    SUM(CASE WHEN COALESCE(ei.nu_score, 0) >= 50 THEN 1 ELSE 0 END) AS qtde_indicios_graves,\\r\\n    \\r\\n    -- Ind\\u00edcios cr\\u00edticos: score >= 80\\r\\n    SUM(CASE WHEN COALESCE(ei.nu_score, 0) >= 80 THEN 1 ELSE 0 END) AS qtde_indicios_criticos,\\r\\n    \\r\\n    -- Categorias espec\\u00edficas\\r\\n    SUM(CASE WHEN ei.cd_indicio = 11 THEN 1 ELSE 0 END) AS qtde_omissao_dime,\\r\\n    SUM(CASE WHEN ei.cd_indicio = 12 THEN 1 ELSE 0 END) AS qtde_omissao_pgdas,\\r\\n    SUM(CASE WHEN ei.cd_indicio IN (1, 2, 3, 4) THEN 1 ELSE 0 END) AS qtde_indicios_docs_fiscais,\\r\\n    SUM(CASE WHEN ei.cd_indicio IN (5, 6, 7, 8, 62, 63) THEN 1 ELSE 0 END) AS qtde_indicios_relacionamentos,\\r\\n    \\r\\n    GROUP_CONCAT(DISTINCT CAST(ei.cd_indicio AS STRING), ',') AS lista_cod_indicios\\r\\n    \\r\\nFROM neaf.empresa_indicio ei\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE ei.cd_atual = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 5: DADOS NORMAL (DIME)\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_normal;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_normal AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(zn.nm_contador) AS contador,\\r\\n    MAX(COALESCE(zn.total_vl_faturamento, 0)) AS vl_faturamento_dime,\\r\\n    MAX(COALESCE(zn.total_vl_receita_bruta, 0)) AS vl_receita_bruta_dime,\\r\\n    MAX(COALESCE(zn.total_vl_tot_cred, 0)) AS vl_credito_dime,\\r\\n    MAX(COALESCE(zn.total_vl_tot_deb, 0)) AS vl_debito_dime,\\r\\n    MAX(COALESCE(zn.total_vl_deb_recolher, 0)) AS vl_deb_recolher_dime,\\r\\n    MAX(COALESCE(zn.periodos_omissos, 0)) AS periodos_omissos_dime,\\r\\n    MAX(COALESCE(zn.periodos_zerados, 0)) AS periodos_zerados_dime,\\r\\n    MAX(COALESCE(zn.periodos_sem_movimento, 0)) AS periodos_sem_movimento_dime,\\r\\n    MAX(COALESCE(zn.total_periodos, 0)) AS total_periodos_dime,\\r\\n    MAX(COALESCE(zn.periodos_declarados, 0)) AS periodos_declarados_dime,\\r\\n    MAX(COALESCE(zn.nfes_emitidas_normal, 0)) AS nfes_tab_normal,\\r\\n    MAX(COALESCE(zn.flag_omissao_dime_indicio, 0)) AS flag_omissao_dime\\r\\nFROM teste.cancel_zero_normal zn\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 6: DADOS SIMPLES (PGDAS)\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_simples;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_simples AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(zs.nm_contador) AS contador,\\r\\n    MAX(COALESCE(zs.total_vl_rec_bruta, 0)) AS vl_receita_bruta_pgdas,\\r\\n    MAX(COALESCE(zs.max_vl_rec_bruta_em_12m, 0)) AS vl_rec_bruta_12m_pgdas,\\r\\n    MAX(COALESCE(zs.total_vl_icms_sc, 0)) AS vl_icms_sc_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_omissos, 0)) AS periodos_omissos_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_zerados, 0)) AS periodos_zerados_pgdas,\\r\\n    MAX(COALESCE(zs.total_periodos, 0)) AS total_periodos_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_declarados, 0)) AS periodos_declarados_pgdas,\\r\\n    MAX(COALESCE(zs.nfes_emitidas_simples, 0)) AS nfes_tab_simples,\\r\\n    MAX(COALESCE(zs.flag_omissao_pgdas_indicio, 0)) AS flag_omissao_pgdas\\r\\nFROM teste.cancel_zero_simples zs\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 7: DADOS DE CR\\u00c9DITO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_credito;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_credito AS\\r\\nSELECT\\r\\n    lc.cnpj_limpo,\\r\\n    COALESCE(cr.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    COALESCE(cr.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(cr.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cr.flag_saldo_alto_cancelada, 0) AS flag_saldo_alto_cancelada,\\r\\n    COALESCE(cr.flag_suspeita_valores_repetidos, 0) AS flag_suspeita_valores_repetidos,\\r\\n    COALESCE(cr.perc_valores_iguais_12m, 0) AS perc_valores_iguais_12m,\\r\\n    COALESCE(cr.variacao_saldo_perc_60m, 0) AS variacao_saldo_perc_60m\\r\\nFROM teste.cancel_luciano_cnpjs lc\\r\\nLEFT JOIN teste.luciano_credito cr ON lc.cnpj = cr.cnpj;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 8: DADOS DE RECOLHIMENTO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_recol;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_recol AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COALESCE(SUM(r.quantidade_pagtos), 0) AS quantidade_pagamentos,\\r\\n    COALESCE(SUM(r.valor_pagtos), 0) AS valor_pagamentos\\r\\nFROM teste.cancel_recolhimento r\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 9: TABELA FINAL CONSOLIDADA - teste.cancel_luciano\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano AS\\r\\nSELECT \\r\\n    -- =========================================================\\r\\n    -- IDENTIFICA\\u00c7\\u00c3O\\r\\n    -- =========================================================\\r\\n    cf.cnpj,\\r\\n    cf.cnpj_limpo,\\r\\n    cf.ie,\\r\\n    cf.nome_contribuinte,\\r\\n    cf.razao_social,\\r\\n    cf.municipio,\\r\\n    cf.uf,\\r\\n    cf.gerencia_regional,\\r\\n    cf.cd_cnae,\\r\\n    cf.descricao_cnae,\\r\\n    cf.tipo_contribuinte,\\r\\n    cf.regime_apuracao,\\r\\n    cf.situacao_cadastral_atual,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS DO CANCELAMENTO\\r\\n    -- =========================================================\\r\\n    cf.protocolo,\\r\\n    cf.data_cancelamento,\\r\\n    cf.data_processamento,\\r\\n    cf.cod_motivo,\\r\\n    CASE cf.cod_motivo\\r\\n        WHEN 1 THEN 'INEXIST\\u00caNCIA OU INATIVIDADE DO ESTABELECIMENTO'\\r\\n        WHEN 2 THEN 'FALTA DE PEDIDO DE REATIVA\\u00c7\\u00c3O'\\r\\n        WHEN 3 THEN 'OMISS\\u00c3O DIME/GIA-ST/PGDAS-D OU ZERADAS/SEM MOVIMENTO 6 MESES'\\r\\n        WHEN 4 THEN 'DESCUMPRIMENTO LEGISLA\\u00c7\\u00c3O ATIVIDADE REGULAMENTADA'\\r\\n        WHEN 5 THEN 'FALTA APRESENTA\\u00c7\\u00c3O INFORMA\\u00c7\\u00d5ES ECON\\u00d4MICO-FISCAIS'\\r\\n        WHEN 6 THEN 'DECIS\\u00c3O JUDICIAL'\\r\\n        WHEN 7 THEN 'REGISTRO CNPJ/MUNIC\\u00cdPIO/JUNTA EXTINTO/CANCELADO/BAIXADO/INAPTO'\\r\\n        WHEN 8 THEN '(DESATIVADO) SUBSTITUTO SEM RECOLHER 90 DIAS'\\r\\n        WHEN 9 THEN '(DESATIVADO) D\\u00c9BITO D\\u00cdVIDA ATIVA > CAPITAL SOCIAL'\\r\\n        WHEN 10 THEN '(DESATIVADO) FALTA ATIVA\\u00c7\\u00c3O PRAZO REGULAMENTAR'\\r\\n        WHEN 11 THEN '(DESATIVADO) PERDA CONDI\\u00c7\\u00c3O CONTRIBUINTE'\\r\\n        WHEN 12 THEN 'PERDA DA CONDI\\u00c7\\u00c3O DE CONTRIBUINTE'\\r\\n        WHEN 13 THEN 'FALTA RECOLHIMENTO/GIA-ST 2 MESES NOS \\u00daLTIMOS 90 DIAS'\\r\\n        WHEN 14 THEN 'INSCRI\\u00c7\\u00c3O/ALTERA\\u00c7\\u00c3O MEDIANTE FRAUDE'\\r\\n        WHEN 15 THEN 'OPERA\\u00c7\\u00c3O COM PRODUTOS DE ORIGEM IL\\u00cdCITA'\\r\\n        WHEN 16 THEN 'DISPOSITIVO BOMBA COMBUST\\u00cdVEL - MENOS QUE INDICADO'\\r\\n        WHEN 17 THEN 'COMERCIALIZA\\u00c7\\u00c3O COMBUST\\u00cdVEL ADULTERADO'\\r\\n        WHEN 18 THEN 'FALTA REQUISITOS PARA INSCRI\\u00c7\\u00c3O ESTADUAL'\\r\\n        WHEN 19 THEN 'CONDENA\\u00c7\\u00c3O CRIME CONTRA ORDEM TRIBUT\\u00c1RIA'\\r\\n        WHEN 20 THEN 'D\\u00c9BITO D\\u00cdVIDA ATIVA > CAPITAL SOCIAL'\\r\\n        WHEN 21 THEN 'SUSPENS\\u00c3O DF-e N\\u00c3O RECLAMADA OU MANTIDA'\\r\\n        WHEN 22 THEN 'FALTA LISTA PRE\\u00c7OS PRODUTOS FUMO'\\r\\n        WHEN 23 THEN 'DESCUMPRIMENTO OBRIGA\\u00c7\\u00c3O ST ENTRADA'\\r\\n        WHEN 24 THEN 'N\\u00c3O EXERCE ATIVIDADE ICMS - CNAE INDEVIDO'\\r\\n        WHEN 25 THEN 'ALTERA\\u00c7\\u00c3O CADASTRAL INGRESSO PESSOA IRREGULAR'\\r\\n        ELSE CONCAT('MOTIVO ', COALESCE(CAST(cf.cod_motivo AS STRING), 'N/A'))\\r\\n    END AS descricao_motivo_cancelamento,\\r\\n    cf.parecer,\\r\\n    cf.tipo_evento,\\r\\n    cf.nome_fiscal,\\r\\n    cf.flag_cancelamento_automatico,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- SITUA\\u00c7\\u00c3O ATUAL\\r\\n    -- =========================================================\\r\\n    cf.flag_ainda_cancelada,\\r\\n    cf.flag_reativada,\\r\\n    cf.dias_desde_cancelamento,\\r\\n    cf.total_protocolos_empresa,\\r\\n    cf.classificacao_frequencia,\\r\\n    cf.classificacao_persistencia,\\r\\n    cf.efetividade_cancelamento,\\r\\n    cf.flag_empresa_reincidente,\\r\\n    cf.data_primeiro_cancelamento,\\r\\n    cf.data_ultimo_cancelamento,\\r\\n    cf.taxa_permanencia_cancelamento_perc,\\r\\n    cf.taxa_reativacao_perc,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS DE CR\\u00c9DITO\\r\\n    -- =========================================================\\r\\n    COALESCE(cr.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    COALESCE(cr.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(cr.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cr.flag_saldo_alto_cancelada, 0) AS flag_saldo_alto_cancelada,\\r\\n    COALESCE(cr.flag_suspeita_valores_repetidos, 0) AS flag_suspeita_valores_repetidos,\\r\\n    COALESCE(cr.perc_valores_iguais_12m, 0) AS perc_valores_iguais_12m,\\r\\n    COALESCE(cr.variacao_saldo_perc_60m, 0) AS variacao_saldo_perc_60m,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- IND\\u00cdCIOS (CORRIGIDOS)\\r\\n    -- =========================================================\\r\\n    COALESCE(ind.qtde_indicios, 0) AS qtde_indicios,\\r\\n    COALESCE(ind.qtde_tipos_indicios, 0) AS qtde_tipos_indicios,\\r\\n    COALESCE(ind.soma_scores_indicios, 0) AS soma_scores_indicios,\\r\\n    COALESCE(ind.media_score_indicios, 0) AS media_score_indicios,\\r\\n    COALESCE(ind.max_score_indicio, 0) AS max_score_indicio,\\r\\n    COALESCE(ind.qtde_indicios_graves, 0) AS qtde_indicios_graves,\\r\\n    COALESCE(ind.qtde_indicios_criticos, 0) AS qtde_indicios_criticos,\\r\\n    COALESCE(ind.qtde_omissao_dime, 0) AS qtde_omissao_dime,\\r\\n    COALESCE(ind.qtde_omissao_pgdas, 0) AS qtde_omissao_pgdas,\\r\\n    COALESCE(ind.qtde_indicios_docs_fiscais, 0) AS qtde_indicios_docs_fiscais,\\r\\n    COALESCE(ind.qtde_indicios_relacionamentos, 0) AS qtde_indicios_relacionamentos,\\r\\n    ind.lista_cod_indicios,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS REGIME NORMAL (DIME)\\r\\n    -- =========================================================\\r\\n    dn.contador AS contador_normal,\\r\\n    COALESCE(dn.vl_faturamento_dime, 0) AS vl_faturamento_dime,\\r\\n    COALESCE(dn.vl_receita_bruta_dime, 0) AS vl_receita_bruta_dime,\\r\\n    COALESCE(dn.vl_credito_dime, 0) AS vl_credito_dime,\\r\\n    COALESCE(dn.vl_debito_dime, 0) AS vl_debito_dime,\\r\\n    COALESCE(dn.vl_deb_recolher_dime, 0) AS vl_deb_recolher_dime,\\r\\n    COALESCE(dn.periodos_omissos_dime, 0) AS periodos_omissos_dime,\\r\\n    COALESCE(dn.periodos_zerados_dime, 0) AS periodos_zerados_dime,\\r\\n    COALESCE(dn.periodos_sem_movimento_dime, 0) AS periodos_sem_movimento_dime,\\r\\n    COALESCE(dn.total_periodos_dime, 0) AS total_periodos_dime,\\r\\n    COALESCE(dn.periodos_declarados_dime, 0) AS periodos_declarados_dime,\\r\\n    COALESCE(dn.flag_omissao_dime, 0) AS flag_omissao_dime,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS SIMPLES NACIONAL (PGDAS)\\r\\n    -- =========================================================\\r\\n    ds.contador AS contador_simples,\\r\\n    COALESCE(ds.vl_receita_bruta_pgdas, 0) AS vl_receita_bruta_pgdas,\\r\\n    COALESCE(ds.vl_rec_bruta_12m_pgdas, 0) AS vl_rec_bruta_12m_pgdas,\\r\\n    COALESCE(ds.vl_icms_sc_pgdas, 0) AS vl_icms_sc_pgdas,\\r\\n    COALESCE(ds.periodos_omissos_pgdas, 0) AS periodos_omissos_pgdas,\\r\\n    COALESCE(ds.periodos_zerados_pgdas, 0) AS periodos_zerados_pgdas,\\r\\n    COALESCE(ds.total_periodos_pgdas, 0) AS total_periodos_pgdas,\\r\\n    COALESCE(ds.periodos_declarados_pgdas, 0) AS periodos_declarados_pgdas,\\r\\n    COALESCE(ds.flag_omissao_pgdas, 0) AS flag_omissao_pgdas,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- NF-e EMITIDAS (SA\\u00cdDAS)\\r\\n    -- =========================================================\\r\\n    COALESCE(nfe_e.qtde_nfe_emitidas, 0) AS qtde_nfe_emitidas,\\r\\n    COALESCE(nfe_e.vl_total_nfe_emitidas, 0) AS vl_total_nfe_emitidas,\\r\\n    COALESCE(nfe_e.vl_icms_nfe_emitidas, 0) AS vl_icms_nfe_emitidas,\\r\\n    nfe_e.primeira_nfe_emitida,\\r\\n    nfe_e.ultima_nfe_emitida,\\r\\n    COALESCE(nfe_e.qtde_destinatarios_distintos, 0) AS qtde_destinatarios_distintos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- NF-e RECEBIDAS (ENTRADAS)\\r\\n    -- =========================================================\\r\\n    COALESCE(nfe_r.qtde_nfe_recebidas, 0) AS qtde_nfe_recebidas,\\r\\n    COALESCE(nfe_r.vl_total_nfe_recebidas, 0) AS vl_total_nfe_recebidas,\\r\\n    COALESCE(nfe_r.vl_icms_nfe_recebidas, 0) AS vl_icms_nfe_recebidas,\\r\\n    nfe_r.primeira_nfe_recebida,\\r\\n    nfe_r.ultima_nfe_recebida,\\r\\n    COALESCE(nfe_r.qtde_fornecedores_distintos, 0) AS qtde_fornecedores_distintos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- RECOLHIMENTO\\r\\n    -- =========================================================\\r\\n    COALESCE(rec.quantidade_pagamentos, 0) AS quantidade_pagamentos,\\r\\n    COALESCE(rec.valor_pagamentos, 0) AS valor_pagamentos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- CATEGORIZA\\u00c7\\u00c3O POR COMPORTAMENTO\\r\\n    -- =========================================================\\r\\n    CASE \\r\\n        WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 AND cf.flag_ainda_cancelada = 1 \\r\\n        THEN 'ALTO_RISCO_FINANCEIRO'\\r\\n        \\r\\n        WHEN (COALESCE(ind.qtde_indicios_graves, 0) > 0 OR COALESCE(ind.soma_scores_indicios, 0) > 200) \\r\\n             AND cf.flag_ainda_cancelada = 1\\r\\n        THEN 'FRAUDE_POTENCIAL'\\r\\n        \\r\\n        WHEN cf.total_protocolos_empresa >= 3 AND cf.flag_ainda_cancelada = 1\\r\\n        THEN 'REINCIDENTE_CRONICO'\\r\\n        \\r\\n        WHEN (COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 OR COALESCE(cr.perc_valores_iguais_12m, 0) > 50) \\r\\n             AND COALESCE(cr.saldo_credor_atual, 0) > 10000\\r\\n        THEN 'CREDITO_SUSPEITO'\\r\\n        \\r\\n        WHEN cf.flag_ainda_cancelada = 1 AND COALESCE(cr.saldo_credor_atual, 0) = 0 \\r\\n             AND COALESCE(ind.qtde_indicios, 0) = 0\\r\\n        THEN 'CANCELAMENTO_EFETIVO'\\r\\n        \\r\\n        WHEN cf.flag_reativada = 1 AND COALESCE(cr.saldo_credor_atual, 0) < 10000 \\r\\n             AND COALESCE(ind.qtde_indicios, 0) = 0\\r\\n        THEN 'REATIVADA_SEM_RISCO'\\r\\n        \\r\\n        WHEN cf.flag_reativada = 1 AND (COALESCE(cr.saldo_credor_atual, 0) > 50000 \\r\\n             OR COALESCE(ind.qtde_indicios, 0) > 0)\\r\\n        THEN 'REATIVADA_COM_RISCO'\\r\\n        \\r\\n        ELSE 'OUTROS'\\r\\n    END AS categoria_comportamento,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- SCORE DE PRIORIDADE PARA A\\u00c7\\u00c3O\\r\\n    -- =========================================================\\r\\n    (\\r\\n        -- Score por saldo credor\\r\\n        CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por ind\\u00edcios\\r\\n        CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n             WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n             WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n             WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por reincid\\u00eancia\\r\\n        CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n             WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n             WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por valores suspeitos\\r\\n        CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n        +\\r\\n        -- Score por omiss\\u00f5es\\r\\n        CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n               OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n             WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n               OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por declara\\u00e7\\u00f5es zeradas\\r\\n        CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n               OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por NF-e sem declara\\u00e7\\u00e3o correspondente\\r\\n        CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n              AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n              AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n             ELSE 0 END\\r\\n    ) AS score_prioridade_acao,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O DE RISCO FINAL\\r\\n    -- =========================================================\\r\\n    CASE \\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 50 THEN 'ALTO'\\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 30 THEN 'M\\u00c9DIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS classificacao_risco_final\\r\\n\\r\\nFROM teste.cancel_luciano_cnpjs cf\\r\\nLEFT JOIN teste.cancel_luciano_credito cr ON cf.cnpj_limpo = cr.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_indicios ind ON cf.cnpj_limpo = ind.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_normal dn ON cf.cnpj_limpo = dn.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_simples ds ON cf.cnpj_limpo = ds.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_nfe_emit nfe_e ON cf.cnpj_limpo = nfe_e.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_nfe_rec nfe_r ON cf.cnpj_limpo = nfe_r.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_recol rec ON cf.cnpj_limpo = rec.cnpj_limpo;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- VERIFICA\\u00c7\\u00d5ES FINAIS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT '========== RESUMO FINAL ==========' AS info;\\r\\n\\r\\nSELECT 'Total registros' AS metrica, COUNT(*) AS valor FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Empresas distintas', COUNT(DISTINCT cnpj) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com NF-e emitidas', COUNT(CASE WHEN qtde_nfe_emitidas > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com NF-e recebidas', COUNT(CASE WHEN qtde_nfe_recebidas > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com ind\\u00edcios', COUNT(CASE WHEN qtde_indicios > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com ind\\u00edcios graves', COUNT(CASE WHEN qtde_indicios_graves > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com omiss\\u00f5es', COUNT(CASE WHEN periodos_omissos_dime > 0 OR periodos_omissos_pgdas > 0 THEN 1 END) FROM teste.cancel_luciano;\\r\\n\\r\\nSELECT '========== DISTRIBUI\\u00c7\\u00c3O POR RISCO ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_final,\\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.cancel_luciano\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final \\r\\n        WHEN 'CR\\u00cdTICO' THEN 1 \\r\\n        WHEN 'ALTO' THEN 2 \\r\\n        WHEN 'M\\u00c9DIO' THEN 3 \\r\\n        ELSE 4 \\r\\n    END;\\r\\n\\r\\nSELECT '========== DISTRIBUI\\u00c7\\u00c3O POR CATEGORIA ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    categoria_comportamento,\\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.cancel_luciano\\r\\nGROUP BY categoria_comportamento\\r\\nORDER BY qtde DESC;\\r\\n\\r\\nSELECT '========== TOP 10 POR SCORE ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    cnpj,\\r\\n    nome_contribuinte,\\r\\n    municipio,\\r\\n    data_cancelamento,\\r\\n    descricao_motivo_cancelamento,\\r\\n    categoria_comportamento,\\r\\n    classificacao_risco_final,\\r\\n    score_prioridade_acao,\\r\\n    saldo_credor_atual,\\r\\n    qtde_indicios,\\r\\n    qtde_indicios_graves,\\r\\n    qtde_nfe_emitidas,\\r\\n    vl_total_nfe_emitidas\\r\\nFROM teste.cancel_luciano\\r\\nORDER BY score_prioridade_acao DESC\\r\\nLIMIT 10;\\r\\n\\r\\nSELECT '========== TABELAS AUXILIARES CRIADAS ==========' AS info;\\r\\n\\r\\nSELECT 'cancel_luciano_cnpjs' AS tabela, COUNT(*) AS registros FROM teste.cancel_luciano_cnpjs\\r\\nUNION ALL SELECT 'cancel_luciano_nfe_emit', COUNT(*) FROM teste.cancel_luciano_nfe_emit\\r\\nUNION ALL SELECT 'cancel_luciano_nfe_rec', COUNT(*) FROM teste.cancel_luciano_nfe_rec\\r\\nUNION ALL SELECT 'cancel_luciano_indicios', COUNT(*) FROM teste.cancel_luciano_indicios\\r\\nUNION ALL SELECT 'cancel_luciano_normal', COUNT(*) FROM teste.cancel_luciano_normal\\r\\nUNION ALL SELECT 'cancel_luciano_simples', COUNT(*) FROM teste.cancel_luciano_simples\\r\\nUNION ALL SELECT 'cancel_luciano_credito', COUNT(*) FROM teste.cancel_luciano_credito\\r\\nUNION ALL SELECT 'cancel_luciano_recol', COUNT(*) FROM teste.cancel_luciano_recol\\r\\nUNION ALL SELECT 'cancel_luciano (FINAL)', COUNT(*) FROM teste.cancel_luciano;\", \"statementsList\": [\"\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_indicios AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    \\r\\n    COUNT(*) AS qtde_indicios,\\r\\n    COUNT(DISTINCT ei.cd_indicio) AS qtde_tipos_indicios,\\r\\n    SUM(COALESCE(ei.nu_score, 0)) AS soma_scores_indicios,\\r\\n    ROUND(AVG(COALESCE(ei.nu_score, 0)), 2) AS media_score_indicios,\\r\\n    MAX(COALESCE(ei.nu_score, 0)) AS max_score_indicio,\\r\\n    \\r\\n    -- Ind\\u00edcios graves: score >= 50\\r\\n    SUM(CASE WHEN COALESCE(ei.nu_score, 0) >= 50 THEN 1 ELSE 0 END) AS qtde_indicios_graves,\\r\\n    \\r\\n    -- Ind\\u00edcios cr\\u00edticos: score >= 80\\r\\n    SUM(CASE WHEN COALESCE(ei.nu_score, 0) >= 80 THEN 1 ELSE 0 END) AS qtde_indicios_criticos,\\r\\n    \\r\\n    -- Categorias espec\\u00edficas\\r\\n    SUM(CASE WHEN ei.cd_indicio = 11 THEN 1 ELSE 0 END) AS qtde_omissao_dime,\\r\\n    SUM(CASE WHEN ei.cd_indicio = 12 THEN 1 ELSE 0 END) AS qtde_omissao_pgdas,\\r\\n    SUM(CASE WHEN ei.cd_indicio IN (1, 2, 3, 4) THEN 1 ELSE 0 END) AS qtde_indicios_docs_fiscais,\\r\\n    SUM(CASE WHEN ei.cd_indicio IN (5, 6, 7, 8, 62, 63) THEN 1 ELSE 0 END) AS qtde_indicios_relacionamentos,\\r\\n    \\r\\n    GROUP_CONCAT(DISTINCT CAST(ei.cd_indicio AS STRING), ',') AS lista_cod_indicios\\r\\n    \\r\\nFROM neaf.empresa_indicio ei\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE ei.cd_atual = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '');\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 5: DADOS NORMAL (DIME)\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_normal;\", \"\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_normal AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(zn.nm_contador) AS contador,\\r\\n    MAX(COALESCE(zn.total_vl_faturamento, 0)) AS vl_faturamento_dime,\\r\\n    MAX(COALESCE(zn.total_vl_receita_bruta, 0)) AS vl_receita_bruta_dime,\\r\\n    MAX(COALESCE(zn.total_vl_tot_cred, 0)) AS vl_credito_dime,\\r\\n    MAX(COALESCE(zn.total_vl_tot_deb, 0)) AS vl_debito_dime,\\r\\n    MAX(COALESCE(zn.total_vl_deb_recolher, 0)) AS vl_deb_recolher_dime,\\r\\n    MAX(COALESCE(zn.periodos_omissos, 0)) AS periodos_omissos_dime,\\r\\n    MAX(COALESCE(zn.periodos_zerados, 0)) AS periodos_zerados_dime,\\r\\n    MAX(COALESCE(zn.periodos_sem_movimento, 0)) AS periodos_sem_movimento_dime,\\r\\n    MAX(COALESCE(zn.total_periodos, 0)) AS total_periodos_dime,\\r\\n    MAX(COALESCE(zn.periodos_declarados, 0)) AS periodos_declarados_dime,\\r\\n    MAX(COALESCE(zn.nfes_emitidas_normal, 0)) AS nfes_tab_normal,\\r\\n    MAX(COALESCE(zn.flag_omissao_dime_indicio, 0)) AS flag_omissao_dime\\r\\nFROM teste.cancel_zero_normal zn\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '');\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 6: DADOS SIMPLES (PGDAS)\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_simples;\", \"\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_simples AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(zs.nm_contador) AS contador,\\r\\n    MAX(COALESCE(zs.total_vl_rec_bruta, 0)) AS vl_receita_bruta_pgdas,\\r\\n    MAX(COALESCE(zs.max_vl_rec_bruta_em_12m, 0)) AS vl_rec_bruta_12m_pgdas,\\r\\n    MAX(COALESCE(zs.total_vl_icms_sc, 0)) AS vl_icms_sc_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_omissos, 0)) AS periodos_omissos_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_zerados, 0)) AS periodos_zerados_pgdas,\\r\\n    MAX(COALESCE(zs.total_periodos, 0)) AS total_periodos_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_declarados, 0)) AS periodos_declarados_pgdas,\\r\\n    MAX(COALESCE(zs.nfes_emitidas_simples, 0)) AS nfes_tab_simples,\\r\\n    MAX(COALESCE(zs.flag_omissao_pgdas_indicio, 0)) AS flag_omissao_pgdas\\r\\nFROM teste.cancel_zero_simples zs\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '');\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 7: DADOS DE CR\\u00c9DITO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_credito;\", \"\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_credito AS\\r\\nSELECT\\r\\n    lc.cnpj_limpo,\\r\\n    COALESCE(cr.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    COALESCE(cr.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(cr.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cr.flag_saldo_alto_cancelada, 0) AS flag_saldo_alto_cancelada,\\r\\n    COALESCE(cr.flag_suspeita_valores_repetidos, 0) AS flag_suspeita_valores_repetidos,\\r\\n    COALESCE(cr.perc_valores_iguais_12m, 0) AS perc_valores_iguais_12m,\\r\\n    COALESCE(cr.variacao_saldo_perc_60m, 0) AS variacao_saldo_perc_60m\\r\\nFROM teste.cancel_luciano_cnpjs lc\\r\\nLEFT JOIN teste.luciano_credito cr ON lc.cnpj = cr.cnpj;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 8: DADOS DE RECOLHIMENTO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_recol;\", \"\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_recol AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COALESCE(SUM(r.quantidade_pagtos), 0) AS quantidade_pagamentos,\\r\\n    COALESCE(SUM(r.valor_pagtos), 0) AS valor_pagamentos\\r\\nFROM teste.cancel_recolhimento r\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '');\", \"\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 9: TABELA FINAL CONSOLIDADA - teste.cancel_luciano\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano;\", \"\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano AS\\r\\nSELECT \\r\\n    -- =========================================================\\r\\n    -- IDENTIFICA\\u00c7\\u00c3O\\r\\n    -- =========================================================\\r\\n    cf.cnpj,\\r\\n    cf.cnpj_limpo,\\r\\n    cf.ie,\\r\\n    cf.nome_contribuinte,\\r\\n    cf.razao_social,\\r\\n    cf.municipio,\\r\\n    cf.uf,\\r\\n    cf.gerencia_regional,\\r\\n    cf.cd_cnae,\\r\\n    cf.descricao_cnae,\\r\\n    cf.tipo_contribuinte,\\r\\n    cf.regime_apuracao,\\r\\n    cf.situacao_cadastral_atual,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS DO CANCELAMENTO\\r\\n    -- =========================================================\\r\\n    cf.protocolo,\\r\\n    cf.data_cancelamento,\\r\\n    cf.data_processamento,\\r\\n    cf.cod_motivo,\\r\\n    CASE cf.cod_motivo\\r\\n        WHEN 1 THEN 'INEXIST\\u00caNCIA OU INATIVIDADE DO ESTABELECIMENTO'\\r\\n        WHEN 2 THEN 'FALTA DE PEDIDO DE REATIVA\\u00c7\\u00c3O'\\r\\n        WHEN 3 THEN 'OMISS\\u00c3O DIME/GIA-ST/PGDAS-D OU ZERADAS/SEM MOVIMENTO 6 MESES'\\r\\n        WHEN 4 THEN 'DESCUMPRIMENTO LEGISLA\\u00c7\\u00c3O ATIVIDADE REGULAMENTADA'\\r\\n        WHEN 5 THEN 'FALTA APRESENTA\\u00c7\\u00c3O INFORMA\\u00c7\\u00d5ES ECON\\u00d4MICO-FISCAIS'\\r\\n        WHEN 6 THEN 'DECIS\\u00c3O JUDICIAL'\\r\\n        WHEN 7 THEN 'REGISTRO CNPJ/MUNIC\\u00cdPIO/JUNTA EXTINTO/CANCELADO/BAIXADO/INAPTO'\\r\\n        WHEN 8 THEN '(DESATIVADO) SUBSTITUTO SEM RECOLHER 90 DIAS'\\r\\n        WHEN 9 THEN '(DESATIVADO) D\\u00c9BITO D\\u00cdVIDA ATIVA > CAPITAL SOCIAL'\\r\\n        WHEN 10 THEN '(DESATIVADO) FALTA ATIVA\\u00c7\\u00c3O PRAZO REGULAMENTAR'\\r\\n        WHEN 11 THEN '(DESATIVADO) PERDA CONDI\\u00c7\\u00c3O CONTRIBUINTE'\\r\\n        WHEN 12 THEN 'PERDA DA CONDI\\u00c7\\u00c3O DE CONTRIBUINTE'\\r\\n        WHEN 13 THEN 'FALTA RECOLHIMENTO/GIA-ST 2 MESES NOS \\u00daLTIMOS 90 DIAS'\\r\\n        WHEN 14 THEN 'INSCRI\\u00c7\\u00c3O/ALTERA\\u00c7\\u00c3O MEDIANTE FRAUDE'\\r\\n        WHEN 15 THEN 'OPERA\\u00c7\\u00c3O COM PRODUTOS DE ORIGEM IL\\u00cdCITA'\\r\\n        WHEN 16 THEN 'DISPOSITIVO BOMBA COMBUST\\u00cdVEL - MENOS QUE INDICADO'\\r\\n        WHEN 17 THEN 'COMERCIALIZA\\u00c7\\u00c3O COMBUST\\u00cdVEL ADULTERADO'\\r\\n        WHEN 18 THEN 'FALTA REQUISITOS PARA INSCRI\\u00c7\\u00c3O ESTADUAL'\\r\\n        WHEN 19 THEN 'CONDENA\\u00c7\\u00c3O CRIME CONTRA ORDEM TRIBUT\\u00c1RIA'\\r\\n        WHEN 20 THEN 'D\\u00c9BITO D\\u00cdVIDA ATIVA > CAPITAL SOCIAL'\\r\\n        WHEN 21 THEN 'SUSPENS\\u00c3O DF-e N\\u00c3O RECLAMADA OU MANTIDA'\\r\\n        WHEN 22 THEN 'FALTA LISTA PRE\\u00c7OS PRODUTOS FUMO'\\r\\n        WHEN 23 THEN 'DESCUMPRIMENTO OBRIGA\\u00c7\\u00c3O ST ENTRADA'\\r\\n        WHEN 24 THEN 'N\\u00c3O EXERCE ATIVIDADE ICMS - CNAE INDEVIDO'\\r\\n        WHEN 25 THEN 'ALTERA\\u00c7\\u00c3O CADASTRAL INGRESSO PESSOA IRREGULAR'\\r\\n        ELSE CONCAT('MOTIVO ', COALESCE(CAST(cf.cod_motivo AS STRING), 'N/A'))\\r\\n    END AS descricao_motivo_cancelamento,\\r\\n    cf.parecer,\\r\\n    cf.tipo_evento,\\r\\n    cf.nome_fiscal,\\r\\n    cf.flag_cancelamento_automatico,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- SITUA\\u00c7\\u00c3O ATUAL\\r\\n    -- =========================================================\\r\\n    cf.flag_ainda_cancelada,\\r\\n    cf.flag_reativada,\\r\\n    cf.dias_desde_cancelamento,\\r\\n    cf.total_protocolos_empresa,\\r\\n    cf.classificacao_frequencia,\\r\\n    cf.classificacao_persistencia,\\r\\n    cf.efetividade_cancelamento,\\r\\n    cf.flag_empresa_reincidente,\\r\\n    cf.data_primeiro_cancelamento,\\r\\n    cf.data_ultimo_cancelamento,\\r\\n    cf.taxa_permanencia_cancelamento_perc,\\r\\n    cf.taxa_reativacao_perc,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS DE CR\\u00c9DITO\\r\\n    -- =========================================================\\r\\n    COALESCE(cr.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    COALESCE(cr.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(cr.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cr.flag_saldo_alto_cancelada, 0) AS flag_saldo_alto_cancelada,\\r\\n    COALESCE(cr.flag_suspeita_valores_repetidos, 0) AS flag_suspeita_valores_repetidos,\\r\\n    COALESCE(cr.perc_valores_iguais_12m, 0) AS perc_valores_iguais_12m,\\r\\n    COALESCE(cr.variacao_saldo_perc_60m, 0) AS variacao_saldo_perc_60m,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- IND\\u00cdCIOS (CORRIGIDOS)\\r\\n    -- =========================================================\\r\\n    COALESCE(ind.qtde_indicios, 0) AS qtde_indicios,\\r\\n    COALESCE(ind.qtde_tipos_indicios, 0) AS qtde_tipos_indicios,\\r\\n    COALESCE(ind.soma_scores_indicios, 0) AS soma_scores_indicios,\\r\\n    COALESCE(ind.media_score_indicios, 0) AS media_score_indicios,\\r\\n    COALESCE(ind.max_score_indicio, 0) AS max_score_indicio,\\r\\n    COALESCE(ind.qtde_indicios_graves, 0) AS qtde_indicios_graves,\\r\\n    COALESCE(ind.qtde_indicios_criticos, 0) AS qtde_indicios_criticos,\\r\\n    COALESCE(ind.qtde_omissao_dime, 0) AS qtde_omissao_dime,\\r\\n    COALESCE(ind.qtde_omissao_pgdas, 0) AS qtde_omissao_pgdas,\\r\\n    COALESCE(ind.qtde_indicios_docs_fiscais, 0) AS qtde_indicios_docs_fiscais,\\r\\n    COALESCE(ind.qtde_indicios_relacionamentos, 0) AS qtde_indicios_relacionamentos,\\r\\n    ind.lista_cod_indicios,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS REGIME NORMAL (DIME)\\r\\n    -- =========================================================\\r\\n    dn.contador AS contador_normal,\\r\\n    COALESCE(dn.vl_faturamento_dime, 0) AS vl_faturamento_dime,\\r\\n    COALESCE(dn.vl_receita_bruta_dime, 0) AS vl_receita_bruta_dime,\\r\\n    COALESCE(dn.vl_credito_dime, 0) AS vl_credito_dime,\\r\\n    COALESCE(dn.vl_debito_dime, 0) AS vl_debito_dime,\\r\\n    COALESCE(dn.vl_deb_recolher_dime, 0) AS vl_deb_recolher_dime,\\r\\n    COALESCE(dn.periodos_omissos_dime, 0) AS periodos_omissos_dime,\\r\\n    COALESCE(dn.periodos_zerados_dime, 0) AS periodos_zerados_dime,\\r\\n    COALESCE(dn.periodos_sem_movimento_dime, 0) AS periodos_sem_movimento_dime,\\r\\n    COALESCE(dn.total_periodos_dime, 0) AS total_periodos_dime,\\r\\n    COALESCE(dn.periodos_declarados_dime, 0) AS periodos_declarados_dime,\\r\\n    COALESCE(dn.flag_omissao_dime, 0) AS flag_omissao_dime,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS SIMPLES NACIONAL (PGDAS)\\r\\n    -- =========================================================\\r\\n    ds.contador AS contador_simples,\\r\\n    COALESCE(ds.vl_receita_bruta_pgdas, 0) AS vl_receita_bruta_pgdas,\\r\\n    COALESCE(ds.vl_rec_bruta_12m_pgdas, 0) AS vl_rec_bruta_12m_pgdas,\\r\\n    COALESCE(ds.vl_icms_sc_pgdas, 0) AS vl_icms_sc_pgdas,\\r\\n    COALESCE(ds.periodos_omissos_pgdas, 0) AS periodos_omissos_pgdas,\\r\\n    COALESCE(ds.periodos_zerados_pgdas, 0) AS periodos_zerados_pgdas,\\r\\n    COALESCE(ds.total_periodos_pgdas, 0) AS total_periodos_pgdas,\\r\\n    COALESCE(ds.periodos_declarados_pgdas, 0) AS periodos_declarados_pgdas,\\r\\n    COALESCE(ds.flag_omissao_pgdas, 0) AS flag_omissao_pgdas,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- NF-e EMITIDAS (SA\\u00cdDAS)\\r\\n    -- =========================================================\\r\\n    COALESCE(nfe_e.qtde_nfe_emitidas, 0) AS qtde_nfe_emitidas,\\r\\n    COALESCE(nfe_e.vl_total_nfe_emitidas, 0) AS vl_total_nfe_emitidas,\\r\\n    COALESCE(nfe_e.vl_icms_nfe_emitidas, 0) AS vl_icms_nfe_emitidas,\\r\\n    nfe_e.primeira_nfe_emitida,\\r\\n    nfe_e.ultima_nfe_emitida,\\r\\n    COALESCE(nfe_e.qtde_destinatarios_distintos, 0) AS qtde_destinatarios_distintos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- NF-e RECEBIDAS (ENTRADAS)\\r\\n    -- =========================================================\\r\\n    COALESCE(nfe_r.qtde_nfe_recebidas, 0) AS qtde_nfe_recebidas,\\r\\n    COALESCE(nfe_r.vl_total_nfe_recebidas, 0) AS vl_total_nfe_recebidas,\\r\\n    COALESCE(nfe_r.vl_icms_nfe_recebidas, 0) AS vl_icms_nfe_recebidas,\\r\\n    nfe_r.primeira_nfe_recebida,\\r\\n    nfe_r.ultima_nfe_recebida,\\r\\n    COALESCE(nfe_r.qtde_fornecedores_distintos, 0) AS qtde_fornecedores_distintos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- RECOLHIMENTO\\r\\n    -- =========================================================\\r\\n    COALESCE(rec.quantidade_pagamentos, 0) AS quantidade_pagamentos,\\r\\n    COALESCE(rec.valor_pagamentos, 0) AS valor_pagamentos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- CATEGORIZA\\u00c7\\u00c3O POR COMPORTAMENTO\\r\\n    -- =========================================================\\r\\n    CASE \\r\\n        WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 AND cf.flag_ainda_cancelada = 1 \\r\\n        THEN 'ALTO_RISCO_FINANCEIRO'\\r\\n        \\r\\n        WHEN (COALESCE(ind.qtde_indicios_graves, 0) > 0 OR COALESCE(ind.soma_scores_indicios, 0) > 200) \\r\\n             AND cf.flag_ainda_cancelada = 1\\r\\n        THEN 'FRAUDE_POTENCIAL'\\r\\n        \\r\\n        WHEN cf.total_protocolos_empresa >= 3 AND cf.flag_ainda_cancelada = 1\\r\\n        THEN 'REINCIDENTE_CRONICO'\\r\\n        \\r\\n        WHEN (COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 OR COALESCE(cr.perc_valores_iguais_12m, 0) > 50) \\r\\n             AND COALESCE(cr.saldo_credor_atual, 0) > 10000\\r\\n        THEN 'CREDITO_SUSPEITO'\\r\\n        \\r\\n        WHEN cf.flag_ainda_cancelada = 1 AND COALESCE(cr.saldo_credor_atual, 0) = 0 \\r\\n             AND COALESCE(ind.qtde_indicios, 0) = 0\\r\\n        THEN 'CANCELAMENTO_EFETIVO'\\r\\n        \\r\\n        WHEN cf.flag_reativada = 1 AND COALESCE(cr.saldo_credor_atual, 0) < 10000 \\r\\n             AND COALESCE(ind.qtde_indicios, 0) = 0\\r\\n        THEN 'REATIVADA_SEM_RISCO'\\r\\n        \\r\\n        WHEN cf.flag_reativada = 1 AND (COALESCE(cr.saldo_credor_atual, 0) > 50000 \\r\\n             OR COALESCE(ind.qtde_indicios, 0) > 0)\\r\\n        THEN 'REATIVADA_COM_RISCO'\\r\\n        \\r\\n        ELSE 'OUTROS'\\r\\n    END AS categoria_comportamento,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- SCORE DE PRIORIDADE PARA A\\u00c7\\u00c3O\\r\\n    -- =========================================================\\r\\n    (\\r\\n        -- Score por saldo credor\\r\\n        CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por ind\\u00edcios\\r\\n        CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n             WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n             WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n             WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por reincid\\u00eancia\\r\\n        CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n             WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n             WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por valores suspeitos\\r\\n        CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n        +\\r\\n        -- Score por omiss\\u00f5es\\r\\n        CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n               OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n             WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n               OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por declara\\u00e7\\u00f5es zeradas\\r\\n        CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n               OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por NF-e sem declara\\u00e7\\u00e3o correspondente\\r\\n        CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n              AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n              AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n             ELSE 0 END\\r\\n    ) AS score_prioridade_acao,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O DE RISCO FINAL\\r\\n    -- =========================================================\\r\\n    CASE \\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 50 THEN 'ALTO'\\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 30 THEN 'M\\u00c9DIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS classificacao_risco_final\\r\\n\\r\\nFROM teste.cancel_luciano_cnpjs cf\\r\\nLEFT JOIN teste.cancel_luciano_credito cr ON cf.cnpj_limpo = cr.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_indicios ind ON cf.cnpj_limpo = ind.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_normal dn ON cf.cnpj_limpo = dn.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_simples ds ON cf.cnpj_limpo = ds.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_nfe_emit nfe_e ON cf.cnpj_limpo = nfe_e.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_nfe_rec nfe_r ON cf.cnpj_limpo = nfe_r.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_recol rec ON cf.cnpj_limpo = rec.cnpj_limpo;\", \"\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- VERIFICA\\u00c7\\u00d5ES FINAIS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT '========== RESUMO FINAL ==========' AS info;\", \"\\r\\n\\r\\nSELECT 'Total registros' AS metrica, COUNT(*) AS valor FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Empresas distintas', COUNT(DISTINCT cnpj) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com NF-e emitidas', COUNT(CASE WHEN qtde_nfe_emitidas > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com NF-e recebidas', COUNT(CASE WHEN qtde_nfe_recebidas > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com ind\\u00edcios', COUNT(CASE WHEN qtde_indicios > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com ind\\u00edcios graves', COUNT(CASE WHEN qtde_indicios_graves > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com omiss\\u00f5es', COUNT(CASE WHEN periodos_omissos_dime > 0 OR periodos_omissos_pgdas > 0 THEN 1 END) FROM teste.cancel_luciano;\", \"\\r\\n\\r\\nSELECT '========== DISTRIBUI\\u00c7\\u00c3O POR RISCO ==========' AS info;\", \"\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_final,\\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.cancel_luciano\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final \\r\\n        WHEN 'CR\\u00cdTICO' THEN 1 \\r\\n        WHEN 'ALTO' THEN 2 \\r\\n        WHEN 'M\\u00c9DIO' THEN 3 \\r\\n        ELSE 4 \\r\\n    END;\", \"\\r\\n\\r\\nSELECT '========== DISTRIBUI\\u00c7\\u00c3O POR CATEGORIA ==========' AS info;\", \"\\r\\n\\r\\nSELECT \\r\\n    categoria_comportamento,\\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.cancel_luciano\\r\\nGROUP BY categoria_comportamento\\r\\nORDER BY qtde DESC;\", \"\\r\\n\\r\\nSELECT '========== TOP 10 POR SCORE ==========' AS info;\", \"\\r\\n\\r\\nSELECT \\r\\n    cnpj,\\r\\n    nome_contribuinte,\\r\\n    municipio,\\r\\n    data_cancelamento,\\r\\n    descricao_motivo_cancelamento,\\r\\n    categoria_comportamento,\\r\\n    classificacao_risco_final,\\r\\n    score_prioridade_acao,\\r\\n    saldo_credor_atual,\\r\\n    qtde_indicios,\\r\\n    qtde_indicios_graves,\\r\\n    qtde_nfe_emitidas,\\r\\n    vl_total_nfe_emitidas\\r\\nFROM teste.cancel_luciano\\r\\nORDER BY score_prioridade_acao DESC\\r\\nLIMIT 10;\", \"\\r\\n\\r\\nSELECT '========== TABELAS AUXILIARES CRIADAS ==========' AS info;\", \"\\r\\n\\r\\nSELECT 'cancel_luciano_cnpjs' AS tabela, COUNT(*) AS registros FROM teste.cancel_luciano_cnpjs\\r\\nUNION ALL SELECT 'cancel_luciano_nfe_emit', COUNT(*) FROM teste.cancel_luciano_nfe_emit\\r\\nUNION ALL SELECT 'cancel_luciano_nfe_rec', COUNT(*) FROM teste.cancel_luciano_nfe_rec\\r\\nUNION ALL SELECT 'cancel_luciano_indicios', COUNT(*) FROM teste.cancel_luciano_indicios\\r\\nUNION ALL SELECT 'cancel_luciano_normal', COUNT(*) FROM teste.cancel_luciano_normal\\r\\nUNION ALL SELECT 'cancel_luciano_simples', COUNT(*) FROM teste.cancel_luciano_simples\\r\\nUNION ALL SELECT 'cancel_luciano_credito', COUNT(*) FROM teste.cancel_luciano_credito\\r\\nUNION ALL SELECT 'cancel_luciano_recol', COUNT(*) FROM teste.cancel_luciano_recol\\r\\nUNION ALL SELECT 'cancel_luciano (FINAL)', COUNT(*) FROM teste.cancel_luciano;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- =====================================================================\\r\\n-- PROJETO LUCIANO - CRIA\\u00c7\\u00c3O DA TABELA cancel_luciano\\r\\n-- =====================================================================\\r\\n-- VERS\\u00c3O IMPALA OTIMIZADA\\r\\n-- Execute este script no Impala ANTES de rodar o Python\\r\\n-- =====================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 1: CRIAR TABELA COM CNPJs DO FISCAL\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_cnpjs;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_cnpjs AS\\r\\nSELECT DISTINCT\\r\\n    b.cnpj,\\r\\n    REGEXP_REPLACE(TRIM(CAST(b.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    b.ie,\\r\\n    b.nome_contribuinte,\\r\\n    b.razao_social,\\r\\n    b.municipio,\\r\\n    b.uf,\\r\\n    b.gerencia_regional,\\r\\n    b.cd_cnae,\\r\\n    b.descricao_cnae,\\r\\n    b.tipo_contribuinte,\\r\\n    b.regime_apuracao,\\r\\n    b.situacao_cadastral_atual,\\r\\n    b.protocolo,\\r\\n    b.data_inicio_protocolo AS data_cancelamento,\\r\\n    b.data_processamento,\\r\\n    b.cod_motivo,\\r\\n    b.parecer,\\r\\n    b.tipo_evento,\\r\\n    b.nome_fiscal,\\r\\n    b.flag_cancelamento_automatico,\\r\\n    b.flag_ainda_cancelada,\\r\\n    b.flag_reativada,\\r\\n    b.dias_desde_cancelamento,\\r\\n    m.total_protocolos AS total_protocolos_empresa,\\r\\n    m.taxa_permanencia_cancelamento_perc,\\r\\n    m.taxa_reativacao_perc,\\r\\n    m.flag_empresa_reincidente,\\r\\n    m.flag_atualmente_cancelada,\\r\\n    m.classificacao_frequencia,\\r\\n    m.classificacao_persistencia,\\r\\n    m.efetividade_cancelamento,\\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento\\r\\nFROM teste.luciano_base b\\r\\nLEFT JOIN teste.luciano_metricas m ON b.cnpj = m.cnpj\\r\\nWHERE (b.nome_fiscal LIKE '%LUCIANO%TREVISAN%'\\r\\n   OR b.nome_fiscal LIKE '%LUCIANO%FREITAS%'\\r\\n   OR UPPER(b.nome_fiscal) LIKE '%LUCIANO TREVISAN FREITAS%')\\r\\n  AND YEAR(b.data_inicio_protocolo) = 2025;\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 2: NF-e EMITIDAS (SA\\u00cdDAS) - OTIMIZADO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_nfe_emit;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_nfe_emit AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COUNT(DISTINCT nfe.chave) AS qtde_nfe_emitidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vnf, 0)) AS vl_total_nfe_emitidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vicms, 0)) AS vl_icms_nfe_emitidas,\\r\\n    MIN(nfe.procnfe.nfe.infnfe.ide.dhemi) AS primeira_nfe_emitida,\\r\\n    MAX(nfe.procnfe.nfe.infnfe.ide.dhemi) AS ultima_nfe_emitida,\\r\\n    COUNT(DISTINCT nfe.procnfe.nfe.infnfe.dest.cnpj) AS qtde_destinatarios_distintos\\r\\nFROM nfe.nfe nfe\\r\\n-- JOIN com a tabela de CNPJs (MUITO mais eficiente que IN)\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE nfe.ano_emissao >= 2021\\r\\n  AND nfe.procnfe.nfe.infnfe.ide.tpnf = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 3: NF-e RECEBIDAS (ENTRADAS) - OTIMIZADO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_nfe_rec;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_nfe_rec AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COUNT(DISTINCT nfe.chave) AS qtde_nfe_recebidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vnf, 0)) AS vl_total_nfe_recebidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vicms, 0)) AS vl_icms_nfe_recebidas,\\r\\n    MIN(nfe.procnfe.nfe.infnfe.ide.dhemi) AS primeira_nfe_recebida,\\r\\n    MAX(nfe.procnfe.nfe.infnfe.ide.dhemi) AS ultima_nfe_recebida,\\r\\n    COUNT(DISTINCT nfe.procnfe.nfe.infnfe.emit.cnpj) AS qtde_fornecedores_distintos\\r\\nFROM nfe.nfe nfe\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE nfe.ano_emissao >= 2021\\r\\n  AND nfe.procnfe.nfe.infnfe.ide.tpnf = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 4: IND\\u00cdCIOS CORRIGIDOS\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_indicios;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_indicios AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    \\r\\n    COUNT(*) AS qtde_indicios,\\r\\n    COUNT(DISTINCT ei.cd_indicio) AS qtde_tipos_indicios,\\r\\n    SUM(COALESCE(ei.nu_score, 0)) AS soma_scores_indicios,\\r\\n    ROUND(AVG(COALESCE(ei.nu_score, 0)), 2) AS media_score_indicios,\\r\\n    MAX(COALESCE(ei.nu_score, 0)) AS max_score_indicio,\\r\\n    \\r\\n    -- Ind\\u00edcios graves: score >= 50\\r\\n    SUM(CASE WHEN COALESCE(ei.nu_score, 0) >= 50 THEN 1 ELSE 0 END) AS qtde_indicios_graves,\\r\\n    \\r\\n    -- Ind\\u00edcios cr\\u00edticos: score >= 80\\r\\n    SUM(CASE WHEN COALESCE(ei.nu_score, 0) >= 80 THEN 1 ELSE 0 END) AS qtde_indicios_criticos,\\r\\n    \\r\\n    -- Categorias espec\\u00edficas\\r\\n    SUM(CASE WHEN ei.cd_indicio = 11 THEN 1 ELSE 0 END) AS qtde_omissao_dime,\\r\\n    SUM(CASE WHEN ei.cd_indicio = 12 THEN 1 ELSE 0 END) AS qtde_omissao_pgdas,\\r\\n    SUM(CASE WHEN ei.cd_indicio IN (1, 2, 3, 4) THEN 1 ELSE 0 END) AS qtde_indicios_docs_fiscais,\\r\\n    SUM(CASE WHEN ei.cd_indicio IN (5, 6, 7, 8, 62, 63) THEN 1 ELSE 0 END) AS qtde_indicios_relacionamentos,\\r\\n    \\r\\n    GROUP_CONCAT(DISTINCT CAST(ei.cd_indicio AS STRING), ',') AS lista_cod_indicios\\r\\n    \\r\\nFROM neaf.empresa_indicio ei\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE ei.cd_atual = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 5: DADOS NORMAL (DIME)\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_normal;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_normal AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(zn.nm_contador) AS contador,\\r\\n    MAX(COALESCE(zn.total_vl_faturamento, 0)) AS vl_faturamento_dime,\\r\\n    MAX(COALESCE(zn.total_vl_receita_bruta, 0)) AS vl_receita_bruta_dime,\\r\\n    MAX(COALESCE(zn.total_vl_tot_cred, 0)) AS vl_credito_dime,\\r\\n    MAX(COALESCE(zn.total_vl_tot_deb, 0)) AS vl_debito_dime,\\r\\n    MAX(COALESCE(zn.total_vl_deb_recolher, 0)) AS vl_deb_recolher_dime,\\r\\n    MAX(COALESCE(zn.periodos_omissos, 0)) AS periodos_omissos_dime,\\r\\n    MAX(COALESCE(zn.periodos_zerados, 0)) AS periodos_zerados_dime,\\r\\n    MAX(COALESCE(zn.periodos_sem_movimento, 0)) AS periodos_sem_movimento_dime,\\r\\n    MAX(COALESCE(zn.total_periodos, 0)) AS total_periodos_dime,\\r\\n    MAX(COALESCE(zn.periodos_declarados, 0)) AS periodos_declarados_dime,\\r\\n    MAX(COALESCE(zn.nfes_emitidas_normal, 0)) AS nfes_tab_normal,\\r\\n    MAX(COALESCE(zn.flag_omissao_dime_indicio, 0)) AS flag_omissao_dime\\r\\nFROM teste.cancel_zero_normal zn\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 6: DADOS SIMPLES (PGDAS)\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_simples;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_simples AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(zs.nm_contador) AS contador,\\r\\n    MAX(COALESCE(zs.total_vl_rec_bruta, 0)) AS vl_receita_bruta_pgdas,\\r\\n    MAX(COALESCE(zs.max_vl_rec_bruta_em_12m, 0)) AS vl_rec_bruta_12m_pgdas,\\r\\n    MAX(COALESCE(zs.total_vl_icms_sc, 0)) AS vl_icms_sc_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_omissos, 0)) AS periodos_omissos_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_zerados, 0)) AS periodos_zerados_pgdas,\\r\\n    MAX(COALESCE(zs.total_periodos, 0)) AS total_periodos_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_declarados, 0)) AS periodos_declarados_pgdas,\\r\\n    MAX(COALESCE(zs.nfes_emitidas_simples, 0)) AS nfes_tab_simples,\\r\\n    MAX(COALESCE(zs.flag_omissao_pgdas_indicio, 0)) AS flag_omissao_pgdas\\r\\nFROM teste.cancel_zero_simples zs\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 7: DADOS DE CR\\u00c9DITO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_credito;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_credito AS\\r\\nSELECT\\r\\n    lc.cnpj_limpo,\\r\\n    COALESCE(cr.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    COALESCE(cr.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(cr.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cr.flag_saldo_alto_cancelada, 0) AS flag_saldo_alto_cancelada,\\r\\n    COALESCE(cr.flag_suspeita_valores_repetidos, 0) AS flag_suspeita_valores_repetidos,\\r\\n    COALESCE(cr.perc_valores_iguais_12m, 0) AS perc_valores_iguais_12m,\\r\\n    COALESCE(cr.variacao_saldo_perc_60m, 0) AS variacao_saldo_perc_60m\\r\\nFROM teste.cancel_luciano_cnpjs lc\\r\\nLEFT JOIN teste.luciano_credito cr ON lc.cnpj = cr.cnpj;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 8: DADOS DE RECOLHIMENTO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_recol;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_recol AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COALESCE(SUM(r.quantidade_pagtos), 0) AS quantidade_pagamentos,\\r\\n    COALESCE(SUM(r.valor_pagtos), 0) AS valor_pagamentos\\r\\nFROM teste.cancel_recolhimento r\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 9: TABELA FINAL CONSOLIDADA - teste.cancel_luciano\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano AS\\r\\nSELECT \\r\\n    -- =========================================================\\r\\n    -- IDENTIFICA\\u00c7\\u00c3O\\r\\n    -- =========================================================\\r\\n    cf.cnpj,\\r\\n    cf.cnpj_limpo,\\r\\n    cf.ie,\\r\\n    cf.nome_contribuinte,\\r\\n    cf.razao_social,\\r\\n    cf.municipio,\\r\\n    cf.uf,\\r\\n    cf.gerencia_regional,\\r\\n    cf.cd_cnae,\\r\\n    cf.descricao_cnae,\\r\\n    cf.tipo_contribuinte,\\r\\n    cf.regime_apuracao,\\r\\n    cf.situacao_cadastral_atual,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS DO CANCELAMENTO\\r\\n    -- =========================================================\\r\\n    cf.protocolo,\\r\\n    cf.data_cancelamento,\\r\\n    cf.data_processamento,\\r\\n    cf.cod_motivo,\\r\\n    CASE cf.cod_motivo\\r\\n        WHEN 1 THEN 'INEXIST\\u00caNCIA OU INATIVIDADE DO ESTABELECIMENTO'\\r\\n        WHEN 2 THEN 'FALTA DE PEDIDO DE REATIVA\\u00c7\\u00c3O'\\r\\n        WHEN 3 THEN 'OMISS\\u00c3O DIME/GIA-ST/PGDAS-D OU ZERADAS/SEM MOVIMENTO 6 MESES'\\r\\n        WHEN 4 THEN 'DESCUMPRIMENTO LEGISLA\\u00c7\\u00c3O ATIVIDADE REGULAMENTADA'\\r\\n        WHEN 5 THEN 'FALTA APRESENTA\\u00c7\\u00c3O INFORMA\\u00c7\\u00d5ES ECON\\u00d4MICO-FISCAIS'\\r\\n        WHEN 6 THEN 'DECIS\\u00c3O JUDICIAL'\\r\\n        WHEN 7 THEN 'REGISTRO CNPJ/MUNIC\\u00cdPIO/JUNTA EXTINTO/CANCELADO/BAIXADO/INAPTO'\\r\\n        WHEN 8 THEN '(DESATIVADO) SUBSTITUTO SEM RECOLHER 90 DIAS'\\r\\n        WHEN 9 THEN '(DESATIVADO) D\\u00c9BITO D\\u00cdVIDA ATIVA > CAPITAL SOCIAL'\\r\\n        WHEN 10 THEN '(DESATIVADO) FALTA ATIVA\\u00c7\\u00c3O PRAZO REGULAMENTAR'\\r\\n        WHEN 11 THEN '(DESATIVADO) PERDA CONDI\\u00c7\\u00c3O CONTRIBUINTE'\\r\\n        WHEN 12 THEN 'PERDA DA CONDI\\u00c7\\u00c3O DE CONTRIBUINTE'\\r\\n        WHEN 13 THEN 'FALTA RECOLHIMENTO/GIA-ST 2 MESES NOS \\u00daLTIMOS 90 DIAS'\\r\\n        WHEN 14 THEN 'INSCRI\\u00c7\\u00c3O/ALTERA\\u00c7\\u00c3O MEDIANTE FRAUDE'\\r\\n        WHEN 15 THEN 'OPERA\\u00c7\\u00c3O COM PRODUTOS DE ORIGEM IL\\u00cdCITA'\\r\\n        WHEN 16 THEN 'DISPOSITIVO BOMBA COMBUST\\u00cdVEL - MENOS QUE INDICADO'\\r\\n        WHEN 17 THEN 'COMERCIALIZA\\u00c7\\u00c3O COMBUST\\u00cdVEL ADULTERADO'\\r\\n        WHEN 18 THEN 'FALTA REQUISITOS PARA INSCRI\\u00c7\\u00c3O ESTADUAL'\\r\\n        WHEN 19 THEN 'CONDENA\\u00c7\\u00c3O CRIME CONTRA ORDEM TRIBUT\\u00c1RIA'\\r\\n        WHEN 20 THEN 'D\\u00c9BITO D\\u00cdVIDA ATIVA > CAPITAL SOCIAL'\\r\\n        WHEN 21 THEN 'SUSPENS\\u00c3O DF-e N\\u00c3O RECLAMADA OU MANTIDA'\\r\\n        WHEN 22 THEN 'FALTA LISTA PRE\\u00c7OS PRODUTOS FUMO'\\r\\n        WHEN 23 THEN 'DESCUMPRIMENTO OBRIGA\\u00c7\\u00c3O ST ENTRADA'\\r\\n        WHEN 24 THEN 'N\\u00c3O EXERCE ATIVIDADE ICMS - CNAE INDEVIDO'\\r\\n        WHEN 25 THEN 'ALTERA\\u00c7\\u00c3O CADASTRAL INGRESSO PESSOA IRREGULAR'\\r\\n        ELSE CONCAT('MOTIVO ', COALESCE(CAST(cf.cod_motivo AS STRING), 'N/A'))\\r\\n    END AS descricao_motivo_cancelamento,\\r\\n    cf.parecer,\\r\\n    cf.tipo_evento,\\r\\n    cf.nome_fiscal,\\r\\n    cf.flag_cancelamento_automatico,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- SITUA\\u00c7\\u00c3O ATUAL\\r\\n    -- =========================================================\\r\\n    cf.flag_ainda_cancelada,\\r\\n    cf.flag_reativada,\\r\\n    cf.dias_desde_cancelamento,\\r\\n    cf.total_protocolos_empresa,\\r\\n    cf.classificacao_frequencia,\\r\\n    cf.classificacao_persistencia,\\r\\n    cf.efetividade_cancelamento,\\r\\n    cf.flag_empresa_reincidente,\\r\\n    cf.data_primeiro_cancelamento,\\r\\n    cf.data_ultimo_cancelamento,\\r\\n    cf.taxa_permanencia_cancelamento_perc,\\r\\n    cf.taxa_reativacao_perc,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS DE CR\\u00c9DITO\\r\\n    -- =========================================================\\r\\n    COALESCE(cr.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    COALESCE(cr.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(cr.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cr.flag_saldo_alto_cancelada, 0) AS flag_saldo_alto_cancelada,\\r\\n    COALESCE(cr.flag_suspeita_valores_repetidos, 0) AS flag_suspeita_valores_repetidos,\\r\\n    COALESCE(cr.perc_valores_iguais_12m, 0) AS perc_valores_iguais_12m,\\r\\n    COALESCE(cr.variacao_saldo_perc_60m, 0) AS variacao_saldo_perc_60m,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- IND\\u00cdCIOS (CORRIGIDOS)\\r\\n    -- =========================================================\\r\\n    COALESCE(ind.qtde_indicios, 0) AS qtde_indicios,\\r\\n    COALESCE(ind.qtde_tipos_indicios, 0) AS qtde_tipos_indicios,\\r\\n    COALESCE(ind.soma_scores_indicios, 0) AS soma_scores_indicios,\\r\\n    COALESCE(ind.media_score_indicios, 0) AS media_score_indicios,\\r\\n    COALESCE(ind.max_score_indicio, 0) AS max_score_indicio,\\r\\n    COALESCE(ind.qtde_indicios_graves, 0) AS qtde_indicios_graves,\\r\\n    COALESCE(ind.qtde_indicios_criticos, 0) AS qtde_indicios_criticos,\\r\\n    COALESCE(ind.qtde_omissao_dime, 0) AS qtde_omissao_dime,\\r\\n    COALESCE(ind.qtde_omissao_pgdas, 0) AS qtde_omissao_pgdas,\\r\\n    COALESCE(ind.qtde_indicios_docs_fiscais, 0) AS qtde_indicios_docs_fiscais,\\r\\n    COALESCE(ind.qtde_indicios_relacionamentos, 0) AS qtde_indicios_relacionamentos,\\r\\n    ind.lista_cod_indicios,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS REGIME NORMAL (DIME)\\r\\n    -- =========================================================\\r\\n    dn.contador AS contador_normal,\\r\\n    COALESCE(dn.vl_faturamento_dime, 0) AS vl_faturamento_dime,\\r\\n    COALESCE(dn.vl_receita_bruta_dime, 0) AS vl_receita_bruta_dime,\\r\\n    COALESCE(dn.vl_credito_dime, 0) AS vl_credito_dime,\\r\\n    COALESCE(dn.vl_debito_dime, 0) AS vl_debito_dime,\\r\\n    COALESCE(dn.vl_deb_recolher_dime, 0) AS vl_deb_recolher_dime,\\r\\n    COALESCE(dn.periodos_omissos_dime, 0) AS periodos_omissos_dime,\\r\\n    COALESCE(dn.periodos_zerados_dime, 0) AS periodos_zerados_dime,\\r\\n    COALESCE(dn.periodos_sem_movimento_dime, 0) AS periodos_sem_movimento_dime,\\r\\n    COALESCE(dn.total_periodos_dime, 0) AS total_periodos_dime,\\r\\n    COALESCE(dn.periodos_declarados_dime, 0) AS periodos_declarados_dime,\\r\\n    COALESCE(dn.flag_omissao_dime, 0) AS flag_omissao_dime,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS SIMPLES NACIONAL (PGDAS)\\r\\n    -- =========================================================\\r\\n    ds.contador AS contador_simples,\\r\\n    COALESCE(ds.vl_receita_bruta_pgdas, 0) AS vl_receita_bruta_pgdas,\\r\\n    COALESCE(ds.vl_rec_bruta_12m_pgdas, 0) AS vl_rec_bruta_12m_pgdas,\\r\\n    COALESCE(ds.vl_icms_sc_pgdas, 0) AS vl_icms_sc_pgdas,\\r\\n    COALESCE(ds.periodos_omissos_pgdas, 0) AS periodos_omissos_pgdas,\\r\\n    COALESCE(ds.periodos_zerados_pgdas, 0) AS periodos_zerados_pgdas,\\r\\n    COALESCE(ds.total_periodos_pgdas, 0) AS total_periodos_pgdas,\\r\\n    COALESCE(ds.periodos_declarados_pgdas, 0) AS periodos_declarados_pgdas,\\r\\n    COALESCE(ds.flag_omissao_pgdas, 0) AS flag_omissao_pgdas,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- NF-e EMITIDAS (SA\\u00cdDAS)\\r\\n    -- =========================================================\\r\\n    COALESCE(nfe_e.qtde_nfe_emitidas, 0) AS qtde_nfe_emitidas,\\r\\n    COALESCE(nfe_e.vl_total_nfe_emitidas, 0) AS vl_total_nfe_emitidas,\\r\\n    COALESCE(nfe_e.vl_icms_nfe_emitidas, 0) AS vl_icms_nfe_emitidas,\\r\\n    nfe_e.primeira_nfe_emitida,\\r\\n    nfe_e.ultima_nfe_emitida,\\r\\n    COALESCE(nfe_e.qtde_destinatarios_distintos, 0) AS qtde_destinatarios_distintos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- NF-e RECEBIDAS (ENTRADAS)\\r\\n    -- =========================================================\\r\\n    COALESCE(nfe_r.qtde_nfe_recebidas, 0) AS qtde_nfe_recebidas,\\r\\n    COALESCE(nfe_r.vl_total_nfe_recebidas, 0) AS vl_total_nfe_recebidas,\\r\\n    COALESCE(nfe_r.vl_icms_nfe_recebidas, 0) AS vl_icms_nfe_recebidas,\\r\\n    nfe_r.primeira_nfe_recebida,\\r\\n    nfe_r.ultima_nfe_recebida,\\r\\n    COALESCE(nfe_r.qtde_fornecedores_distintos, 0) AS qtde_fornecedores_distintos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- RECOLHIMENTO\\r\\n    -- =========================================================\\r\\n    COALESCE(rec.quantidade_pagamentos, 0) AS quantidade_pagamentos,\\r\\n    COALESCE(rec.valor_pagamentos, 0) AS valor_pagamentos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- CATEGORIZA\\u00c7\\u00c3O POR COMPORTAMENTO\\r\\n    -- =========================================================\\r\\n    CASE \\r\\n        WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 AND cf.flag_ainda_cancelada = 1 \\r\\n        THEN 'ALTO_RISCO_FINANCEIRO'\\r\\n        \\r\\n        WHEN (COALESCE(ind.qtde_indicios_graves, 0) > 0 OR COALESCE(ind.soma_scores_indicios, 0) > 200) \\r\\n             AND cf.flag_ainda_cancelada = 1\\r\\n        THEN 'FRAUDE_POTENCIAL'\\r\\n        \\r\\n        WHEN cf.total_protocolos_empresa >= 3 AND cf.flag_ainda_cancelada = 1\\r\\n        THEN 'REINCIDENTE_CRONICO'\\r\\n        \\r\\n        WHEN (COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 OR COALESCE(cr.perc_valores_iguais_12m, 0) > 50) \\r\\n             AND COALESCE(cr.saldo_credor_atual, 0) > 10000\\r\\n        THEN 'CREDITO_SUSPEITO'\\r\\n        \\r\\n        WHEN cf.flag_ainda_cancelada = 1 AND COALESCE(cr.saldo_credor_atual, 0) = 0 \\r\\n             AND COALESCE(ind.qtde_indicios, 0) = 0\\r\\n        THEN 'CANCELAMENTO_EFETIVO'\\r\\n        \\r\\n        WHEN cf.flag_reativada = 1 AND COALESCE(cr.saldo_credor_atual, 0) < 10000 \\r\\n             AND COALESCE(ind.qtde_indicios, 0) = 0\\r\\n        THEN 'REATIVADA_SEM_RISCO'\\r\\n        \\r\\n        WHEN cf.flag_reativada = 1 AND (COALESCE(cr.saldo_credor_atual, 0) > 50000 \\r\\n             OR COALESCE(ind.qtde_indicios, 0) > 0)\\r\\n        THEN 'REATIVADA_COM_RISCO'\\r\\n        \\r\\n        ELSE 'OUTROS'\\r\\n    END AS categoria_comportamento,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- SCORE DE PRIORIDADE PARA A\\u00c7\\u00c3O\\r\\n    -- =========================================================\\r\\n    (\\r\\n        -- Score por saldo credor\\r\\n        CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por ind\\u00edcios\\r\\n        CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n             WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n             WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n             WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por reincid\\u00eancia\\r\\n        CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n             WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n             WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por valores suspeitos\\r\\n        CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n        +\\r\\n        -- Score por omiss\\u00f5es\\r\\n        CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n               OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n             WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n               OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por declara\\u00e7\\u00f5es zeradas\\r\\n        CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n               OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por NF-e sem declara\\u00e7\\u00e3o correspondente\\r\\n        CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n              AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n              AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n             ELSE 0 END\\r\\n    ) AS score_prioridade_acao,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O DE RISCO FINAL\\r\\n    -- =========================================================\\r\\n    CASE \\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 50 THEN 'ALTO'\\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 30 THEN 'M\\u00c9DIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS classificacao_risco_final\\r\\n\\r\\nFROM teste.cancel_luciano_cnpjs cf\\r\\nLEFT JOIN teste.cancel_luciano_credito cr ON cf.cnpj_limpo = cr.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_indicios ind ON cf.cnpj_limpo = ind.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_normal dn ON cf.cnpj_limpo = dn.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_simples ds ON cf.cnpj_limpo = ds.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_nfe_emit nfe_e ON cf.cnpj_limpo = nfe_e.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_nfe_rec nfe_r ON cf.cnpj_limpo = nfe_r.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_recol rec ON cf.cnpj_limpo = rec.cnpj_limpo;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- VERIFICA\\u00c7\\u00d5ES FINAIS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT '========== RESUMO FINAL ==========' AS info;\\r\\n\\r\\nSELECT 'Total registros' AS metrica, COUNT(*) AS valor FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Empresas distintas', COUNT(DISTINCT cnpj) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com NF-e emitidas', COUNT(CASE WHEN qtde_nfe_emitidas > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com NF-e recebidas', COUNT(CASE WHEN qtde_nfe_recebidas > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com ind\\u00edcios', COUNT(CASE WHEN qtde_indicios > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com ind\\u00edcios graves', COUNT(CASE WHEN qtde_indicios_graves > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com omiss\\u00f5es', COUNT(CASE WHEN periodos_omissos_dime > 0 OR periodos_omissos_pgdas > 0 THEN 1 END) FROM teste.cancel_luciano;\\r\\n\\r\\nSELECT '========== DISTRIBUI\\u00c7\\u00c3O POR RISCO ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_final,\\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.cancel_luciano\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final \\r\\n        WHEN 'CR\\u00cdTICO' THEN 1 \\r\\n        WHEN 'ALTO' THEN 2 \\r\\n        WHEN 'M\\u00c9DIO' THEN 3 \\r\\n        ELSE 4 \\r\\n    END;\\r\\n\\r\\nSELECT '========== DISTRIBUI\\u00c7\\u00c3O POR CATEGORIA ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    categoria_comportamento,\\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.cancel_luciano\\r\\nGROUP BY categoria_comportamento\\r\\nORDER BY qtde DESC;\\r\\n\\r\\nSELECT '========== TOP 10 POR SCORE ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    cnpj,\\r\\n    nome_contribuinte,\\r\\n    municipio,\\r\\n    data_cancelamento,\\r\\n    descricao_motivo_cancelamento,\\r\\n    categoria_comportamento,\\r\\n    classificacao_risco_final,\\r\\n    score_prioridade_acao,\\r\\n    saldo_credor_atual,\\r\\n    qtde_indicios,\\r\\n    qtde_indicios_graves,\\r\\n    qtde_nfe_emitidas,\\r\\n    vl_total_nfe_emitidas\\r\\nFROM teste.cancel_luciano\\r\\nORDER BY score_prioridade_acao DESC\\r\\nLIMIT 10;\\r\\n\\r\\nSELECT '========== TABELAS AUXILIARES CRIADAS ==========' AS info;\\r\\n\\r\\nSELECT 'cancel_luciano_cnpjs' AS tabela, COUNT(*) AS registros FROM teste.cancel_luciano_cnpjs\\r\\nUNION ALL SELECT 'cancel_luciano_nfe_emit', COUNT(*) FROM teste.cancel_luciano_nfe_emit\\r\\nUNION ALL SELECT 'cancel_luciano_nfe_rec', COUNT(*) FROM teste.cancel_luciano_nfe_rec\\r\\nUNION ALL SELECT 'cancel_luciano_indicios', COUNT(*) FROM teste.cancel_luciano_indicios\\r\\nUNION ALL SELECT 'cancel_luciano_normal', COUNT(*) FROM teste.cancel_luciano_normal\\r\\nUNION ALL SELECT 'cancel_luciano_simples', COUNT(*) FROM teste.cancel_luciano_simples\\r\\nUNION ALL SELECT 'cancel_luciano_credito', COUNT(*) FROM teste.cancel_luciano_credito\\r\\nUNION ALL SELECT 'cancel_luciano_recol', COUNT(*) FROM teste.cancel_luciano_recol\\r\\nUNION ALL SELECT 'cancel_luciano (FINAL)', COUNT(*) FROM teste.cancel_luciano;\", \"result\": {\"id\": \"462077cb-4ef9-24e7-ef8f-8f07aea7c138\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"dgMCxpB7R82dJdVgHh8ozw==\", \"guid\": \"eDIQBHJFRM0AAAAAf89fgA==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"d54757a645b6a61e:5581e5bd8c9ab6b9\", \"session_id\": 23333, \"session_type\": \"impala\", \"statement_id\": 19, \"has_more_statements\": true, \"statements_count\": 29, \"previous_statement_hash\": \"109269e578c04ab7f9d2ed6aceeb02c841a788ace23f061be1b39feb\", \"start\": {\"row\": 585, \"column\": 0}, \"end\": {\"row\": 589, \"column\": 52}, \"statement\": \"-- =====================================================================\\n-- VERIFICA\\u00c7\\u00d5ES FINAIS\\n-- =====================================================================\\n\\nSELECT '========== RESUMO FINAL ==========' AS info\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 19, \"statement_range\": {\"start\": {\"row\": 585, \"column\": 0}, \"end\": {\"row\": 589, \"column\": 52}}, \"statements_count\": 29, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"info\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-12-01T19:40:32.853Z\", \"endTime\": \"2025-12-01T19:40:33.035Z\", \"executionTime\": 182, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 3, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 21004, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"info\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": 21139, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1764618032550, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- =====================================================================\\r\\n-- PROJETO LUCIANO - CRIA\\u00c7\\u00c3O DA TABELA cancel_luciano\\r\\n-- =====================================================================\\r\\n-- VERS\\u00c3O IMPALA OTIMIZADA\\r\\n-- Execute este script no Impala ANTES de rodar o Python\\r\\n-- =====================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 1: CRIAR TABELA COM CNPJs DO FISCAL\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_cnpjs;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_cnpjs AS\\r\\nSELECT DISTINCT\\r\\n    b.cnpj,\\r\\n    REGEXP_REPLACE(TRIM(CAST(b.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    b.ie,\\r\\n    b.nome_contribuinte,\\r\\n    b.razao_social,\\r\\n    b.municipio,\\r\\n    b.uf,\\r\\n    b.gerencia_regional,\\r\\n    b.cd_cnae,\\r\\n    b.descricao_cnae,\\r\\n    b.tipo_contribuinte,\\r\\n    b.regime_apuracao,\\r\\n    b.situacao_cadastral_atual,\\r\\n    b.protocolo,\\r\\n    b.data_inicio_protocolo AS data_cancelamento,\\r\\n    b.data_processamento,\\r\\n    b.cod_motivo,\\r\\n    b.parecer,\\r\\n    b.tipo_evento,\\r\\n    b.nome_fiscal,\\r\\n    b.flag_cancelamento_automatico,\\r\\n    b.flag_ainda_cancelada,\\r\\n    b.flag_reativada,\\r\\n    b.dias_desde_cancelamento,\\r\\n    m.total_protocolos AS total_protocolos_empresa,\\r\\n    m.taxa_permanencia_cancelamento_perc,\\r\\n    m.taxa_reativacao_perc,\\r\\n    m.flag_empresa_reincidente,\\r\\n    m.flag_atualmente_cancelada,\\r\\n    m.classificacao_frequencia,\\r\\n    m.classificacao_persistencia,\\r\\n    m.efetividade_cancelamento,\\r\\n    m.data_primeiro_cancelamento,\\r\\n    m.data_ultimo_cancelamento\\r\\nFROM teste.luciano_base b\\r\\nLEFT JOIN teste.luciano_metricas m ON b.cnpj = m.cnpj\\r\\nWHERE (b.nome_fiscal LIKE '%LUCIANO%TREVISAN%'\\r\\n   OR b.nome_fiscal LIKE '%LUCIANO%FREITAS%'\\r\\n   OR UPPER(b.nome_fiscal) LIKE '%LUCIANO TREVISAN FREITAS%')\\r\\n  AND YEAR(b.data_inicio_protocolo) = 2025;\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 2: NF-e EMITIDAS (SA\\u00cdDAS) - OTIMIZADO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_nfe_emit;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_nfe_emit AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COUNT(DISTINCT nfe.chave) AS qtde_nfe_emitidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vnf, 0)) AS vl_total_nfe_emitidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vicms, 0)) AS vl_icms_nfe_emitidas,\\r\\n    MIN(nfe.procnfe.nfe.infnfe.ide.dhemi) AS primeira_nfe_emitida,\\r\\n    MAX(nfe.procnfe.nfe.infnfe.ide.dhemi) AS ultima_nfe_emitida,\\r\\n    COUNT(DISTINCT nfe.procnfe.nfe.infnfe.dest.cnpj) AS qtde_destinatarios_distintos\\r\\nFROM nfe.nfe nfe\\r\\n-- JOIN com a tabela de CNPJs (MUITO mais eficiente que IN)\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE nfe.ano_emissao >= 2021\\r\\n  AND nfe.procnfe.nfe.infnfe.ide.tpnf = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.emit.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 3: NF-e RECEBIDAS (ENTRADAS) - OTIMIZADO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_nfe_rec;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_nfe_rec AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COUNT(DISTINCT nfe.chave) AS qtde_nfe_recebidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vnf, 0)) AS vl_total_nfe_recebidas,\\r\\n    SUM(COALESCE(nfe.procnfe.nfe.infnfe.total.icmstot.vicms, 0)) AS vl_icms_nfe_recebidas,\\r\\n    MIN(nfe.procnfe.nfe.infnfe.ide.dhemi) AS primeira_nfe_recebida,\\r\\n    MAX(nfe.procnfe.nfe.infnfe.ide.dhemi) AS ultima_nfe_recebida,\\r\\n    COUNT(DISTINCT nfe.procnfe.nfe.infnfe.emit.cnpj) AS qtde_fornecedores_distintos\\r\\nFROM nfe.nfe nfe\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE nfe.ano_emissao >= 2021\\r\\n  AND nfe.procnfe.nfe.infnfe.ide.tpnf = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(nfe.procnfe.nfe.infnfe.dest.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 4: IND\\u00cdCIOS CORRIGIDOS\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_indicios;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_indicios AS\\r\\nSELECT \\r\\n    REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    \\r\\n    COUNT(*) AS qtde_indicios,\\r\\n    COUNT(DISTINCT ei.cd_indicio) AS qtde_tipos_indicios,\\r\\n    SUM(COALESCE(ei.nu_score, 0)) AS soma_scores_indicios,\\r\\n    ROUND(AVG(COALESCE(ei.nu_score, 0)), 2) AS media_score_indicios,\\r\\n    MAX(COALESCE(ei.nu_score, 0)) AS max_score_indicio,\\r\\n    \\r\\n    -- Ind\\u00edcios graves: score >= 50\\r\\n    SUM(CASE WHEN COALESCE(ei.nu_score, 0) >= 50 THEN 1 ELSE 0 END) AS qtde_indicios_graves,\\r\\n    \\r\\n    -- Ind\\u00edcios cr\\u00edticos: score >= 80\\r\\n    SUM(CASE WHEN COALESCE(ei.nu_score, 0) >= 80 THEN 1 ELSE 0 END) AS qtde_indicios_criticos,\\r\\n    \\r\\n    -- Categorias espec\\u00edficas\\r\\n    SUM(CASE WHEN ei.cd_indicio = 11 THEN 1 ELSE 0 END) AS qtde_omissao_dime,\\r\\n    SUM(CASE WHEN ei.cd_indicio = 12 THEN 1 ELSE 0 END) AS qtde_omissao_pgdas,\\r\\n    SUM(CASE WHEN ei.cd_indicio IN (1, 2, 3, 4) THEN 1 ELSE 0 END) AS qtde_indicios_docs_fiscais,\\r\\n    SUM(CASE WHEN ei.cd_indicio IN (5, 6, 7, 8, 62, 63) THEN 1 ELSE 0 END) AS qtde_indicios_relacionamentos,\\r\\n    \\r\\n    GROUP_CONCAT(DISTINCT CAST(ei.cd_indicio AS STRING), ',') AS lista_cod_indicios\\r\\n    \\r\\nFROM neaf.empresa_indicio ei\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nWHERE ei.cd_atual = 1\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(ei.nu_cpf_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 5: DADOS NORMAL (DIME)\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_normal;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_normal AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(zn.nm_contador) AS contador,\\r\\n    MAX(COALESCE(zn.total_vl_faturamento, 0)) AS vl_faturamento_dime,\\r\\n    MAX(COALESCE(zn.total_vl_receita_bruta, 0)) AS vl_receita_bruta_dime,\\r\\n    MAX(COALESCE(zn.total_vl_tot_cred, 0)) AS vl_credito_dime,\\r\\n    MAX(COALESCE(zn.total_vl_tot_deb, 0)) AS vl_debito_dime,\\r\\n    MAX(COALESCE(zn.total_vl_deb_recolher, 0)) AS vl_deb_recolher_dime,\\r\\n    MAX(COALESCE(zn.periodos_omissos, 0)) AS periodos_omissos_dime,\\r\\n    MAX(COALESCE(zn.periodos_zerados, 0)) AS periodos_zerados_dime,\\r\\n    MAX(COALESCE(zn.periodos_sem_movimento, 0)) AS periodos_sem_movimento_dime,\\r\\n    MAX(COALESCE(zn.total_periodos, 0)) AS total_periodos_dime,\\r\\n    MAX(COALESCE(zn.periodos_declarados, 0)) AS periodos_declarados_dime,\\r\\n    MAX(COALESCE(zn.nfes_emitidas_normal, 0)) AS nfes_tab_normal,\\r\\n    MAX(COALESCE(zn.flag_omissao_dime_indicio, 0)) AS flag_omissao_dime\\r\\nFROM teste.cancel_zero_normal zn\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(zn.nu_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 6: DADOS SIMPLES (PGDAS)\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_simples;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_simples AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(zs.nm_contador) AS contador,\\r\\n    MAX(COALESCE(zs.total_vl_rec_bruta, 0)) AS vl_receita_bruta_pgdas,\\r\\n    MAX(COALESCE(zs.max_vl_rec_bruta_em_12m, 0)) AS vl_rec_bruta_12m_pgdas,\\r\\n    MAX(COALESCE(zs.total_vl_icms_sc, 0)) AS vl_icms_sc_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_omissos, 0)) AS periodos_omissos_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_zerados, 0)) AS periodos_zerados_pgdas,\\r\\n    MAX(COALESCE(zs.total_periodos, 0)) AS total_periodos_pgdas,\\r\\n    MAX(COALESCE(zs.periodos_declarados, 0)) AS periodos_declarados_pgdas,\\r\\n    MAX(COALESCE(zs.nfes_emitidas_simples, 0)) AS nfes_tab_simples,\\r\\n    MAX(COALESCE(zs.flag_omissao_pgdas_indicio, 0)) AS flag_omissao_pgdas\\r\\nFROM teste.cancel_zero_simples zs\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(zs.nu_cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 7: DADOS DE CR\\u00c9DITO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_credito;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_credito AS\\r\\nSELECT\\r\\n    lc.cnpj_limpo,\\r\\n    COALESCE(cr.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    COALESCE(cr.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(cr.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cr.flag_saldo_alto_cancelada, 0) AS flag_saldo_alto_cancelada,\\r\\n    COALESCE(cr.flag_suspeita_valores_repetidos, 0) AS flag_suspeita_valores_repetidos,\\r\\n    COALESCE(cr.perc_valores_iguais_12m, 0) AS perc_valores_iguais_12m,\\r\\n    COALESCE(cr.variacao_saldo_perc_60m, 0) AS variacao_saldo_perc_60m\\r\\nFROM teste.cancel_luciano_cnpjs lc\\r\\nLEFT JOIN teste.luciano_credito cr ON lc.cnpj = cr.cnpj;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 8: DADOS DE RECOLHIMENTO\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano_recol;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano_recol AS\\r\\nSELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COALESCE(SUM(r.quantidade_pagtos), 0) AS quantidade_pagamentos,\\r\\n    COALESCE(SUM(r.valor_pagtos), 0) AS valor_pagamentos\\r\\nFROM teste.cancel_recolhimento r\\r\\nJOIN teste.cancel_luciano_cnpjs lc\\r\\n    ON REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '') = lc.cnpj_limpo\\r\\nGROUP BY REGEXP_REPLACE(TRIM(CAST(r.cnpj AS STRING)), '[^0-9]', '');\\r\\n\\r\\n-- =====================================================================\\r\\n-- PASSO 9: TABELA FINAL CONSOLIDADA - teste.cancel_luciano\\r\\n-- =====================================================================\\r\\nDROP TABLE IF EXISTS teste.cancel_luciano;\\r\\n\\r\\nCREATE TABLE teste.cancel_luciano AS\\r\\nSELECT \\r\\n    -- =========================================================\\r\\n    -- IDENTIFICA\\u00c7\\u00c3O\\r\\n    -- =========================================================\\r\\n    cf.cnpj,\\r\\n    cf.cnpj_limpo,\\r\\n    cf.ie,\\r\\n    cf.nome_contribuinte,\\r\\n    cf.razao_social,\\r\\n    cf.municipio,\\r\\n    cf.uf,\\r\\n    cf.gerencia_regional,\\r\\n    cf.cd_cnae,\\r\\n    cf.descricao_cnae,\\r\\n    cf.tipo_contribuinte,\\r\\n    cf.regime_apuracao,\\r\\n    cf.situacao_cadastral_atual,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS DO CANCELAMENTO\\r\\n    -- =========================================================\\r\\n    cf.protocolo,\\r\\n    cf.data_cancelamento,\\r\\n    cf.data_processamento,\\r\\n    cf.cod_motivo,\\r\\n    CASE cf.cod_motivo\\r\\n        WHEN 1 THEN 'INEXIST\\u00caNCIA OU INATIVIDADE DO ESTABELECIMENTO'\\r\\n        WHEN 2 THEN 'FALTA DE PEDIDO DE REATIVA\\u00c7\\u00c3O'\\r\\n        WHEN 3 THEN 'OMISS\\u00c3O DIME/GIA-ST/PGDAS-D OU ZERADAS/SEM MOVIMENTO 6 MESES'\\r\\n        WHEN 4 THEN 'DESCUMPRIMENTO LEGISLA\\u00c7\\u00c3O ATIVIDADE REGULAMENTADA'\\r\\n        WHEN 5 THEN 'FALTA APRESENTA\\u00c7\\u00c3O INFORMA\\u00c7\\u00d5ES ECON\\u00d4MICO-FISCAIS'\\r\\n        WHEN 6 THEN 'DECIS\\u00c3O JUDICIAL'\\r\\n        WHEN 7 THEN 'REGISTRO CNPJ/MUNIC\\u00cdPIO/JUNTA EXTINTO/CANCELADO/BAIXADO/INAPTO'\\r\\n        WHEN 8 THEN '(DESATIVADO) SUBSTITUTO SEM RECOLHER 90 DIAS'\\r\\n        WHEN 9 THEN '(DESATIVADO) D\\u00c9BITO D\\u00cdVIDA ATIVA > CAPITAL SOCIAL'\\r\\n        WHEN 10 THEN '(DESATIVADO) FALTA ATIVA\\u00c7\\u00c3O PRAZO REGULAMENTAR'\\r\\n        WHEN 11 THEN '(DESATIVADO) PERDA CONDI\\u00c7\\u00c3O CONTRIBUINTE'\\r\\n        WHEN 12 THEN 'PERDA DA CONDI\\u00c7\\u00c3O DE CONTRIBUINTE'\\r\\n        WHEN 13 THEN 'FALTA RECOLHIMENTO/GIA-ST 2 MESES NOS \\u00daLTIMOS 90 DIAS'\\r\\n        WHEN 14 THEN 'INSCRI\\u00c7\\u00c3O/ALTERA\\u00c7\\u00c3O MEDIANTE FRAUDE'\\r\\n        WHEN 15 THEN 'OPERA\\u00c7\\u00c3O COM PRODUTOS DE ORIGEM IL\\u00cdCITA'\\r\\n        WHEN 16 THEN 'DISPOSITIVO BOMBA COMBUST\\u00cdVEL - MENOS QUE INDICADO'\\r\\n        WHEN 17 THEN 'COMERCIALIZA\\u00c7\\u00c3O COMBUST\\u00cdVEL ADULTERADO'\\r\\n        WHEN 18 THEN 'FALTA REQUISITOS PARA INSCRI\\u00c7\\u00c3O ESTADUAL'\\r\\n        WHEN 19 THEN 'CONDENA\\u00c7\\u00c3O CRIME CONTRA ORDEM TRIBUT\\u00c1RIA'\\r\\n        WHEN 20 THEN 'D\\u00c9BITO D\\u00cdVIDA ATIVA > CAPITAL SOCIAL'\\r\\n        WHEN 21 THEN 'SUSPENS\\u00c3O DF-e N\\u00c3O RECLAMADA OU MANTIDA'\\r\\n        WHEN 22 THEN 'FALTA LISTA PRE\\u00c7OS PRODUTOS FUMO'\\r\\n        WHEN 23 THEN 'DESCUMPRIMENTO OBRIGA\\u00c7\\u00c3O ST ENTRADA'\\r\\n        WHEN 24 THEN 'N\\u00c3O EXERCE ATIVIDADE ICMS - CNAE INDEVIDO'\\r\\n        WHEN 25 THEN 'ALTERA\\u00c7\\u00c3O CADASTRAL INGRESSO PESSOA IRREGULAR'\\r\\n        ELSE CONCAT('MOTIVO ', COALESCE(CAST(cf.cod_motivo AS STRING), 'N/A'))\\r\\n    END AS descricao_motivo_cancelamento,\\r\\n    cf.parecer,\\r\\n    cf.tipo_evento,\\r\\n    cf.nome_fiscal,\\r\\n    cf.flag_cancelamento_automatico,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- SITUA\\u00c7\\u00c3O ATUAL\\r\\n    -- =========================================================\\r\\n    cf.flag_ainda_cancelada,\\r\\n    cf.flag_reativada,\\r\\n    cf.dias_desde_cancelamento,\\r\\n    cf.total_protocolos_empresa,\\r\\n    cf.classificacao_frequencia,\\r\\n    cf.classificacao_persistencia,\\r\\n    cf.efetividade_cancelamento,\\r\\n    cf.flag_empresa_reincidente,\\r\\n    cf.data_primeiro_cancelamento,\\r\\n    cf.data_ultimo_cancelamento,\\r\\n    cf.taxa_permanencia_cancelamento_perc,\\r\\n    cf.taxa_reativacao_perc,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS DE CR\\u00c9DITO\\r\\n    -- =========================================================\\r\\n    COALESCE(cr.saldo_credor_atual, 0) AS saldo_credor_atual,\\r\\n    COALESCE(cr.vl_credito_60m, 0) AS vl_credito_60m,\\r\\n    COALESCE(cr.vl_credito_presumido_60m, 0) AS vl_credito_presumido_60m,\\r\\n    COALESCE(cr.flag_saldo_alto_cancelada, 0) AS flag_saldo_alto_cancelada,\\r\\n    COALESCE(cr.flag_suspeita_valores_repetidos, 0) AS flag_suspeita_valores_repetidos,\\r\\n    COALESCE(cr.perc_valores_iguais_12m, 0) AS perc_valores_iguais_12m,\\r\\n    COALESCE(cr.variacao_saldo_perc_60m, 0) AS variacao_saldo_perc_60m,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- IND\\u00cdCIOS (CORRIGIDOS)\\r\\n    -- =========================================================\\r\\n    COALESCE(ind.qtde_indicios, 0) AS qtde_indicios,\\r\\n    COALESCE(ind.qtde_tipos_indicios, 0) AS qtde_tipos_indicios,\\r\\n    COALESCE(ind.soma_scores_indicios, 0) AS soma_scores_indicios,\\r\\n    COALESCE(ind.media_score_indicios, 0) AS media_score_indicios,\\r\\n    COALESCE(ind.max_score_indicio, 0) AS max_score_indicio,\\r\\n    COALESCE(ind.qtde_indicios_graves, 0) AS qtde_indicios_graves,\\r\\n    COALESCE(ind.qtde_indicios_criticos, 0) AS qtde_indicios_criticos,\\r\\n    COALESCE(ind.qtde_omissao_dime, 0) AS qtde_omissao_dime,\\r\\n    COALESCE(ind.qtde_omissao_pgdas, 0) AS qtde_omissao_pgdas,\\r\\n    COALESCE(ind.qtde_indicios_docs_fiscais, 0) AS qtde_indicios_docs_fiscais,\\r\\n    COALESCE(ind.qtde_indicios_relacionamentos, 0) AS qtde_indicios_relacionamentos,\\r\\n    ind.lista_cod_indicios,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS REGIME NORMAL (DIME)\\r\\n    -- =========================================================\\r\\n    dn.contador AS contador_normal,\\r\\n    COALESCE(dn.vl_faturamento_dime, 0) AS vl_faturamento_dime,\\r\\n    COALESCE(dn.vl_receita_bruta_dime, 0) AS vl_receita_bruta_dime,\\r\\n    COALESCE(dn.vl_credito_dime, 0) AS vl_credito_dime,\\r\\n    COALESCE(dn.vl_debito_dime, 0) AS vl_debito_dime,\\r\\n    COALESCE(dn.vl_deb_recolher_dime, 0) AS vl_deb_recolher_dime,\\r\\n    COALESCE(dn.periodos_omissos_dime, 0) AS periodos_omissos_dime,\\r\\n    COALESCE(dn.periodos_zerados_dime, 0) AS periodos_zerados_dime,\\r\\n    COALESCE(dn.periodos_sem_movimento_dime, 0) AS periodos_sem_movimento_dime,\\r\\n    COALESCE(dn.total_periodos_dime, 0) AS total_periodos_dime,\\r\\n    COALESCE(dn.periodos_declarados_dime, 0) AS periodos_declarados_dime,\\r\\n    COALESCE(dn.flag_omissao_dime, 0) AS flag_omissao_dime,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- DADOS SIMPLES NACIONAL (PGDAS)\\r\\n    -- =========================================================\\r\\n    ds.contador AS contador_simples,\\r\\n    COALESCE(ds.vl_receita_bruta_pgdas, 0) AS vl_receita_bruta_pgdas,\\r\\n    COALESCE(ds.vl_rec_bruta_12m_pgdas, 0) AS vl_rec_bruta_12m_pgdas,\\r\\n    COALESCE(ds.vl_icms_sc_pgdas, 0) AS vl_icms_sc_pgdas,\\r\\n    COALESCE(ds.periodos_omissos_pgdas, 0) AS periodos_omissos_pgdas,\\r\\n    COALESCE(ds.periodos_zerados_pgdas, 0) AS periodos_zerados_pgdas,\\r\\n    COALESCE(ds.total_periodos_pgdas, 0) AS total_periodos_pgdas,\\r\\n    COALESCE(ds.periodos_declarados_pgdas, 0) AS periodos_declarados_pgdas,\\r\\n    COALESCE(ds.flag_omissao_pgdas, 0) AS flag_omissao_pgdas,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- NF-e EMITIDAS (SA\\u00cdDAS)\\r\\n    -- =========================================================\\r\\n    COALESCE(nfe_e.qtde_nfe_emitidas, 0) AS qtde_nfe_emitidas,\\r\\n    COALESCE(nfe_e.vl_total_nfe_emitidas, 0) AS vl_total_nfe_emitidas,\\r\\n    COALESCE(nfe_e.vl_icms_nfe_emitidas, 0) AS vl_icms_nfe_emitidas,\\r\\n    nfe_e.primeira_nfe_emitida,\\r\\n    nfe_e.ultima_nfe_emitida,\\r\\n    COALESCE(nfe_e.qtde_destinatarios_distintos, 0) AS qtde_destinatarios_distintos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- NF-e RECEBIDAS (ENTRADAS)\\r\\n    -- =========================================================\\r\\n    COALESCE(nfe_r.qtde_nfe_recebidas, 0) AS qtde_nfe_recebidas,\\r\\n    COALESCE(nfe_r.vl_total_nfe_recebidas, 0) AS vl_total_nfe_recebidas,\\r\\n    COALESCE(nfe_r.vl_icms_nfe_recebidas, 0) AS vl_icms_nfe_recebidas,\\r\\n    nfe_r.primeira_nfe_recebida,\\r\\n    nfe_r.ultima_nfe_recebida,\\r\\n    COALESCE(nfe_r.qtde_fornecedores_distintos, 0) AS qtde_fornecedores_distintos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- RECOLHIMENTO\\r\\n    -- =========================================================\\r\\n    COALESCE(rec.quantidade_pagamentos, 0) AS quantidade_pagamentos,\\r\\n    COALESCE(rec.valor_pagamentos, 0) AS valor_pagamentos,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- CATEGORIZA\\u00c7\\u00c3O POR COMPORTAMENTO\\r\\n    -- =========================================================\\r\\n    CASE \\r\\n        WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 AND cf.flag_ainda_cancelada = 1 \\r\\n        THEN 'ALTO_RISCO_FINANCEIRO'\\r\\n        \\r\\n        WHEN (COALESCE(ind.qtde_indicios_graves, 0) > 0 OR COALESCE(ind.soma_scores_indicios, 0) > 200) \\r\\n             AND cf.flag_ainda_cancelada = 1\\r\\n        THEN 'FRAUDE_POTENCIAL'\\r\\n        \\r\\n        WHEN cf.total_protocolos_empresa >= 3 AND cf.flag_ainda_cancelada = 1\\r\\n        THEN 'REINCIDENTE_CRONICO'\\r\\n        \\r\\n        WHEN (COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 OR COALESCE(cr.perc_valores_iguais_12m, 0) > 50) \\r\\n             AND COALESCE(cr.saldo_credor_atual, 0) > 10000\\r\\n        THEN 'CREDITO_SUSPEITO'\\r\\n        \\r\\n        WHEN cf.flag_ainda_cancelada = 1 AND COALESCE(cr.saldo_credor_atual, 0) = 0 \\r\\n             AND COALESCE(ind.qtde_indicios, 0) = 0\\r\\n        THEN 'CANCELAMENTO_EFETIVO'\\r\\n        \\r\\n        WHEN cf.flag_reativada = 1 AND COALESCE(cr.saldo_credor_atual, 0) < 10000 \\r\\n             AND COALESCE(ind.qtde_indicios, 0) = 0\\r\\n        THEN 'REATIVADA_SEM_RISCO'\\r\\n        \\r\\n        WHEN cf.flag_reativada = 1 AND (COALESCE(cr.saldo_credor_atual, 0) > 50000 \\r\\n             OR COALESCE(ind.qtde_indicios, 0) > 0)\\r\\n        THEN 'REATIVADA_COM_RISCO'\\r\\n        \\r\\n        ELSE 'OUTROS'\\r\\n    END AS categoria_comportamento,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- SCORE DE PRIORIDADE PARA A\\u00c7\\u00c3O\\r\\n    -- =========================================================\\r\\n    (\\r\\n        -- Score por saldo credor\\r\\n        CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n             WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por ind\\u00edcios\\r\\n        CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n             WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n             WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n             WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por reincid\\u00eancia\\r\\n        CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n             WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n             WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por valores suspeitos\\r\\n        CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n        +\\r\\n        -- Score por omiss\\u00f5es\\r\\n        CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n               OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n             WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n               OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por declara\\u00e7\\u00f5es zeradas\\r\\n        CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n               OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n             ELSE 0 END\\r\\n        +\\r\\n        -- Score por NF-e sem declara\\u00e7\\u00e3o correspondente\\r\\n        CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n              AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n              AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n             ELSE 0 END\\r\\n    ) AS score_prioridade_acao,\\r\\n    \\r\\n    -- =========================================================\\r\\n    -- CLASSIFICA\\u00c7\\u00c3O DE RISCO FINAL\\r\\n    -- =========================================================\\r\\n    CASE \\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 50 THEN 'ALTO'\\r\\n        WHEN (\\r\\n            CASE WHEN COALESCE(cr.saldo_credor_atual, 0) > 1000000 THEN 40\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 500000 THEN 30\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 100000 THEN 20\\r\\n                 WHEN COALESCE(cr.saldo_credor_atual, 0) > 50000 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(ind.qtde_indicios_criticos, 0) >= 2 THEN 35\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 3 THEN 30\\r\\n                 WHEN COALESCE(ind.qtde_indicios_graves, 0) >= 1 THEN 20\\r\\n                 WHEN COALESCE(ind.qtde_indicios, 0) > 0 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN cf.total_protocolos_empresa >= 5 THEN 20\\r\\n                 WHEN cf.total_protocolos_empresa >= 3 THEN 15\\r\\n                 WHEN cf.total_protocolos_empresa >= 2 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(cr.flag_suspeita_valores_repetidos, 0) = 1 THEN 10 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 6 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 6 THEN 15\\r\\n                 WHEN COALESCE(dn.periodos_omissos_dime, 0) >= 3 \\r\\n                   OR COALESCE(ds.periodos_omissos_pgdas, 0) >= 3 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(dn.periodos_zerados_dime, 0) >= 12 \\r\\n                   OR COALESCE(ds.periodos_zerados_pgdas, 0) >= 12 THEN 10\\r\\n                 ELSE 0 END\\r\\n            +\\r\\n            CASE WHEN COALESCE(nfe_e.qtde_nfe_emitidas, 0) > 0 \\r\\n                  AND COALESCE(dn.vl_faturamento_dime, 0) = 0 \\r\\n                  AND COALESCE(ds.vl_receita_bruta_pgdas, 0) = 0 THEN 25\\r\\n                 ELSE 0 END\\r\\n        ) >= 30 THEN 'M\\u00c9DIO'\\r\\n        ELSE 'BAIXO'\\r\\n    END AS classificacao_risco_final\\r\\n\\r\\nFROM teste.cancel_luciano_cnpjs cf\\r\\nLEFT JOIN teste.cancel_luciano_credito cr ON cf.cnpj_limpo = cr.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_indicios ind ON cf.cnpj_limpo = ind.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_normal dn ON cf.cnpj_limpo = dn.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_simples ds ON cf.cnpj_limpo = ds.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_nfe_emit nfe_e ON cf.cnpj_limpo = nfe_e.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_nfe_rec nfe_r ON cf.cnpj_limpo = nfe_r.cnpj_limpo\\r\\nLEFT JOIN teste.cancel_luciano_recol rec ON cf.cnpj_limpo = rec.cnpj_limpo;\\r\\n\\r\\n\\r\\n-- =====================================================================\\r\\n-- VERIFICA\\u00c7\\u00d5ES FINAIS\\r\\n-- =====================================================================\\r\\n\\r\\nSELECT '========== RESUMO FINAL ==========' AS info;\\r\\n\\r\\nSELECT 'Total registros' AS metrica, COUNT(*) AS valor FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Empresas distintas', COUNT(DISTINCT cnpj) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com NF-e emitidas', COUNT(CASE WHEN qtde_nfe_emitidas > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com NF-e recebidas', COUNT(CASE WHEN qtde_nfe_recebidas > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com ind\\u00edcios', COUNT(CASE WHEN qtde_indicios > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com ind\\u00edcios graves', COUNT(CASE WHEN qtde_indicios_graves > 0 THEN 1 END) FROM teste.cancel_luciano\\r\\nUNION ALL\\r\\nSELECT 'Com omiss\\u00f5es', COUNT(CASE WHEN periodos_omissos_dime > 0 OR periodos_omissos_pgdas > 0 THEN 1 END) FROM teste.cancel_luciano;\\r\\n\\r\\nSELECT '========== DISTRIBUI\\u00c7\\u00c3O POR RISCO ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    classificacao_risco_final,\\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.cancel_luciano\\r\\nGROUP BY classificacao_risco_final\\r\\nORDER BY \\r\\n    CASE classificacao_risco_final \\r\\n        WHEN 'CR\\u00cdTICO' THEN 1 \\r\\n        WHEN 'ALTO' THEN 2 \\r\\n        WHEN 'M\\u00c9DIO' THEN 3 \\r\\n        ELSE 4 \\r\\n    END;\\r\\n\\r\\nSELECT '========== DISTRIBUI\\u00c7\\u00c3O POR CATEGORIA ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    categoria_comportamento,\\r\\n    COUNT(*) AS qtde,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual\\r\\nFROM teste.cancel_luciano\\r\\nGROUP BY categoria_comportamento\\r\\nORDER BY qtde DESC;\\r\\n\\r\\nSELECT '========== TOP 10 POR SCORE ==========' AS info;\\r\\n\\r\\nSELECT \\r\\n    cnpj,\\r\\n    nome_contribuinte,\\r\\n    municipio,\\r\\n    data_cancelamento,\\r\\n    descricao_motivo_cancelamento,\\r\\n    categoria_comportamento,\\r\\n    classificacao_risco_final,\\r\\n    score_prioridade_acao,\\r\\n    saldo_credor_atual,\\r\\n    qtde_indicios,\\r\\n    qtde_indicios_graves,\\r\\n    qtde_nfe_emitidas,\\r\\n    vl_total_nfe_emitidas\\r\\nFROM teste.cancel_luciano\\r\\nORDER BY score_prioridade_acao DESC\\r\\nLIMIT 10;\\r\\n\\r\\nSELECT '========== TABELAS AUXILIARES CRIADAS ==========' AS info;\\r\\n\\r\\nSELECT 'cancel_luciano_cnpjs' AS tabela, COUNT(*) AS registros FROM teste.cancel_luciano_cnpjs\\r\\nUNION ALL SELECT 'cancel_luciano_nfe_emit', COUNT(*) FROM teste.cancel_luciano_nfe_emit\\r\\nUNION ALL SELECT 'cancel_luciano_nfe_rec', COUNT(*) FROM teste.cancel_luciano_nfe_rec\\r\\nUNION ALL SELECT 'cancel_luciano_indicios', COUNT(*) FROM teste.cancel_luciano_indicios\\r\\nUNION ALL SELECT 'cancel_luciano_normal', COUNT(*) FROM teste.cancel_luciano_normal\\r\\nUNION ALL SELECT 'cancel_luciano_simples', COUNT(*) FROM teste.cancel_luciano_simples\\r\\nUNION ALL SELECT 'cancel_luciano_credito', COUNT(*) FROM teste.cancel_luciano_credito\\r\\nUNION ALL SELECT 'cancel_luciano_recol', COUNT(*) FROM teste.cancel_luciano_recol\\r\\nUNION ALL SELECT 'cancel_luciano (FINAL)', COUNT(*) FROM teste.cancel_luciano;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 661, \"column\": 78}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query cd44457204103278:805fcf7f00000000 100% Complete (0 out of 0)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"cd44457204103278:805fcf7f00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=cd44457204103278:805fcf7f00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query cd44457204103278:805fcf7f00000000 100% Complete (0 out of 0)\", \"progress\": 100, \"jobs\": [{\"name\": \"cd44457204103278:805fcf7f00000000\", \"url\": \"/hue/jobbrowser#!id=cd44457204103278:805fcf7f00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 25900, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 204, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- =====================================================================\r\n-- PROJETO LUCIANO - CRIAO DA TABELA cancel_luciano\r\n-- =====================================================================\r\n-- VERSO IMPALA OTIMIZADA\r\n-- Execute este script no Impala ANTES de rodar o Python\r\n-- =====================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- =====================================================================\r\n-- PASSO 1: CRIAR TABELA COM CNPJs DO FISCAL\r\n-- =====================================================================\r\nDROP TABLE IF EXISTS teste.cancel_luciano_cnpjs;\r\n\r\nCREATE TABLE teste.cancel_luciano_cnpjs AS\r\nSELECT DISTINCT\r\n    b.cnpj,\r\n    REGEXP_REPLACE(TRIM(CAST(b.cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\r\n    b.ie,\r\n    b.nome_contribuinte,\r\n    b.razao_social,\r\n    b.municipio,\r\n    b.uf,\r\n    b.gerencia_regional,\r\n    b.cd_cnae,\r\n    b.descricao_cnae,\r\n    b.tipo_contribuinte,\r\n    b.regime_apuracao,\r\n    b.situacao_cadastral_atual,\r\n    b.protocolo,\r\n    b.data_inicio_protocolo AS data_cancelamento,\r\n    b.data_processamento,\r\n    b.cod_motivo,\r\n    b.parecer,\r\n    b.tipo_evento,\r\n    b.nome_fiscal,\r\n    b.flag_cancelamento_automatico,\r\n    b.flag_ainda_cancelada,\r\n    b.flag_reativada,\r\n    b.dias_desde_cancelamento,\r\n    m.total_protocolos AS total_protocolos_empresa,\r\n    m.taxa_permanencia_cancelamento_perc,\r\n    m.taxa_reativacao_perc,\r\n    m.flag_empresa_reincidente,\r\n    m.flag_atualmente_cancelada,\r\n    m.classificacao_frequencia,\r\n    m.classificacao_persistencia,\r\n    m.efetividade_cancelamento,\r\n    m.data_primeiro_cancelamento,\r\n    m.data_ultimo_cancelamento\r\nFROM teste.luciano_base b\r\nLEFT JOIN teste.luciano_metricas m ON b.cnpj = m.cnpj\r\nWHERE (b.nome_fiscal LIKE '%LUCIANO%TREVISAN%'\r\n   OR b.nome_fiscal LIKE '%LUCIANO%FREITAS%'\r\n   OR UPPER(b.nome_fiscal) LIKE '%LUCIANO TREVISAN FREITAS%')\r\n  AND YEAR(b.data_inicio_protocolo) = 2025;\r\n\r\n-- ============================",
    "last_modified": "2025-12-01T16:42:19.746",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "638b4b71-396e-44c4-bbc5-e56afe09dddd",
      1,
      false
    ],
    "dependencies": []
  }
}
]
